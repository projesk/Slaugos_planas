<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paciento vertinimas ir slaugos planas</title>
<style>
  :root{
    --bg:#f7f8fb;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;
    --ok:#16a34a;--warn:#f59e0b;--bad:#dc2626
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:auto;padding:20px;background:var(--bg);color:#111}
  h1{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
  .section{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px}
  .section h2{font-size:18px;margin:0 0 10px;padding-bottom:8px;border-bottom:1px dashed var(--line)}
  label{display:block;margin-top:8px;font-weight:600}
  .hint{font-weight:400;color:var(--muted);font-size:12px}
  select,input,textarea{padding:10px;border:1px solid var(--line);border-radius:8px;width:100%;margin-top:6px;background:#fff}
  textarea{min-height:84px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  button{padding:10px 14px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  button.secondary{background:#fff;color:#111;border:1px solid var(--line)}
  button.good{background:var(--ok)}
  button.warn{background:var(--warn);color:#111}
  .results{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-top:18px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin:3px 6px 0 0;background:#fff}
  .pill.ok{border-color:#16a34a33;background:#16a34a18}
  .pill.warn{border-color:#f59e0b33;background:#f59e0b18}
  .pill.bad{border-color:#dc262633;background:#dc262618}
  .planas{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px;background:#fff}
  .planas h4{margin:0 0 8px}
  .kudos{padding:10px;border:1px dashed var(--line);border-radius:10px;background:#fafafa;font-size:13px;color:var(--muted);margin-top:10px}
  .status{padding:10px;border-radius:10px;margin-top:10px;display:none}
  .status.ok{display:block;background:#ecfdf5;border:1px solid #86efac;color:#065f46}
  .status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:12px;margin-top:12px;overflow:auto}
  details{margin-top:8px}
  summary{cursor:pointer;color:#111}
  .checkboxes{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}
  .checkboxes label{display:flex;align-items:center;font-weight:500}
  .checkboxes input{width:auto;margin-right:8px}
</style>
</head>
<body>
<h1>Paciento vertinimas ir slaugos planas</h1>

<form id="nursingForm" novalidate>
  <div class="grid">

    <!-- IDENTIFIKACIJA -->
    <div class="section">
      <h2>Identifikacija</h2>
      <label for="palata">Palata
        <input id="palata" name="palata" autocomplete="off" />
      </label>
      <label for="lova">Lova
        <input id="lova" name="lova" autocomplete="off" />
      </label>
      <div class="checkboxes" style="margin-top:6px">
        <label><input type="checkbox" id="ramus"> ramus</label>
        <label><input type="checkbox" id="orientuotas"> orientuotas</label>
        <label title="Fizinio suvaržymo pažyma įrašui"><input type="checkbox" id="suvarzymas"> suvaržymas</label>
      </div>
    </div>

    <!-- KVĖPAVIMO SISTEMA -->
    <div class="section">
      <h2>Kvėpavimo sistema</h2>
      <label for="trach">Tracheostominis vamzdis
        <select id="trach" name="trach">
          <option value="ne">Nėra</option><option value="taip">Yra</option>
        </select>
      </label>

      <div class="row">
        <label for="sekretas_trach">Sekretas / atkosėjimas iš vamzdžio
          <select id="sekretas_trach" name="sekretas_trach">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="siurbimas">Atliekamas siurbimas
          <select id="siurbimas" name="siurbimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="nosis">Nosis
          <select id="nosis" name="nosis">
            <option value="nedaryta">Niekas nedaryta</option>
            <option value="tamponuota">Tamponuota nosis</option>
            <option value="istraukti">Ištraukti tamponai</option>
          </select>
        </label>
        <label for="dusulys">Ar jaučiate dusulį?
          <select id="dusulys" name="dusulys">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="saturacija">Saturacija SpO₂ (%) <span class="hint">(50–100)</span>
          <input type="number" id="saturacija" name="saturacija" min="50" max="100" inputmode="decimal" />
        </label>
        <label for="kosulys">Kosulys
          <select id="kosulys" name="kosulys">
            <option value="nera">Nėra</option><option value="sausas">Sausas</option><option value="dregnas">Drėgnas</option>
          </select>
        </label>
      </div>
    </div>

    <!-- ŠIRDIES IR KRAUJOTAKA -->
    <div class="section">
      <h2>Širdies ir kraujotaka</h2>
      <div class="row">
        <label for="sistolinis">AKS (sistolinis) mmHg <span class="hint">(50–250)</span>
          <input type="number" id="sistolinis" name="sistolinis" min="50" max="250" />
        </label>
        <label for="diastolinis">AKS (diastolinis) mmHg <span class="hint">(20–150)</span>
          <input type="number" id="diastolinis" name="diastolinis" min="20" max="150" />
        </label>
      </div>
      <div class="row">
        <label for="pulsas">Pulsas (bpm) <span class="hint">(30–200)</span>
          <input type="number" id="pulsas" name="pulsas" min="30" max="200" />
        </label>
        <label for="temperatura">Kūno temperatūra (°C) <span class="hint">(30.0–42.0)</span>
          <input type="number" id="temperatura" name="temperatura" step="0.1" min="30" max="42" />
        </label>
      </div>
    </div>

    <!-- MITYBA -->
    <div class="section">
      <h2>Mityba</h2>
      <div class="row">
        <label for="mityba">Mitybos būdas
          <select id="mityba" name="mityba">
            <option value="">—</option>
            <option value="burna">Per burną</option>
            <option value="zondas">Per zondą (NG)</option>
            <option value="peg">Per PEG</option>
          </select>
        </label>
        <label for="rijimas">Rijimo sutrikimai?
          <select id="rijimas" name="rijimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <label for="suvalgo">Ar suvalgo visą maistą?
        <select id="suvalgo" name="suvalgo">
          <option value="taip">Taip</option>
          <option value="dalis">Dalis</option>
          <option value="ne">Ne</option>
        </select>
      </label>

      <div class="row">
        <label for="dieta">Dieta (pasirinkimas)
          <select id="dieta" name="dieta">
            <option value="">—</option>
            <option value="P1">P1</option>
            <option value="PTM">PTM</option>
            <option value="TM">TM</option>
            <option value="SM">SM</option>
            <option value="CD">CD</option>
            <option value="PTM-CD">PTM-CD</option>
            <option value="NPB">NPB</option>
            <option value="P4">P4</option>
            <option value="Na">Na</option>
            <option value="B">B</option>
            <option value="Lac">Lac</option>
            <option value="Sk">Sk</option>
            <option value="Kita">Kita…</option>
          </select>
        </label>
        <label for="dieta_kita">Jei „Kita“ – įrašykite
          <input id="dieta_kita" name="dieta_kita" placeholder="pvz., be glitimo, be fenilalanino..." />
        </label>
      </div>
    </div>

    <!-- ŠALINIMAS -->
    <div class="section">
      <h2>Šalinimas</h2>
      <div class="row">
        <label for="kateteris">Šlapimo kateteris
          <select id="kateteris" name="kateteris">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="viduriai">Vidurių užkietėjimas?
          <select id="viduriai" name="viduriai">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>
      <label for="viduriavimas">Viduriavimas?
        <select id="viduriavimas" name="viduriavimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- JUDĖJIMAS -->
    <div class="section">
      <h2>Judėjimas</h2>
      <label for="mobilumas">Mobilumas
        <select id="mobilumas" name="mobilumas">
          <option value="sav">Savarankiškas</option>
          <option value="pagalba">Su pagalba</option>
          <option value="lova">Lovos režimas</option>
        </select>
      </label>

      <label for="galvos_svaigimas">Galvos svaigimas?
        <select id="galvos_svaigimas" name="galvos_svaigimas">
          <option value="ne">Ne</option>
          <option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- MIEGAS -->
    <div class="section">
      <h2>Miegas</h2>
      <label for="miegas">Miego kokybė
        <select id="miegas" name="miegas">
          <option value="gera">Gera</option>
          <option value="sutrikusi">Sutrikusi</option>
        </select>
      </label>
    </div>

    <!-- ODA -->
    <div class="section">
      <h2>Oda</h2>
      <div class="row">
        <label for="pragulos">Pragulos
          <select id="pragulos" name="pragulos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="zaizdos">Žaizdos
          <select id="zaizdos" name="zaizdos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
      </div>
      <div id="zaizdos_aprasymas" style="display:none;">
        <label for="zaizdos_text">Žaizdos aprašymas
          <textarea id="zaizdos_text" name="zaizdos_text" placeholder="Lokalizacija, dydis, sekrecija, paraudimas, skausmingumas..."></textarea>
        </label>
      </div>
    </div>

    <!-- SKAUSMAS -->
    <div class="section">
      <h2>Skausmas</h2>
      <div class="row">
        <label for="skausmas">Ar yra skausmas?
          <select id="skausmas" name="skausmas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="skausmoLygis">Intensyvumas (0–10)
          <input type="number" id="skausmoLygis" name="skausmoLygis" min="0" max="10" />
        </label>
      </div>
      <div class="hint">Jei „Yra skausmas“, įveskite skaičių 0–10 (NRS).</div>
    </div>

    <!-- KRAUJAVIMAS -->
    <div class="section">
      <h2>Kraujavimas</h2>
      <label for="kraujavimo_rizika">Kraujavimo rizika
        <select id="kraujavimo_rizika" name="kraujavimo_rizika">
          <option value="nera">Nėra</option>
          <option value="yra">Yra</option>
        </select>
      </label>
      <div class="hint">Jei „Yra“, į „Galimos problemos“ atsiras „Kraujavimo rizika“, plane – „Stebėjimas dėl galimo kraujavimo“ ir „AKS sekimas“.</div>
    </div>

    <!-- PIRMINIS VERTINIMAS -->
    <div class="section">
      <h2>Pirminis vertinimas</h2>
      <details>
        <summary>(išskleisti/lyni)</summary>
        <div class="row" style="margin-top:8px">
          <label for="alergijos">Alergijos
            <textarea id="alergijos" placeholder="pvz., penicilinai, lateksas, maistas..."></textarea>
          </label>
          <label for="gretutines">Gretutinės ligos
            <textarea id="gretutines" placeholder="pvz., AH, IŠL, CD, ŠN, LOPL, CA ir kt."></textarea>
          </label>
        </div>
        <div class="row">
          <label for="vaistai">Vartojami vaistai
            <textarea id="vaistai" placeholder="Reguliarūs, PRN, antikoaguliantai ir kt."></textarea>
          </label>
          <label for="infekcijos">Infekcinės ligos
            <textarea id="infekcijos" placeholder="pvz., MRSA, C. difficile, TB, hepatitai..."></textarea>
          </label>
        </div>
      </details>
    </div>

  </div>

  <div class="actions">
    <button type="button" id="genBtn">Generuoti</button>
    <button type="button" class="secondary" id="resetBtn">Naujas pacientas</button>
    <button type="button" class="good" id="uploadBtn">Kelti į sistemą</button>
  </div>
</form>

<div id="results" class="results" aria-live="polite"></div>

<div id="statusOk" class="status ok">✅ Duomenys įkelti sėkmingai.</div>
<div id="statusErr" class="status err">❌ Klaida siunčiant į Google Sheets. Patikrinkite WebApp adresą ir leidimus.</div>

<script>
/* ======= KONFIGŪRA ======= */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxODAbmdrmccCYCUkswsFgnz-nrC8clEQQf-5kId3y-3TCqUwsU4pyCze2Jojv43VV_1A/exec"; // pvz.: https://script.google.com/macros/s/AKfycb.../exec

/* ======= PAGALBINĖS ======= */
const $ = (id) => document.getElementById(id);
function toNum(v){const n=parseFloat(v);return isFinite(n)?n:null;}
function calcMAP(sys, dia){ if(sys==null || dia==null) return null; return Math.round(((2*dia)+sys)/3); }
function valOrDash(v){ return (v==null || v==="")? "-" : v; }
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function nowIsoLocal(){ return new Date().toISOString(); }
function capitalizeFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

/* ======= PLANAI ======= */
const slaugosPlanas = {
  "Kvėpavimo takai su tracheostominiu vamzdžiu": [
    "Savalaikis atsiurbimas iš tracheostominio vamzdelio",
    "Vamzdelio drėkinimas"
  ],
  "Nedidelis kraujavimas iš nosies": [
    "AKS stebėjimas kraujavimui nestojant",
    "Pacientas apmokintas kaip prižiūrėti nosį kraujavimui sustojus"
  ],
  "Sutrikusi kvėpavimo funkcija (dusulys)": [
    "SpO₂ stebėjimas",
    "Prireikus O₂ skyrimas pagal SpO₂"
  ],
  "Neefektyvi dujų apykaita": [
    "SpO₂ stebėjimas",
    "O₂ skyrimas ir reguliavimas pagal SpO₂ duomenis"
  ],
  "Pažemėjęs kraujo spaudimas": [
    "Patarta neskubėti keltis, pasėdėti nuleidus kojas prieš einant",
    "Stebėjimas dėl galimų griuvimų"
  ],
  "Padidėjęs kraujo spaudimas": [
    "AKS sekimas kas 4 val."
  ],

  /* — Mityba ir rijimas — */
  "Rijimo sutrikimas / aspiracijos rizika": [
    "Stebėjimas dėl aspiracijos",
    "Pagalba valgant",
    "Maisto tirštinimas prireikus pagal gydytojo paskyrimą"
  ],
  "Sumažėjęs suvartojamo maisto kiekis": [
    "Įvertinti ir dokumentuoti valgymo metu suvartotą maisto kiekį",
    "Pasiūlyti užkandžius tarp valgymų; pagal paskyrimą — papildai / gėrimai su kalorijomis",
    "Įvertinti pykinimą/skausmą prieš valgį; taikyti priemones pagal paskyrimą (antiemetikai, nuskausminimas)",
    "Prieš valgį patogi padėtis; pagalba maitinantis",
    "Informuoti gydytoją, jei suvalgo <50–75 % kelių valgymų metu iš eilės",
    "Stebėti skysčių balansą ir (jei taikoma) kūno masę periodiškai"
  ],
  "Mityba per zondą (NG)": [
    "Zondo padėties patikra pagal įstaigos protokolą",
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po",
    "Zondo praplovimas prieš ir po maitinimo bei vaistų",
    "Nosies ir odos prie zondo priežiūra, fiksacijos patikra",
    "Stebėti dėl aspiracijos, pykinimo, pilvo pūtimo"
  ],
  "Mityba per PEG": [
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po",
    "Punkcijos vietos priežiūra, infekcijos požymių stebėjimas",
    "Zondo praplovimas prieš ir po maitinimo bei vaistų"
  ],

  /* — Judėjimas / griuvimai — */
  "Judėjimas su pagalba": [
    "Nustatomas individualus pagalbos lygis (1–2 asmenys, vaikštynė/ramentai).",
    "Kėlimasis lėtai – ortostatinės hipotenzijos profilaktika.",
    "Saugi aplinka: lova nuleista, stabdžiai užfiksuoti, skambutis pasiekiamas.",
    "Patarta dėvėti neslystančias kojines / tinkamą avalynę.",
    "Pirmo atsistojimo/persikėlimo metu – slaugytojo priežiūra."
  ],
  "Rizika griuvimui dėl pagalbos poreikio": [
    "Griuvimų rizikos įvertinimas; žymėjimas",
    "Aplinka be kliūčių, naktinis apšvietimas",
    "Skambutis pasiekiamas; pacientas instruktuojamas kviesti pagalbą",
    "WC palyda, pagalbinės priemonės",
    "Lovos/vežimėlio stabdžiai užfiksuoti prieš persodinant",
    "Reguliari stebėsena ir dokumentavimas"
  ],
  "Rizika griuvimui dėl galvos svaigimo": [
    "Griuvimų rizikos įvertinimas; žymėjimas",
    "Aplinka be kliūčių, naktinis apšvietimas",
    "Skambutis pasiekiamas; pacientas instruktuojamas kviesti pagalbą",
    "WC palyda, pagalbinės priemonės",
    "Lovos/vežimėlio stabdžiai užfiksuoti prieš persodinant",
    "Reguliari stebėsena ir dokumentavimas",
    "AKS sekimas"
  ],
  "Rizika praguloms dėl lovos režimo": [
    "Padėties keitimas kas 3 val.",
    "Pakišamų indų/sauskelnių naudojimas",
    "Pagalbinių priemonių naudojimas",
    "Odos vientisumo stebėjimas"
  ],
  "Pragulos": [
    "Kūno padėties keitimas kas 3 val.",
    "Pagalbinės priemonės",
    "Pragulos perrišimas pagal žaizdų priežiūros planą"
  ],
  "Odos vientisumo pažeidimas (žaizda)": [
    "Žaizdos perrišimas",
    "Stebėti infekcijos požymius"
  ],

  /* — Šlapimo kateteris — */
  "Šlapimo kateteris": [
    "Palaikomas uždaras drenavimo sistemos vientisumas.",
    "Šlapimo maišas visada žemiau šlapimo pūslės lygio; pakabintas prie paciento lovos.",
    "Diurezės apskaita (ml/val., ml/24 h) ir šlapimo pobūdžio vertinimas.",
    "Infekcijos profilaktika: stebėti T°, infekcijos požymius, pokyčius šlapimo spalvoje, drumzlėtume",
    "Paciento mokymas: tinkamas maišo ištuštinimas ir sistemos apsauga nuo tempimo."
  ],

  /* — Skausmas — */
  "Skausmas": [
    "Skubus nuskausminimas pagal gydytojo paskyrimą",
    "Pakartotinis skausmo matavimas po 15 min."
  ],

  /* — T, HR — */
  "Padidėjusi temperatūra": ["Temperatūros stebėjimas"],
  "Hipotermija": ["Šilumos palaikymas","Temperatūros stebėjimas"],
  "Tachikardija": [
    "Gyvybinių funkcijų stebėjimas (AKS, SpO₂, T°)",
    "Skysčių balanso ir kraujavimo požymių vertinimas",
    "Skausmo/karščiavimo kontrolė; medikamentų peržiūra pagal paskyrimą"
  ],
  "Bradikardija": [
    "Gyvybinių funkcijų stebėjimas (AKS, SpO₂, T°)",
    "Sąmonės, perfuzijos požymių vertinimas",
    "Medikamentų peržiūra pagal paskyrimą"
  ],

  /* — Kraujavimo rizika — */
  "Kraujavimo rizika": [
    "Stebėjimas dėl galimo kraujavimo",
    "AKS sekimas"
  ]
};

/* — Dietų planinių sakinių žemėlapis (į slaugos planą) — */
const dietPlan = {
  "PTM": "Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos.",
  "TM": "Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos.",
  "SM": "Pacientas maitinamas mažais boliusais, lėtai; stebima dėl aspiracijos rizikos.",
  "CD": "Glikemijos sekimas.",
  "PTM-CD": "Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos; sekama glikemija.",
  "Na": "Stebima dėl edemų; pastebėjus — AKS ir skysčių sekimas.",
  "NPB": "Pacientas nieko nevalgo ir negeria, kol kitaip nenurodė gydytojas."
  // P1, P4, B, Lac, Sk — plano nerašom
};

/* ======= UI INIT ======= */
$("zaizdos").addEventListener("change", (e)=>{
  $("zaizdos_aprasymas").style.display = e.target.value === "yra" ? "block" : "none";
});
$("skausmas").addEventListener("change", (e)=>{
  const need = e.target.value === "taip";
  $("skausmoLygis").toggleAttribute("required", need);
});
$("genBtn").addEventListener("click", generateResults);
$("resetBtn").addEventListener("click", resetForm);
$("uploadBtn").addEventListener("click", keltiISistema);

let lastPayload = null;

/* ======= BRANDUOLYS ======= */
function vitalsText(spo2, sys, dia, map, hr, temp){
  const aks = (sys!=null && dia!=null) ? `${sys}/${dia} mmHg${map!=null?` (MAP ${map})`:''}` : '-';
  const T = (temp!=null) ? `${Number(temp).toFixed(1)} °C` : '-';
  return [
    `SpO₂: ${spo2!=null? spo2+' %' : '-'}`,
    `AKS: ${aks}`,
    `ŠSD: ${hr!=null? hr+'/min' : '-'}`,
    `Temperatūra: ${T}`
  ].join('\n');
}

function buildPlanText(allProblems){
  const blocks = [];
  // išvengti dublikatų
  const uniq = Array.from(new Set(allProblems));
  uniq.forEach(p => {
    // specialus „Skausmas X/10“ apdorojimas
    if (p.startsWith("Skausmas ")) {
      const items = slaugosPlanas["Skausmas"].map(i=>`• ${i}`).join('\n');
      blocks.push(`${p}\n${items}`);
      return;
    }
    const key = Object.keys(slaugosPlanas).find(k => p === k || p.startsWith(k));
    if (key) {
      const items = slaugosPlanas[key].map(i => `• ${i}`).join('\n');
      blocks.push(`${p}\n${items}`);
    }
  });
  return blocks.join('\n\n') || '-';
}

function makeSingleCellRecord(f, esamos, galimos, spo2, sys, dia, map, hr, temp, psychText, dietSentence, pvText){
  const esamosText  = esamos.length ? esamos.join('; ') : '-';
  const galimosText = galimos.length ? galimos.join('; ') : '-';
  const planText = buildPlanText([...esamos, ...galimos]);

  let introParts = [`Gyvybiniai rodikliai:\n${vitalsText(spo2, sys, dia, map, hr, temp)}`];
  if (psychText) introParts.push(psychText);
  if (dietSentence) introParts.push(dietSentence);
  if (pvText) introParts.push(`Pirminis vertinimas: ${pvText}`);

  const irasas =
    `${introParts.join('\n')}\n\n` +
    `Slaugos problemos:\n${esamosText}\n\n` +
    `Galimos problemos:\n${galimosText}\n\n` +
    `Slaugos planas:\n${planText}`;

  return {
    "Laikas": new Date().toISOString(),
    "palata": f["palata"].value.trim(),
    "lova": f["lova"].value.trim(),
    "įrašas": irasas
  };
}

function detectProblems(f){
  const esamos = [];
  const galimos = [];
  const pills = [];

  const spo2 = toNum(f["saturacija"].value);
  const temp = toNum(f["temperatura"].value);
  const sys = toNum(f["sistolinis"].value);
  const dia = toNum(f["diastolinis"].value);
  const hr  = toNum(f["pulsas"].value);
  const map = calcMAP(sys, dia);

  // SpO2
  if(spo2!=null){
    if(spo2 < 90) { esamos.push("Neefektyvi dujų apykaita"); pills.push(pill(`SpO₂ ${spo2}% (kritiškai žema)`,"bad")); }
    else if(spo2 < 94) { esamos.push("Neefektyvi dujų apykaita"); pills.push(pill(`SpO₂ ${spo2}% (žema)`,"warn")); }
    else pills.push(pill(`SpO₂ ${spo2}%`,"ok"));
  }

  // Temperatūra
  if(temp!=null){
    if(temp >= 38.0) { esamos.push("Padidėjusi temperatūra"); pills.push(pill(`T ${temp.toFixed(1)}°C (karščiavimas)`,"warn")); }
    else if(temp >= 37.1) { esamos.push("Padidėjusi temperatūra"); pills.push(pill(`T ${temp.toFixed(1)}°C (subfebrilus)`,"warn")); }
    else if(temp < 36.0) { esamos.push("Hipotermija"); pills.push(pill(`T ${temp.toFixed(1)}°C (žema)`,"warn")); }
    else pills.push(pill(`T ${temp.toFixed(1)}°C`,"ok"));
  }

  // AKS / MAP
  if(sys!=null && dia!=null){
    if(sys < 100 || (map!=null && map < 65)) { esamos.push("Pažemėjęs kraujo spaudimas"); }
    if(sys >= 140 || dia >= 90) { esamos.push("Padidėjęs kraujo spaudimas"); }
    pills.push(pill(`AKS ${sys}/${dia} mmHg${map!=null?` (MAP ${map})`:''}`, (sys>=140||dia>=90)?"warn":(sys<100)?"warn":"ok"));
  }
  if(map!=null) pills.push(pill(`MAP ${map} mmHg`, (map<65)?"bad":(map<75)?"warn":"ok"));

  // Pulsas – tachikardija/bradikardija žymime tik į planą (ir į esamas)
  if(hr!=null){
    if(hr>100){ esamos.push("Tachikardija"); pills.push(pill(`Pulsas ${hr}/min (tachikardija)`,"warn")); }
    else if(hr<50){ esamos.push("Bradikardija"); pills.push(pill(`Pulsas ${hr}/min (bradikardija)`,"warn")); }
    else pills.push(pill(`Pulsas ${hr}/min`,"ok"));
  }

  // Kvėpavimas
  if(f["trach"].value==="taip") esamos.push("Kvėpavimo takai su tracheostominiu vamzdžiu");
  if(f["nosis"].value==="istraukti") esamos.push("Nedidelis kraujavimas iš nosies");
  if(f["dusulys"].value==="taip") esamos.push("Sutrikusi kvėpavimo funkcija (dusulys)");

  // Mityba
  const mityba = f["mityba"].value;
  const rij = f["rijimas"].value === "taip";
  const suvalgo = f["suvalgo"].value;

  if(mityba==="burna" && rij) esamos.push("Rijimo sutrikimas / aspiracijos rizika");
  if(mityba==="zondas") esamos.push("Mityba per zondą (NG)");
  if(mityba==="peg") esamos.push("Mityba per PEG");
  if(suvalgo==="dalis" || suvalgo==="ne") esamos.push("Sumažėjęs suvartojamo maisto kiekis");

  // Šalinimas
  if(f["kateteris"].value==="yra") esamos.push("Šlapimo kateteris");

  // Oda
  if(f["pragulos"].value==="yra") esamos.push("Pragulos");
  if(f["zaizdos"].value==="yra"){
    const apr = f["zaizdos_text"].value.trim();
    esamos.push("Odos vientisumo pažeidimas (žaizda)"+(apr?(" – "+apr):""));
  }

  // Judėjimas / griuvimai
  const bedRest = (f['mobilumas'].value==='lova');
  const needHelp = (f['mobilumas'].value==='pagalba');
  const dizzy = (f['galvos_svaigimas'] && f['galvos_svaigimas'].value === 'taip');

  if (needHelp) {
    esamos.push("Judėjimas su pagalba");
    if (dizzy) galimos.push("Rizika griuvimui dėl galvos svaigimo");
    else galimos.push("Rizika griuvimui dėl pagalbos poreikio");
  } else if (bedRest) {
    galimos.push("Rizika praguloms dėl lovos režimo");
  } else {
    if (dizzy) galimos.push("Rizika griuvimui dėl galvos svaigimo");
  }

  // Kraujavimo rizika
  if (f["kraujavimo_rizika"].value==="yra") galimos.push("Kraujavimo rizika");

  // Skausmas – tik VIENAS įrašas su tiksliu kiekiu
  if(f["skausmas"].value==="taip"){
    const val = toNum(f["skausmoLygis"].value);
    if(val==null || val<0 || val>10){
      alert("Įveskite skausmo intensyvumą (0–10).");
      $("skausmoLygis").focus();
      return {esamos,galimos,pills, abort:true};
    }
    esamos.push(`Skausmas ${val}/10`);
    const sev = val>=7 ? "bad" : val>=4 ? "warn" : "ok";
    pills.push(pill(`Skausmas ${val}/10`, sev));
  }

  // Dublių šalinimas
  return {esamos:[...new Set(esamos)], galimos:[...new Set(galimos)], pills};
}

function patientPsySentence(){
  const flags = [];
  if ($("ramus").checked) flags.push("ramus");
  if ($("orientuotas").checked) flags.push("orientuotas");
  let text;
  if (!flags.length) text = "Pacientas: neramus, neorientuotas";
  else text = "Pacientas: " + flags.join(", ");
  if ($("suvarzymas").checked) {
    const t = new Date();
    const hh = String(t.getHours()).padStart(2,"0");
    const mm = String(t.getMinutes()).padStart(2,"0");
    text += `. Dėl galimos žalos sau pačiam ir aplinkiniams, neveikiant kitoms priemonėms pacientas fiksuotas ${hh}:${mm}.`;
  }
  return text;
}

function dietSentenceAndPlan(){
  const d = $("dieta").value;
  if (!d) return {sentence:"", planLine:""}; // nieko neįrašom
  if (d==="Kita") {
    const k = $("dieta_kita").value.trim();
    const sent = k ? `Pacientui skirta: ${k} dieta` : "";
    return {sentence:sent, planLine:""};
  }
  const map = {
    "P1":"P1 dieta",
    "PTM":"PTM dieta",
    "TM":"TM dieta",
    "SM":"SM dieta",
    "CD":"CD dieta",
    "PTM-CD":"PTM-CD dieta",
    "NPB":"NPB dieta",
    "P4":"P4 dieta",
    "Na":"Na dieta",
    "B":"Baltyminė (B) dieta",
    "Lac":"Be laktozės (Lac) dieta",
    "Sk":"Daugiau/mažiau skaidulų (Sk) dieta"
  };
  const sent = `Pacientui skirta: ${map[d] || d}`;
  const planLine = dietPlan[d] || "";
  return {sentence:sent, planLine};
}

function pill(text, severity="ok"){
  const cls = severity==="bad"?"pill bad":severity==="warn"?"pill warn":"pill ok";
  return `<span class="${cls}">${text}</span>`;
}

/* ======= RENDER + UPLOAD ======= */
function generateResults(){
  $("statusOk").style.display="none";
  $("statusErr").style.display="none";

  const f = document.forms["nursingForm"];
  const det = detectProblems(f);
  if (det.abort) return;

  const {esamos, galimos, pills} = det;

  // Dietos sakinys + papildomas plano sakinis
  const dietInfo = dietSentenceAndPlan();
  if (dietInfo.planLine) {
    // įterpti dietos planą kaip atskirą bloką (ne problema), kad atsirastų plane
    galimos.push(dietInfo.planLine); // kaip „plan only“ – netempsim į problemų sąrašą
  }

  // HTML atvaizdavimas
  let html = "";
  if(pills.length){
    html += `<div class="kudos"><strong>Greita santrauka:</strong> ${pills.join(" ")}</div>`;
  }

  html += `<h3>Esamos problemos</h3><ul>${esamos.length?esamos.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;
  const galimosShown = galimos.filter(g=>!dietInfo.planLine || g!==dietInfo.planLine); // nerodyti dietos plano kaip „problemos“
  html += `<h3>Galimos problemos</h3><ul>${galimosShown.length?galimosShown.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;

  html += `<h3>Slaugos planas</h3>`;
  const allForPlan = [...esamos, ...galimosShown];
  const uniqPlan = Array.from(new Set(allForPlan));
  uniqPlan.forEach(p=>{
    if (p && dietInfo.planLine && p===dietInfo.planLine) return;
    // speciali „Skausmas X/10“ porcija
    if (p.startsWith("Skausmas ")) {
      html += `<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${slaugosPlanas["Skausmas"].map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
      return;
    }
    const key = Object.keys(slaugosPlanas).find(k=>p===k || p.startsWith(k));
    if(key){
      html += `<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${slaugosPlanas[key].map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
    } else if (p && p===dietInfo.planLine) {
      html += `<div class="planas"><h4>Dietos planas</h4><ul><li>${escapeHtml(p)}</li></ul></div>`;
    }
  });
  if (dietInfo.planLine && !uniqPlan.includes(dietInfo.planLine)) {
    html += `<div class="planas"><h4>Dietos planas</h4><ul><li>${escapeHtml(dietInfo.planLine)}</li></ul></div>`;
  }

  // Gyvybiniai rodikliai + psichika + dieta
  const spo2 = toNum(f["saturacija"].value);
  const temp = toNum(f["temperatura"].value);
  const sys = toNum(f["sistolinis"].value);
  const dia = toNum(f["diastolinis"].value);
  const hr  = toNum(f["pulsas"].value);
  const map = calcMAP(sys, dia);

  html += `<h3>Įvesti gyvybiniai rodikliai</h3>
  <p><strong>SpO₂:</strong> ${valOrDash(spo2)} %<br>
  <strong>AKS:</strong> ${valOrDash(sys)} / ${valOrDash(dia)} mmHg ${map!=null?`(MAP: ${map} mmHg)`:``}<br>
  <strong>ŠSD:</strong> ${valOrDash(hr)} / min<br>
  <strong>Temperatūra:</strong> ${temp!=null?temp.toFixed(1):"-"} °C</p>`;

  const psych = patientPsySentence();
  html += `<p><strong>${escapeHtml(psych.split(':')[0])}:</strong> ${escapeHtml(psych.split(':')[1].trim())}</p>`;

  if (dietInfo.sentence) {
    html += `<p><strong>Pacientui skirta:</strong> ${escapeHtml(dietInfo.sentence.replace('Pacientui skirta:','').trim())}</p>`;
  }

  // Pirminis vertinimas
  const pv = buildPV();
  html += `<h3>Pirminis vertinimas</h3><p>${pv?escapePv(pv):'—'}</p>`;

  $("results").innerHTML = html;

  // Paruošti payload
  const pvText = pv || "";
  lastPayload = makeSingleCellRecord(f, esamos, galimosShown, spo2, sys, dia, map, hr, temp, psych, dietInfo.sentence, pvText);

  // parodyti JSON žemiau (naudinga testams)
  $("results").insertAdjacentHTML("beforeend",
    `<div class="mono" id="payloadBox">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`
  );
}

function escapePv(s){ return escapeHtml(s.replace(/\n/g,'; ')); }

function buildPV(){
  const parts = [];
  const al = $("alergijos").value.trim();
  const gr = $("gretutines").value.trim();
  const va = $("vaistai").value.trim();
  const inf = $("infekcijos").value.trim();
  if (al) parts.push(`Alergijos: ${al}`);
  if (gr) parts.push(`Gretutinės ligos: ${gr}`);
  if (va) parts.push(`Vartojami vaistai: ${va}`);
  if (inf) parts.push(`Infekcinės ligos: ${inf}`);
  return parts.join('\n');
}

function keltiISistema(){
  if(!lastPayload){ alert("Pirmiausia sugeneruokite rezultatą."); return; }
  const url = GOOGLE_SCRIPT_URL.trim();
  if(!url || !url.endsWith('/exec')){
    alert("Patikrinkite WebApp URL – turi baigtis /exec.");
    return;
  }
  fetch(url, {
    method: "POST",
    headers: {"Content-Type": "text/plain"},
    body: JSON.stringify(lastPayload),
    mode: "no-cors"
  })
  .then(()=>{
    $("statusErr").style.display="none";
    $("statusOk").style.display="block";
  })
  .catch(err=>{
    console.error(err);
    $("statusOk").style.display="none";
    $("statusErr").style.display="block";
  });
}

function resetForm(){
  document.getElementById("nursingForm").reset();
  $("results").innerHTML = "";
  $("statusOk").style.display="none";
  $("statusErr").style.display="none";
  $("zaizdos_aprasymas").style.display="none";
  lastPayload = null;
}
</script>
</body>
</html>

