<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Paciento vertinimas ir slaugos planas</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
    --accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  h1{margin:18px auto 0;max-width:1100px;padding:0 16px;font-size:22px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr));max-width:1100px;margin:14px auto;padding:0 16px}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:680px){.grid{grid-template-columns:1fr}}

  .section{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  h2{font-size:14px;margin:0 0 10px 0;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 0}
  input,select,textarea,button{
    width:100%;margin-top:6px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
    font-size:14px;background:#fff;color:var(--text);outline:none;
  }
  textarea{resize:vertical}
  .row{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:680px){.row{grid-template-columns:1fr}}

  select{
    -webkit-appearance:none;appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #6b7280 50%),
      linear-gradient(135deg, #6b7280 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 18px) calc(1em + 2px),
      calc(100% - 13px) calc(1em + 2px),
      100% 0;
    background-size:5px 5px, 5px 5px, 2.5em 2.5em;
    background-repeat:no-repeat;
    padding-right:40px;
  }

  .checks{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px}
  .checks label{display:flex;align-items:center;gap:8px;margin:0;color:var(--text);font-size:14px}
  .checks input{width:auto;margin:0}
  .checks{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px}
.checks label{display:flex;align-items:center;gap:8px;margin:0;color:var(--text);font-size:14px}
.checks input{width:auto;margin:0}

/* âœ… Svarbu: kad checkbox'ai nebÅ«tÅ³ kaip dideli input'ai */
input[type="checkbox"]{
  width:16px;
  height:16px;
  margin:0;
  padding:0;
  background:#fff;
  border:1px solid var(--line);
  border-radius:4px;
}
  .hint{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35}
/* âœ… ÄŒIA Ä®DÄ–K (po hint) */
.checkline{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:10px;
  color:var(--text);
  font-size:14px;
}
.checkline input{
  flex:0 0 auto;
}
  .actions{
  max-width:1100px;
  margin:0 auto;
  padding:0 16px 20px;

  display:grid;   /* âœ… vietoj flex */
  gap:10px;
}

.actions button{
  width:100%;     /* âœ… visi per visÄ… plotÄ¯ */
}
  button{cursor:pointer;border:none}
  #genBtn{background:var(--accent);color:#fff;font-weight:800}
  button.secondary{background:#fff;border:1px solid var(--line);font-weight:700}
  button.good{background:var(--ok);color:#fff;font-weight:800}

  .results{max-width:1100px;margin:0 auto 24px;padding:0 16px}
  .results .planas{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px}
  .results h3{margin:14px 0 8px}
  .results h4{margin:0 0 8px;font-size:14px}
  .results ul{margin:6px 0 0 18px;padding:0}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-right:6px;border:1px solid var(--line);background:#fff}
  .pill.ok{border-color:rgba(22,163,74,.25)}
  .pill.warn{border-color:rgba(245,158,11,.35)}
  .pill.bad{border-color:rgba(220,38,38,.35)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#111827;color:#f9fafb;padding:12px;border-radius:14px;margin-top:12px}

  .status{max-width:1100px;margin:0 auto;padding:0 16px 10px;display:none}
  .status.ok{color:var(--ok);font-weight:900}
  .status.err{color:var(--bad);font-weight:900}

  details.pv summary{cursor:pointer;font-weight:900;color:var(--text)}
  .pv-content{margin-top:10px}
  .pv-content input,.pv-content textarea{background:#fff}

  .modal{position:fixed;inset:0;display:block}
  .modal[aria-hidden="true"]{display:none}
.modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
 .modal__sheet{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(980px, calc(100% - 24px));
  max-height:calc(100% - 24px);
  overflow:auto;
  background:#fff;
  border-radius:18px;
  border:1px solid var(--line);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
@media (min-width: 1100px){
  .modal__sheet{
    width:min(1200px, calc(100% - 24px));
  }
}
  .modal__header{
    display:flex;align-items:flex-start; justify-content:space-between;
    gap:12px; padding:14px; border-bottom:1px solid var(--line);
  }
  .modal__title{ font-weight:900; font-size:18px; }
  .modal__subtitle{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.3; }
  .modal__close{
    border:1px solid var(--line); background:#fff; border-radius:10px;
    width:40px; height:40px; cursor:pointer; font-weight:800;
  }
  .modal__footer{
    position:sticky; bottom:0; background:#fff;
    padding:12px 14px; border-top:1px solid var(--line);
    display:flex; justify-content:flex-end; gap:10px;
  }

  .dvprsGrid{padding:14px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:720px){.dvprsGrid{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:980px){.dvprsGrid{grid-template-columns:repeat(3,1fr)}}
  .dvprsCard{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;cursor:pointer;text-align:left;overflow:hidden}
  .dvprsCard:active{transform:scale(0.99)}
.dvprsBar{
  height:10px;
  border-radius:999px;
  margin-bottom:10px;

  background:#e5e7eb; /* fallback jeigu nepagauna kintamojo */
  background-color:var(--dvprsColor,#e5e7eb);
}
  .dvprsTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .dvprsLeft{display:flex;align-items:center;gap:10px}
  .dvprsEmoji{font-size:26px;line-height:1}
  .dvprsNum{font-size:24px;font-weight:900;line-height:1}
  .dvprsTag{font-size:12px;color:var(--muted);white-space:nowrap}
  .dvprsText{margin-top:10px;font-size:13px;line-height:1.25;font-weight:700;color:#111}
  .dvprsLegend{padding:0 14px 14px;color:var(--muted);font-size:12px;line-height:1.3}
  @media (min-width: 720px) and (max-width: 1100px) {
  body{ font-size: 17px; }
  h1{ font-size: 26px; }
  .section{ padding: 17px; }
  h2{ font-size: 17px; }
  label{ font-size: 14px; }
  input, select, textarea, button{
    font-size: 17px;
    height: 52px;
    padding: 12px 14px;
  }
  textarea{ min-height: 110px; }
  }
  
/* ===== DVPRS: plÄ—sti paÄias korteles (eilutes), ne stulpelius ===== */
.dvprsCard{
  min-height: 96px;       /* padidina "eilutÄ™" */
  padding: 16px;          /* daugiau oro viduje */
  /* NEPRIVALOMA dÄ—ti display:flex â€“ paliekam ramiai */
}

.dvprsText{
  white-space: normal;
}

/* kompe dar didesnÄ—s */
@media (min-width: 980px){
  .dvprsCard{ min-height: 112px; }
}

</style>
</head>

<body>
<h1>Paciento vertinimas ir slaugos planas</h1>

<form id="nursingForm" novalidate>
  <div class="grid">

    <!-- IDENTIFIKACIJA -->
    <div class="section">
      <h2>Identifikacija</h2>
      <label for="palata">Palata
        <input id="palata" name="palata" autocomplete="off" />
      </label>
      <label for="lova">Lova
        <input id="lova" name="lova" autocomplete="off" />
      </label>
    </div>

    <!-- PACIENTO BÅªKLÄ– -->
    <div class="section">
      <h2>Paciento bÅ«klÄ—</h2>
      <div class="checks">
        <label><input type="checkbox" id="ramus" /> Ramus</label>
        <label><input type="checkbox" id="orientuotas" /> Orientuotas</label>
        <label><input type="checkbox" id="suvarzymas" /> SuvarÅ¾ymas</label>
      </div>
      <div class="hint">Jei nepaÅ¾ymÄ—ta â€“ Ä¯raÅ¡as bus: â€Pacientas: neramus, neorientuotasâ€œ.</div>
 <label class="checkline">
  <input type="checkbox" id="vykstaNamo" />
  Pacientas vyksta namo
</label>
</div>

<div id="namoBox" style="display:none; margin-top:10px">
  <label for="rekomTemplate">RekomendacijÅ³ Å¡ablonas
    <select id="rekomTemplate">
      <option value="">â€” pasirinkti â€”</option>
    </select>
  </label>
  <div class="hint">PaÅ¾ymÄ—jus â€Pacientas vyksta namoâ€œ, NEWS ir slaugos planas nebegeneruojami â€“ generuojamos rekomendacijos.</div>
</div>
</div>
    <!-- KVÄ–PAVIMO SISTEMA -->
    <div class="section">
      <h2>KvÄ—pavimo sistema</h2>

      <label for="trach">Tracheostominis vamzdis
        <select id="trach" name="trach">
          <option value="ne">NÄ—ra</option><option value="taip">Yra</option>
        </select>
      </label>

      <div class="row">
        <label for="sekretas_trach">Sekretas / atkosÄ—jimas iÅ¡ vamzdÅ¾io?
          <select id="sekretas_trach" name="sekretas_trach">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>

        <label for="siurbimas">Atliekamas siurbimas?
          <select id="siurbimas" name="siurbimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <label for="dusulys">Dusulys?
        <select id="dusulys" name="dusulys">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- GYVYBINIAI -->
    <div class="section">
      <h2>Gyvybiniai rodikliai</h2>

      <label for="saturacija">SpOâ‚‚ (%)
        <input id="saturacija" name="saturacija" inputmode="decimal" placeholder="pvz. 96" />
      </label>

      <div class="row">
        <label for="sistolinis">AKS sistolinis
          <input id="sistolinis" name="sistolinis" inputmode="decimal" placeholder="pvz. 120" />
        </label>
        <label for="diastolinis">AKS diastolinis
          <input id="diastolinis" name="diastolinis" inputmode="decimal" placeholder="pvz. 75" />
        </label>
      </div>

      <div class="row">
        <label for="pulsas">Pulsas / min
          <input id="pulsas" name="pulsas" inputmode="decimal" placeholder="pvz. 82" />
        </label>
        <label for="temperatura">TemperatÅ«ra (Â°C)
          <input id="temperatura" name="temperatura" inputmode="decimal" placeholder="pvz. 36.6" />
        </label>
      </div>
      <label for="rr">KvÄ—pavimo daÅ¾nis (/min)
  <input id="rr" name="rr" inputmode="decimal" placeholder="pvz. 16" />
</label>

<label for="o2">Papildomas Oâ‚‚
  <select id="o2" name="o2">
    <option value="ne">Ne</option>
    <option value="taip">Taip</option>
  </select>
</label>

<label for="avpu">SÄ…monÄ—s bÅ«klÄ—
  <select id="avpu" name="avpu">
    <option value="A">Budrus</option>
    <option value="V">Reaguoja Ä¯ balsÄ…</option>
    <option value="P">Reaguoja Ä¯ skausmÄ…</option>
    <option value="U">Nereaguoja</option>
    <option value="C">Naujai atsiradÄ™s sumiÅ¡imas</option>
  </select>
</label>
    </div>
    

    <!-- NOSIS -->
    <div class="section">
      <h2>Nosis</h2>
      <label for="nosis">Nosis
        <select id="nosis" name="nosis">
          <option value="nedaryta">Niekas nedaryta</option>
          <option value="tamponuota">Tamponuota nosis</option>
          <option value="istraukti">IÅ¡traukti tamponai</option>
        </select>
      </label>
    </div>

    <!-- MITYBA -->
    <div class="section">
      <h2>Mityba</h2>
      <label for="mityba">Mityba
        <select id="mityba" name="mityba">
          <option value="burna">Per burnÄ…</option>
          <option value="peg">Per PEG</option>
          <option value="zondas">Per zondÄ… (NG)</option>
        </select>
      </label>

      <div class="row">
        <label for="rijimas">Rijimas apsunkintas?
          <select id="rijimas" name="rijimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>

        <label for="suvalgo">Suvartoja visÄ… maistÄ…?
          <select id="suvalgo" name="suvalgo">
            <option value="taip">Taip</option><option value="ne">Ne</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Å ALINIMAS -->
    <div class="section">
      <h2>Å alinimas</h2>

      <label for="kateteris">Å lapimo kateteris
        <select id="kateteris" name="kateteris">
          <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
        </select>
      </label>

      <div class="row">
        <label for="viduriai">ViduriÅ³ uÅ¾kietÄ—jimas?
          <select id="viduriai" name="viduriai">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <label for="viduriavimas">Viduriavimas?
        <select id="viduriavimas" name="viduriavimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- JUDÄ–JIMAS -->
    <div class="section">
      <h2>JudÄ—jimas</h2>
      <label for="mobilumas">Mobilumas
        <select id="mobilumas" name="mobilumas">
          <option value="sav">SavarankiÅ¡kas</option>
          <option value="pagalba">Su pagalba</option>
          <option value="lova">Lovos reÅ¾imas</option>
        </select>
      </label>

      <!-- NAUJA: galvos svaigimas -->
      <label for="galvos_svaigimas">Galvos svaigimas?
        <select id="galvos_svaigimas" name="galvos_svaigimas">
          <option value="ne">Ne</option>
          <option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- MIEGAS -->
    <div class="section">
      <h2>Miegas</h2>
      <label for="miegas">Miego kokybÄ—
        <select id="miegas" name="miegas">
          <option value="gera">Gera</option>
          <option value="sutrikusi">Sutrikusi</option>
        </select>
      </label>
    </div>

    <!-- ODA -->
    <div class="section">
      <h2>Oda</h2>

      <div class="row">
        <label for="pragulos">Pragulos
          <select id="pragulos" name="pragulos">
            <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
          </select>
        </label>

        <label for="zaizdos">Å½aizdos
          <select id="zaizdos" name="zaizdos">
            <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
          </select>
        </label>
      </div>

      <div id="zaizdos_aprasymas" style="display:none;">
        <label for="zaizdos_text">Å½aizdos apraÅ¡ymas
          <textarea id="zaizdos_text" name="zaizdos_text" placeholder="Lokalizacija, dydis, sekrecija, paraudimas, skausmingumas."></textarea>
        </label>
      </div>
    </div>

    <!-- SKAUSMAS -->
    <div class="section" id="skausmas_section">
      <h2>Skausmas</h2>

      <div class="row">
        <label for="skausmas">Ar pacientas jauÄia skausmÄ…?
          <select id="skausmas" name="skausmas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>

        <label for="skausmoLygis">NRS (0â€“10)
          <input id="skausmoLygis" name="skausmoLygis" inputmode="numeric" placeholder="pvz. 5" />
        </label>
      </div>

      <button type="button" class="secondary" id="openDvprsBtn" style="margin-top:10px">
        Atidaryti DVPRS skausmo skalÄ™ (pacientui)
      </button>

      <div class="hint">DVPRS pasirinkimas automatiÅ¡kai Ä¯raÅ¡o NRS skaiÄiÅ³ Ä¯ laukÄ….</div>
    </div>

    <!-- DIETA -->
    <div class="section">
      <h2>Dieta</h2>
      <label for="dieta_kodas">Dieta (kodas)
        <select id="dieta_kodas" name="dieta_kodas">
          <option value="">â€”</option>
          <option value="P1">P1</option>
          <option value="P4">P4</option>
          <option value="PTM">PTM</option>
          <option value="TM">TM</option>
          <option value="SM">SM</option>
          <option value="CD">CD</option>
          <option value="PTM-CD">PTM-CD</option>
          <option value="Na">Na</option>
          <option value="Sk(padid.)">Sk(padid.)</option>
          <option value="Sk(maÅ¾.)">Sk(maÅ¾.)</option>
          <option value="B">B</option>
          <option value="Lac">Lac</option>
          <option value="NPB">NPB</option>
          <option value="KITA">Kita (Ä¯raÅ¡yti)</option>
        </select>
      </label>

      <div id="dieta_kita_wrap" style="display:none;">
        <label for="dieta_kita">Ä®raÅ¡ykite dietÄ…
          <input id="dieta_kita" name="dieta_kita" placeholder="pvz. tyrÄ—s konsistencija, be laktozÄ—s ir t. t." />
        </label>
      </div>
    </div>

    <!-- KRAUJAVIMO RIZIKA -->
    <div class="section">
      <h2>Kraujavimas</h2>
      <label for="kraujavimo_rizika">Kraujavimo rizika
        <select id="kraujavimo_rizika" name="kraujavimo_rizika">
          <option value="nera">NÄ—ra</option>
          <option value="yra">Yra</option>
        </select>
      </label>
      <div class="hint">Jei â€Yraâ€œ â€“ plane: â€StebÄ—jimas dÄ—l galimo kraujavimoâ€œ, â€AKS sekimasâ€œ.</div>
    </div>

    <!-- PIRMINIS VERTINIMAS -->
    <div class="section" style="grid-column:1 / -1">
      <details class="pv" id="pv_section">
        <summary>Pirminis vertinimas <span class="hint">(spustelÄ—kite)</span></summary>
        <div class="pv-content">
          <div class="checks" style="margin-top:6px">
            <label><input type="checkbox" id="pv_cv"> Å irdiesâ€“kraujotakos</label>
            <label><input type="checkbox" id="pv_resp"> KvÄ—pavimo</label>
            <label><input type="checkbox" id="pv_endo_cd"> EndokrininÄ—s (CD)</label>
            <label><input type="checkbox" id="pv_renal_hep"> InkstÅ³/kepenÅ³</label>
          </div>

          <label style="margin-top:10px">InfekcinÄ—s ligos (Ä¯raÅ¡ykite)
            <input id="pv_infection" placeholder="pvz. MRSA, C. difficile, TB, COVID." />
          </label>

          <label style="margin-top:10px">Alergijos
            <textarea id="pv_allergy" rows="2" placeholder="pvz. penicilinai, lateksas, maistas."></textarea>
          </label>

          <div class="hint" style="margin-top:6px">
            PaÅ¾ymÄ—tos sritys automatiÅ¡kai pridÄ—s atitinkamas intervencijas prie bendro slaugos plano.
          </div>
        </div>
      </details>
    </div>

  </div>

  <div class="actions">
    <button type="button" id="genBtn" onclick="generateResults()">Generuoti</button>
    <button type="button" id="resetBtn" class="secondary">Naujas pacientas</button>
    <button type="button" class="good" onclick="keltiISistema()">Kelti Ä¯ sistemÄ…</button>
  </div>
</form>

<div id="results" class="results" aria-live="polite"></div>
<div id="statusOk" class="status ok">âœ… Duomenys Ä¯kelti sÄ—kmingai.</div>
<div id="statusErr" class="status err">âŒ Klaida siunÄiant Ä¯ Google Sheets. Patikrinkite WebApp adresÄ… ir leidimus.</div>

<!-- DVPRS MODAL -->
<div id="dvprsModal" class="modal" aria-hidden="true">
  <div class="modal__backdrop" id="dvprsCloseBackdrop"></div>

  <div class="modal__sheet" role="dialog" aria-modal="true" aria-labelledby="dvprsTitle">
    <div class="modal__header">
      <div>
        <div id="dvprsTitle" class="modal__title">DVPRS skausmo skalÄ— (0â€“10)</div>
        <div class="modal__subtitle">
          Pacientas pasirenka skaiÄiÅ³. Pasirinkimas automatiÅ¡kai Ä¯raÅ¡omas Ä¯ NRS laukÄ….
        </div>
      </div>
      <button type="button" class="modal__close" id="dvprsCloseBtn" aria-label="UÅ¾daryti">âœ•</button>
    </div>

    <div class="dvprsLegend">
      Spalvos ir veidukai padeda greiÄiau susiorientuoti. VertinimÄ… patvirtina paciento pasirinktas skaiÄius (0â€“10).
    </div>

    <div id="dvprsGrid" class="dvprsGrid"></div>

    <div class="modal__footer">
      <button type="button" class="secondary" id="dvprsCancelBtn">UÅ¾daryti</button>
    </div>
  </div>
</div>

<script>

/* =========================================================
   SLAUGOS PLANAS â€” TVARKINGAI SUSKALDYTAS KODAS
   â€“ EDIT HERE #1: ribos (THRESHOLDS)
   â€“ EDIT HERE #2: planÅ³ tekstai (slaugosPlanas / dietPlan / restraintPlan)
   â€“ EDIT HERE #3: detectProblems() (kada kuri problema atsiranda)
   â€“ EDIT HERE #4: renderOutput() (kaip rodomas planas/Ä¯raÅ¡as)
========================================================= */

/* =========================================================
   0) BENDRI / HELPERS
========================================================= */
const $ = (id) => document.getElementById(id);
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
function toNum(v){ const n=parseFloat(String(v).replace(',', '.')); return Number.isFinite(n)?n:null; }
function calcMAP(sys, dia){ if(sys==null||dia==null) return null; return Math.round(((2*dia)+sys)/3); }
function valOrDash(v){ return (v==null||v==="")? "-" : v; }
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
  function news2Text(score, hasCritical){
  if(score===0){
    return "paciento bÅ«klÄ— stabili. Rekomenduojama tÄ™sti stebÄ—senÄ… ir kartoti gyvybinius rodiklius pagal Ä¯prastÄ… skyriaus tvarkÄ….";
  }
  if(score<=4 && !hasCritical){
    return "padidinta stebÄ—sena. Rekomenduojama Ä¯vertinti bendrÄ… paciento klinikinÄ™ bÅ«klÄ™ ir kartoti gyvybinius rodiklius daÅ¾niau kas 4â€“6 val.";
  }
  if(score<=4 && hasCritical){
    return "Yra bent vienas kritinis (3 balÅ³) parametras â€“ tai rodo galimÄ… paciento bÅ«klÄ—s blogÄ—jimÄ…. ReikÄ—tÅ³ Ä¯vertinti paciento bÅ«klÄ™ ir informuoti gydytojÄ…. GyvybiniÅ³ rodikliÅ³ stebÄ—jimÄ… kartoti daÅ¾niau â€“ kas 1 val.";
  }
  if(score<=6){
    return "vidutinÄ— klinikinÄ— rizika. Skubiai informuoti gydytojÄ…, uÅ¾tikrinti daÅ¾nÄ… paciento bÅ«klÄ—s stebÄ—senÄ… â€“ kas 30â€“60 min., svarstyti papildomÄ… monitoravimÄ… pagal bÅ«klÄ™.";
  }
  return "aukÅ¡ta klinikinÄ— rizika. Nedelsiant praneÅ¡ti gydytojui, reikalingas skubus gydytojo Ä¯vertinimas. Reikalinga nuolatinÄ— gyvybiniÅ³ rodikliÅ³ stebÄ—sena.";
}
function calcNEWS2({ rr, spo2, onO2, temp, sys, hr, avpu }) {
  let score = 0;
  let hasCritical = false;

  // RR
  if(rr!=null){
    if(rr<=8){ score+=3; hasCritical=true; }
    else if(rr<=11) score+=1;
    else if(rr<=20) score+=0;
    else if(rr<=24) score+=2;
    else { score+=3; hasCritical=true; }
  }

  // SpO2 (scale 1)
  if(spo2!=null){
    if(spo2<=91){ score+=3; hasCritical=true; }
    else if(spo2<=93) score+=2;
    else if(spo2<=95) score+=1;
  }

  // O2
  if(onO2) score+=2;

  // Temp
  if(temp!=null){
    if(temp<=35.0){ score+=3; hasCritical=true; }
    else if(temp<=36.0) score+=1;
    else if(temp<=38.0) score+=0;
    else if(temp<=39.0) score+=1;
    else score+=2;
  }

  // AKS
  if(sys!=null){
    if(sys<=90){ score+=3; hasCritical=true; }
    else if(sys<=100) score+=2;
    else if(sys<=110) score+=1;
  }

  // Pulsas
  if(hr!=null){
    if(hr<=40){ score+=3; hasCritical=true; }
    else if(hr<=50) score+=1;
    else if(hr<=90) score+=0;
    else if(hr<=110) score+=1;
    else if(hr<=130) score+=2;
    else { score+=3; hasCritical=true; }
  }

  // AVPU + C
  if(avpu && avpu!=='A'){ score+=3; hasCritical=true; }

  return { score, hasCritical };
} 
function classifyPill(text, severity="ok"){ const cls=severity==="bad"?"pill bad":severity==="warn"?"pill warn":"pill ok"; return `<span class="${cls}">${escapeHtml(text)}</span>`; }
function uniq(arr){ return [...new Set(arr)].filter(Boolean); }
function vitalsText(spo2, sys, dia, map, hr, temp){
  const aks=(sys!=null&&dia!=null)?`${sys}/${dia} mmHg${map!=null?` (MAP ${map})`:""}`:"-";
  const t=(temp!=null)?`${Number(temp).toFixed(1)} Â°C`:"-";
  const s=(spo2!=null)?`${spo2} %`:"-";
  const h=(hr!=null)?`${hr}/min`:"-";
  return `SpOâ‚‚: ${s}, AKS: ${aks}, Å SD: ${h}, T: ${t}`;
}

/* =========================================================
   1) CONFIG  (EDIT HERE #1)
========================================================= */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxODAbmdrmccCYCUkswsFgnz-nrC8clEQQf-5kId3y-3TCqUwsU4pyCze2Jojv43VV_1A/exec";

const THRESHOLDS = {
  spo2Warn: 95, spo2Critical: 90,
  tempSubfebrile: 37.1, tempFever: 38.0, tempHypothermia: 35.6,
  sysLow: 100, mapLow: 65, sysHigh: 140, diaHigh: 90, sysVeryHigh_30min: 165,
  hrTachy: 100, hrBrady: 50
};

/* =========================================================
   2) DATA / PLANAI  (EDIT HERE #2)
========================================================= */
const slaugosPlanas = {
  /* KvÄ—pavimas */
  "KvÄ—pavimo takai su tracheostominiu vamzdÅ¾iu": [
    "Savalaikis atsiurbimas iÅ¡ tracheostominio vamzdelio",
    "Vamzdelio drÄ—kinimas",
    "Palatos oro drÄ—kinimas",
    "Sekreto (kiekio/spalvos/klampumo) vertinimas ir dokumentavimas",
    "Stomos prieÅ¾iÅ«ra â€“ tvarsÄio keitimas bent 2 k./parÄ…",
    "Tracheostominio vamzdelio fiksacijos patikra"
  ],
  "Nedidelis kraujavimas iÅ¡ nosies": [
    "AKS stebÄ—jimas kraujavimui nestojant",
    "Pacientas apmokintas kaip priÅ¾iÅ«rÄ—ti nosÄ¯ kraujavimui sustojus"
  ],
  "Tamponuota nosis": ["Nosies tvarÅ¡Äio keitimas"],
  "Sutrikusi kvÄ—pavimo funkcija (dusulys)": ["SpOâ‚‚ stebÄ—jimas","Prireikus Oâ‚‚ skyrimas pagal SpOâ‚‚"],
  "Neefektyvi dujÅ³ apykaita": ["SpOâ‚‚ stebÄ—jimas","Oâ‚‚ skyrimas ir reguliavimas pagal SpOâ‚‚ duomenis"],

  /* Å irdies-kraujotaka */
  "PaÅ¾emÄ—jÄ™s kraujo spaudimas": [
    "Patarta neskubÄ—ti keltis, pasÄ—dÄ—ti nuleidus kojas prieÅ¡ einant",
    "StebÄ—jimas dÄ—l galimÅ³ griuvimÅ³",
    "AKS matavimas po 1 val."
  ],
  "PadidÄ—jÄ™s kraujo spaudimas": [
    "AKS sekimas kas 4 val."
  ],
  "Tachikardija": [
    "Pulsas sekamas kas 4 val.",
    "Ä®vertinti galimas prieÅ¾astis (skausmas, karÅ¡Äiavimas, hipovolemija, hipoksija, nerimas)",
    "AKS ir SpOâ‚‚ stebÄ—jimas",
    "Jei pulsas >120/min ar yra simptomai â€“ informuoti gydytojÄ…"
  ],
  "Bradikardija": [
    "Pulsas sekamas kas 4 val.",
    "AKS, sÄ…monÄ—s bÅ«klÄ—s ir perfuzijos stebÄ—jimas",
    "Jei yra simptomai arba AKS Å¾emas â€“ informuoti gydytojÄ…"
  ],

  /* Mityba â€“ bÅ«das */
  "Mityba per zondÄ… (NG)": [
    "Zondo padÄ—ties patikra pagal Ä¯staigos protokolÄ…",
    "GalvÅ«galis â‰¥30â€“45Â° maitinimo metu ir 30â€“60 min po",
    "Zondo praplovimas prieÅ¡ ir po maitinimo bei vaistÅ³",
    "Nosies ir odos prie zondo prieÅ¾iÅ«ra, fiksacijos patikra",
    "StebÄ—ti dÄ—l aspiracijos, pykinimo, pilvo pÅ«timo"
  ],
  "Mityba per PEG": [
    "PEG prieÅ¾iÅ«ra pagal Ä¯staigos protokolÄ…",
    "GalvÅ«galis â‰¥30â€“45Â° maitinimo metu ir 30â€“60 min po",
    "PEG praplovimas prieÅ¡ ir po maitinimo bei vaistÅ³",
    "StebÄ—ti dÄ—l aspiracijos, pykinimo, pilvo pÅ«timo"
  ],

  /* Mityba â€“ turinys/rijimas */
  "Rijimo sutrikimas / aspiracijos rizika": [
    "StebÄ—jimas dÄ—l aspiracijos",
    "Pagalba valgant",
    "Maisto tirÅ¡tinimas prireikus pagal gydytojo paskyrimÄ…"
  ],
  "SumaÅ¾Ä—jÄ™s suvartojamo maisto kiekis": [
    "Ä®vertinti ir dokumentuoti valgymo metu suvartotÄ… maisto kiekÄ¯",
    "PasiÅ«lyti uÅ¾kandÅ¾ius tarp valgymÅ³; pagal paskyrimÄ… â€” papildai / gÄ—rimai su kalorijomis",
    "Ä®vertinti pykinimÄ…/skausmÄ… prieÅ¡ valgÄ¯; taikyti priemones pagal paskyrimÄ… (antiemetikai, nuskausminimas)",
    "PrieÅ¡ valgÄ¯ patogi padÄ—tis; pagalba maitinantis",
    "Informuoti gydytojÄ…, jei suvalgo <50â€“75 % keliÅ³ valgymÅ³ metu iÅ¡ eilÄ—s",
    "StebÄ—ti skysÄiÅ³ balansÄ… ir (jei taikoma) kÅ«no masÄ™ periodiÅ¡kai"
  ],

  /* Oda / pragulos / Å¾aizdos */
  "Rizika praguloms dÄ—l lovos reÅ¾imo": [
    "Odos bÅ«klÄ—s stebÄ—jimas",
    "Pozicionavimas pagal bÅ«klÄ™",
    "PragulÅ³ profilaktika"
  ],
  "Pragulos": [
    "Odos bÅ«klÄ—s stebÄ—jimas",
    "Pozicionavimas pagal bÅ«klÄ™ kas 2 - 3 valandas",
    "PagalbinÄ—s priemonÄ—s pozicionavimui",
    "Pragulos perriÅ¡imas pagal Å¾aizdÅ³ prieÅ¾iÅ«ros planÄ…"
  ],
  "Odos vientisumo paÅ¾eidimas (Å¾aizda)": ["Å½aizdos perriÅ¡imas","StebÄ—ti infekcijos poÅ¾ymius"],
  "Gulimas reÅ¾imas ir pragulos": [
    "Odos bÅ«klÄ—s stebÄ—jimas",
    "Pozicionavimas pagal bÅ«klÄ™ kas 2â€“3 valandas",
    "PagalbinÄ—s priemonÄ—s paciento pozicionavimui",
    "Pragulos perriÅ¡imas pagal Å¾aizdÅ³ prieÅ¾iÅ«ros planÄ…",
    "NaujÅ³ pragulÅ³ atsiradimo profilaktika"
  ],

  /* Miegas, temperatÅ«ra */
  "SutrikÄ™s miegas": [
    "Miego ir poilsio reÅ¾imo vertinimas",
    "Aplinkos veiksniÅ³ korekcija (triukÅ¡mas, Å¡viesa, temperatÅ«ra)",
    "Skausmo vertinimas prieÅ¡ miegÄ…",
    "NefarmakologiniÅ³ miego gerinimo priemoniÅ³ taikymas",
    "Paciento savijautos stebÄ—jimas ryte"
  ],
  "PadidÄ—jusi temperatÅ«ra": ["TemperatÅ«ros stebÄ—jimas"],
  "Hipotermija": ["Å ilumos palaikymas","TemperatÅ«ros stebÄ—jimas"],

  /* Å alinimas */
  "Å lapimo kateteris": [
    "Palaikomas uÅ¾daras drenavimo sistemos vientisumas.",
    "Å lapimo maiÅ¡as visada Å¾emiau Å¡lapimo pÅ«slÄ—s lygio; pakabintas prie paciento lovos.",
    "DiurezÄ—s apskaita (ml/val., ml/24 h) ir Å¡lapimo pobÅ«dÅ¾io vertinimas.",
    "Infekcijos profilaktika: stebÄ—ti TÂ°, infekcijos poÅ¾ymius, pokyÄius Å¡lapimo spalvoje, drumzlÄ—tume.",
    "Paciento mokymas: tinkamas maiÅ¡o iÅ¡tuÅ¡tinimas ir sistemos apsauga nuo tempimo."
  ],
  "ViduriÅ³ uÅ¾kietÄ—jimas": ["StebÄ—ti tuÅ¡tinimÄ…si","SkysÄiÅ³/aktyvumo skatinimas pagal bÅ«klÄ™","PriemoniÅ³ taikymas pagal paskyrimÄ…"],
  "Viduriavimas": ["StebÄ—ti tuÅ¡tinimÄ…si","Odos prieÅ¾iÅ«ra tarpvietÄ—je","SkysÄiÅ³ balanso stebÄ—jimas"],

  /* Skausmas (intervalÅ³ planas) */
  "Nedidelis skausmas (1â€“3/10)": ["Nefarmakologinis skausmo malÅ¡inimas","Pacientui norint â€“ farmakologinis nuskausminimas"],
  "Vidutinis skausmas (4â€“6/10)": ["Savalaikis nuskausminimas pagal gydytojo paskyrimÄ…","Pakartotinis skausmo matavimas po 30 min. po vaistÅ³ suleidimo/sudavimo"],
  "Didelis skausmas (7â€“10/10)": ["Skubus nuskausminimas pagal gydytojo paskyrimÄ…","Pakartotinis skausmo matavimas po 15 min."],

  /* Rizikos */
  "Kraujavimo rizika": ["StebÄ—jimas dÄ—l galimo kraujavimo","AKS sekimas"],
  "Rizika griuvimui dÄ—l pagalbos poreikio": [
    "GriuvimÅ³ rizikos Ä¯vertinimas; Å¾ymÄ—jimas",
    "Aplinka be kliÅ«ÄiÅ³, naktinis apÅ¡vietimas",
    "Skambutis pasiekiamas; pacientas instruktuojamas kviesti pagalbÄ…",
    "WC palyda, pagalbinÄ—s priemonÄ—s",
    "Lovos/veÅ¾imÄ—lio stabdÅ¾iai uÅ¾fiksuoti prieÅ¡ persodinant",
    "Reguliari stebÄ—sena ir dokumentavimas"
  ],

  /* JudÄ—jimas â€“ esama */
  "JudÄ—jimas su pagalba": [
    "Nustatomas individualus pagalbos lygis (1â€“2 asmenys, vaikÅ¡tynÄ—/ramentai).",
    "KÄ—limasis lÄ—tai â€“ ortostatinÄ—s hipotenzijos profilaktika.",
    "Saugi aplinka: lova nuleista, stabdÅ¾iai uÅ¾fiksuoti, skambutis pasiekiamas.",
    "Patarta dÄ—vÄ—ti neslystanÄias kojines / tinkamÄ… avalynÄ™.",
    "Pirmo atsistojimo/persikÄ—limo metu â€“ slaugytojo prieÅ¾iÅ«ra."
  ],

  /* NAUJA: GriuvimÅ³ rizika dÄ—l galvos svaigimo (kai NÄ–RA â€su pagalbaâ€œ) */
  "Rizika griuvimui dÄ—l galvos svaigimo": [
    "AKS sekimas",
    "GriuvimÅ³ rizikos Ä¯vertinimas; Å¾ymÄ—jimas",
    "Aplinka be kliÅ«ÄiÅ³, naktinis apÅ¡vietimas",
    "Skambutis pasiekiamas; pacientas instruktuojamas kviesti pagalbÄ…",
    "WC palyda, pagalbinÄ—s priemonÄ—s",
    "Lovos/veÅ¾imÄ—lio stabdÅ¾iai uÅ¾fiksuoti prieÅ¡ persodinant",
    "Reguliari stebÄ—sena ir dokumentavimas"
  ]
    };
  const DISCHARGE_TEMPLATES = [
  {
    id: "gerklu_mikroskopine",
    name: "Po mikroskopinÄ—s gerklÅ³ operacijos (balso klosÄiÅ³ dariniai)",
    items: [
      "Tylos reÅ¾imas 5 d.",
      "BalsÄ… tausojantis reÅ¾imas 2 sav. (nekalbÄ—ti pakeltu tonu, neÅ¡nibÅ¾dÄ—ti, nedainuoti).",
      "NamÅ³ reÅ¾imas 2 sav.; vengti kelioniÅ³, dÅ«mÅ³, dulkiÅ³, karÅ¡tÅ³ patalpÅ³.",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 2 sav., nekelti sunkiÅ³ daiktÅ³.",
      "Vengti pirÄiÅ³, karÅ¡tÅ³ voniÅ³, baseinÅ³, soliariumÅ³ 2 sav.",
      "Ryte ir vakare matuoti temperatÅ«rÄ…."
    ]
  },
  {
    id: "konchoplastika",
    name: "Po nosies kriaukliÅ³ operacijos (konchoplastika)",
    items: [
      "Ryte ir vakare matuoti temperatÅ«rÄ…; >38Â°C â€“ kreiptis Ä¯ Å¡eimos gydytojÄ… (nevartoti aspirino).",
      "NepÅ«sti nosies ~1 sav.",
      "NamÅ³ reÅ¾imas 2 sav.; vengti kelioniÅ³, dÅ«mÅ³, dulkiÅ³, karÅ¡tÅ³ patalpÅ³.",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 2 sav., nekelti sunkiÅ³ daiktÅ³; vengti kontaktÅ³ 1 mÄ—n.",
      "Vengti pirÄiÅ³, karÅ¡tÅ³ voniÅ³, baseinÅ³, soliariumÅ³ 2 sav.",
      "Plauti ir drÄ—kinti nosÄ¯ kaip nurodÄ— gydytojas.",
      "UÅ¾sitÄ™sus karÅ¡Äiavimui ar prasidÄ—jus gausiam kraujavimui â€“ skubi pagalba."
    ]
  },
  {
    id: "nosikauliu_luziai_rinoseptoplastika",
    name: "Po nosikauliÅ³ lÅ«Å¾iÅ³ atstatymo / po rinoseptoplastikos",
    items: [
      "Ryte ir vakare matuoti temperatÅ«rÄ…; >38Â°C â€“ kreiptis Ä¯ Å¡eimos gydytojÄ… (nevartoti aspirino).",
      "NepÅ«sti nosies ~1 sav.",
      "NamÅ³ reÅ¾imas 2 sav. (vengti kelioniÅ³, dÅ«mÅ³, dulkiÅ³, karÅ¡tÅ³ patalpÅ³).",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 2 sav., nekelti sunkiÅ³ daiktÅ³.",
      "Jei yra rizika uÅ¾sigauti nosÄ¯ â€“ vengti kontaktÅ³ 1â€“1,5 mÄ—n.",
      "Vengti pirÄiÅ³, karÅ¡tÅ³ voniÅ³, baseinÅ³, soliariumÅ³ 2 sav.",
      "Jei buvo gipsas po lÅ«Å¾iÅ³ atstatymo â€“ neÅ¡ioti iki 10 d.; suÅ¡lapus nebedÄ—ti atgal.",
      "Plauti ir drÄ—kinti nosÄ¯ kaip nurodÄ— gydytojas.",
      "UÅ¾sitÄ™sus karÅ¡Äiavimui ar prasidÄ—jus gausiam kraujavimui â€“ kreiptis Ä¯ skubiÄ… pagalbÄ…."
    ]
  },
  {
    id: "septoplastika_funkcine_rinoplastika",
    name: "Po septoplastikos / funkcinÄ—s rinoplastikos",
    items: [
      "Ryte ir vakare matuoti temperatÅ«rÄ…; >38Â°C â€“ kreiptis Ä¯ Å¡eimos gydytojÄ… (nevartoti aspirino).",
      "NepÅ«sti nosies ~1 sav.",
      "Galimas nosies uÅ¾gulimas pirmomis dienomis â€“ tai normalu.",
      "NamÅ³ reÅ¾imas 2 sav. (vengti kelioniÅ³, dÅ«mÅ³, dulkiÅ³, karÅ¡tÅ³ patalpÅ³).",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 2 sav., nekelti sunkiÅ³ daiktÅ³.",
      "Vengti kontaktÅ³ / smÅ«gio Ä¯ nosÄ¯ 1 mÄ—n.",
      "Vengti pirÄiÅ³, karÅ¡tÅ³ voniÅ³, baseinÅ³, soliariumÅ³ 2 sav.",
      "Plauti ir drÄ—kinti nosÄ¯ kaip nurodÄ— gydytojas.",
      "UÅ¾sitÄ™sus karÅ¡Äiavimui ar prasidÄ—jus gausiam kraujavimui â€“ skubi pagalba."
    ]
  },
  {
    id: "tonzilektomija",
    name: "Po tonziliÅ³ paÅ¡alinimo",
    items: [
      "Skausmui â€“ Paracetamolis arba Ibuprofenas 2â€“3 k./d. (nevartoti Aspirino, Ketanovo).",
      "Galimas karÅ¡Äiavimas iki 37,5Â°C ~2 sav.; >38Â°C ilgiau nei 3 d. â€“ kreiptis Ä¯ Å¡eimos gydytojÄ….",
      "2 sav. vengti karÅ¡to, aÅ¡traus, rÅ«gÅ¡taus, kieto, traÅ¡kaus maisto.",
      "Rekomenduojamas skystas/trintas, baltymingas maistas 2 sav.",
      "Gerti â‰¥ 125 ml kas 2 val. (negazuoti gÄ—rimai).",
      "2 sav. nesimaudyti karÅ¡toje vonioje, neplauti galvos (galima duÅ¡as, jei gerai jauÄiasi).",
      "Dantis valyti Å¡velniai, su maÅ¾ai pastos; neskalauti burnos.",
      "2 sav. riboti fizinÄ¯ krÅ«vÄ¯; nekelti sunkiÅ³ daiktÅ³; vengti sporto, pirÄiÅ³, baseinÅ³, soliariumÅ³.",
      "10 d. vengti krenkÅ¡timo/kosÄ—jimo.",
      "Jei atsiranda kraujavimas â€“ Å¡aldyti kaklo sritÄ¯, laikyti galvÄ… palenktÄ… Ä¯ priekÄ¯; jei kraujo >15 ml ar â€kavos tirÅ¡ÄiÅ³â€œ vÄ—mimas â€“ skubi pagalba.",
      "Vaikui â€“ rekomenduojama suaugusiojo prieÅ¾iÅ«ra naktÄ¯ 2 sav."
    ]
  },
  {
    id: "adenoidektomija",
    name: "Po adenoidÅ³ paÅ¡alinimo",
    items: [
      "Galimas nedidelis gerklÄ—s skausmas kelias dienas; skausmui â€“ Paracetamolis arba Ibuprofenas (nevartoti Aspirino, Ketanovo).",
      "Galimas karÅ¡Äiavimas iki 37,5Â°C ~2 sav.; >38Â°C ilgiau nei 3 d. â€“ kreiptis Ä¯ Å¡eimos gydytojÄ….",
      "Pirmas 3 paras vengti karÅ¡to, aÅ¡traus, rÅ«gÅ¡taus, kieto, traÅ¡kaus maisto.",
      "Rekomenduojamas skystas/trintas maistas 3 paras.",
      "Gerti â‰¥ 125 ml kas 2 val. (negazuoti gÄ—rimai).",
      "1 sav. nesimaudyti karÅ¡toje vonioje, neplauti galvos (galima duÅ¡as, jei gerai jauÄiasi).",
      "Dantis valyti Å¡velniai, su maÅ¾ai pastos; neskalauti burnos.",
      "2 sav. riboti fizinÄ¯ krÅ«vÄ¯; vengti sporto, pirÄiÅ³, baseinÅ³, soliariumÅ³.",
      "10 d. vengti krenkÅ¡timo/kosÄ—jimo.",
      "Jei prasideda kraujavimas iÅ¡ nosies ar su seilÄ—mis â€“ Å¡aldyti kaktos srityje, galvÄ… laikyti palenktÄ… Ä¯ priekÄ¯; jei kraujo >15 ml â€“ skubi pagalba.",
      "Vaikui â€“ rekomenduojama suaugusiojo prieÅ¾iÅ«ra naktÄ¯ 2 sav."
    ]
  },
  {
    id: "tonziles_adenoidai_bendra",
    name: "Bendra po tonziliÅ³ / adenoidÅ³ paÅ¡alinimo",
    items: [
      "Skausmui â€“ Paracetamolis arba Ibuprofenas 2â€“3 k./d. (nevartoti Aspirino, Ketanovo).",
      "Galimas karÅ¡Äiavimas iki 37,5Â°C ~2 sav.; >38Â°C ilgiau nei 3 d. â€“ kreiptis Ä¯ Å¡eimos gydytojÄ….",
      "2 sav. vengti karÅ¡to, aÅ¡traus, rÅ«gÅ¡taus, kieto, traÅ¡kaus maisto.",
      "Rekomenduojamas skystas/trintas maistas (ypaÄ pirmas dienas).",
      "Gerti â‰¥ 125 ml kas 2 val. (negazuoti gÄ—rimai).",
      "1â€“2 sav. nesimaudyti karÅ¡toje vonioje, neplauti galvos (galima duÅ¡as, jei gerai jauÄiasi).",
      "Dantis valyti Å¡velniai; neskalauti burnos.",
      "2 sav. riboti fizinÄ¯ krÅ«vÄ¯; nekelti sunkiÅ³ daiktÅ³; vengti sporto, pirÄiÅ³, baseinÅ³, soliariumÅ³.",
      "10 d. vengti krenkÅ¡timo/kosÄ—jimo.",
      "Jei atsiranda reikÅ¡mingas kraujavimas (>15 ml) ar â€kavos tirÅ¡ÄiÅ³â€œ vÄ—mimas â€“ skubi pagalba.",
      "Vaikui â€“ rekomenduojama suaugusiojo prieÅ¾iÅ«ra naktÄ¯ 2 sav."
    ]
  },
  {
    id: "tracheostoma_trumpai",
    name: "Tracheostoma â€“ pagrindinÄ—s rekomendacijos (trumpai)",
    items: [
      "TracheostominÄ¯ vamzdelÄ¯ keisti 1 k./parÄ… arba kaip nurodÄ— gydytojas.",
      "Keisti nedelsiant, jei atsiranda uÅ¾sikimÅ¡imo poÅ¾ymiÅ³ (dusulys, triukÅ¡mingas kvÄ—pavimas). Laikytis rankÅ³ higienos.",
      "Kasdien apÅ¾iÅ«rÄ—ti ir nuplauti odÄ… aplink stomÄ…; gerai nusausinti.",
      "~1 mÄ—n. dÄ—ti tvarstÄ¯ po vamzdeliu; keisti, kai susitepa.",
      "Vamzdelis turi laikytis tvirtai, bet nespausti kaklo (2 pirÅ¡tai).",
      "Susitepusius raiÅ¡telius pakeisti.",
      "TracheostomÄ… visada pridengti Å¡varia marle / filtru.",
      "Galima drÄ—kinti Ä¯kvepiamÄ… orÄ… (drÄ—gna marlÄ—, fiziologinis tirpalas â€“ jei paskirta), taip pat rekomenduojama naudoti oro drÄ—kintuvus sausose patalpose.",
      "Maudantis saugoti, kad vanduo nepatektÅ³ Ä¯ vamzdelÄ¯.",
      "TurÄ—ti atsarginius vamzdelius (jei paskirta).",
      "Jei vamzdelis uÅ¾sikimÅ¡o â€“ bandyti atkosÄ—ti sÄ—dint, pasilenkus Ä¯ priekÄ¯; jei nepavyksta â€“ skubi pagalba.",
      "Ä® gydytojÄ… kreiptis, jei: pasirodÄ— kraujas iÅ¡ tracheostomos; atsirado paraudimas/patinimas aplink stomÄ…; pakito sekretas ar atsirado blogas kvapas; prasidÄ—jo karÅ¡Äiavimas; didÄ—jantis dusulys."
    ]
  },
  {
    id: "zaizda_isorine_bendra",
    name: "Bendros rekomendacijos po operacijÅ³ su iÅ¡orine Å¾aizda",
    items: [
      "TvarstÄ¯ laikyti Å¡varÅ³ ir sausÄ…; keisti kasdien ar susitepus.",
      "Naudoti gydytojo ar vaistininko rekomenduotÄ… antiseptikÄ….",
      "NeÅ¡lapinti 24â€“48 val.; vÄ—liau trumpas duÅ¡as be trynimo.",
      "Nemirkyti Å¾aizdos 2 sav.",
      "Neliesti neÅ¡variomis rankomis, nekrapÅ¡tyti Å¡aÅ¡o.",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 7â€“14 d.",
      "Kreiptis Ä¯ gydytojÄ… esant paraudimui, pÅ«liavimui ar karÅ¡Äiavimas >38Â°C."
    ]
  },
  {
    id: "uzausio_pjuvis",
    name: "Po operacijos su uÅ¾ausio pjÅ«viu",
    items: [
      "TvarstÄ¯ laikyti sausÄ…; keisti kasdien ar susitepus.",
      "Naudoti gydytojo ar vaistininko rekomenduotÄ… antiseptikÄ….",
      "NeÅ¡lapinti 24â€“48 val.; neplauti galvos.",
      "Å½aizdos nemirkyti 2 sav.",
      "Vengti spaudimo (ausinÄ—s, akiniai, kepurÄ—s).",
      "Miegoti ant prieÅ¡ingos pusÄ—s 7â€“10 d.",
      "Saugoti nuo saulÄ—s 1â€“2 mÄ—n.",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 7â€“14 d.",
      "Skubiai kreiptis, jei paraudimas, pÅ«liavimas, Å¾aizdos prasiskyrimas ar karÅ¡Äiavimas >38Â°C."
    ]
  },
  {
    id: "kaklo_pjuvis",
    name: "Po operacijos su kaklo pjÅ«viu",
    items: [
      "TvarstÄ¯ laikyti sausÄ…; keisti kasdien.",
      "Naudoti gydytojo ar vaistininko rekomenduotÄ… antiseptikÄ….",
      "NeÅ¡lapinti 24â€“48 val.",
      "Å½aizdos nemirkyti 2 sav.",
      "Vengti spaudimo (aptemptos apykaklÄ—s, Å¡alikai).",
      "Vengti staigiÅ³ kaklo judesiÅ³ 7â€“10 d.",
      "Saugoti nuo saulÄ—s 1â€“2 mÄ—n.",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 7â€“14 d.",
      "Skubiai kreiptis, jei paraudimas, pÅ«liavimas, Å¾aizdos prasiskyrimas ar karÅ¡Äiavimas >38Â°C."
    ]
  },
  {
    id: "veido_zaizda",
    name: "Po operacijos su Å¾aizda veido srityje",
    items: [
      "TvarstÄ¯ laikyti sausÄ…; keisti kasdien.",
      "NeÅ¡lapinti 24â€“48 val.",
      "Naudoti gydytojo ar vaistininko rekomenduotÄ… antiseptikÄ….",
      "Å½aizdos nemirkyti 2 sav.",
      "Neliesti Å¾aizdos neÅ¡variomis rankomis.",
      "NekrapÅ¡tyti Å¡aÅ¡o, nenuplÄ—Å¡ti pleistrÅ³.",
      "Vengti spaudimo ir tempimo Å¾aizdos srityje.",
      "Vengti makiaÅ¾o, kremÅ³, Å¡veitikliÅ³ iki leidimo.",
      "Saugoti nuo saulÄ—s 1â€“2 mÄ—n. (vÄ—liau â€“ SPF 50+).",
      "Riboti fizinÄ¯ krÅ«vÄ¯ 7â€“14 d.",
      "Skubiai kreiptis, jei paraudimas, pÅ«liavimas, Å¾aizdos prasiskyrimas ar karÅ¡Äiavimas >38Â°C."
    ]
  }
];

const dietPlan = {
  "P1": [], "P4": [],
  "PTM":   ["Stebima, kaip pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos."],
  "TM":    ["Stebima, kaip pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos."],
  "SM":    ["Pacientas maitinamas maÅ¾ais boliusais, lÄ—tai; stebima dÄ—l aspiracijos rizikos."],
  "CD":    ["Sekama glikemija."],
  "PTM-CD":["Stebima, kaip pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos; sekama glikemija."],
  "Na":    ["Stebima dÄ—l edemÅ³, pastebÄ—jus â€“ AKS ir skysÄiÅ³ sekimas."],
  "Sk(padid.)": ["Stebima dÄ—l pilvo pÅ«timo ir tuÅ¡tinimosi."],
  "Sk(maÅ¾.)":   ["Stebima dÄ—l pilvo pÅ«timo ir tuÅ¡tinimosi."],
  "B": [], "Lac": [],
  "NPB": ["Pacientas nieko nevalgo ir negeria, kol kitaip nenurodÄ— gydytojas."]
};

const restraintPlan = [
  "Taikoma fizinio suvarÅ¾ymo priemonÄ—s, imobilizuota galÅ«nÄ— atlaisvinama kas 1,5 val.",
  "Stebima oda po fiksavimo priemone, Ä¯vertinami spaudimo/paraudimo poÅ¾ymiai",
  "Stebima periferinÄ— kraujotaka (spalva, temperatÅ«ra, jutimai)",
  "Stebima paciento emocinÄ— bÅ«klÄ— ir stengiamasi sumaÅ¾inti nerimÄ…",
  "SuvarÅ¾ymo taikymas dokumentuojamas"
];

const dvprs = [
  { n: 0,  emoji:"ğŸ˜€", color:"#16a34a", text:"NERA SKAUSMO" },

  { n: 1,  emoji:"ğŸ™‚", color:"#22c55e", text:"NEPASTEBIMAS SKAUSMAS" },
  { n: 2,  emoji:"ğŸ™‚", color:"#4ade80", text:"PASTEBIMAS SKAUSMAS, NEKELIANTIS NEPATOGUMÅ²" },

  { n: 3,  emoji:"ğŸ™‚", color:"#86efac", text:"SKAUSMAS, KURIS KARTAIS NELEIDÅ½IA SUSIKAUPTI" },
  { n: 4,  emoji:"ğŸ˜", color:"#facc15", text:"SKAUSMAS, KURIS NELEIDÅ½IA SUSIKAUPTI" },
  { n: 5,  emoji:"ğŸ˜", color:"#fbbf24", text:"SKAUSMAS, KURIS TRUKDO VEIKLOMS" },

  { n: 6,  emoji:"ğŸ˜", color:"#f59e0b", text:"SUNKU IGNORUOTI SKAUSMÄ„" },
  { n: 7,  emoji:"ğŸ˜£", color:"#fb7185", text:"SUNKU SUSIKAUPTI DÄ–L SKAUSMO" },
  { n: 8,  emoji:"ğŸ˜£", color:"#f43f5e", text:"DÄ–L SKAUSMO SUNKU KÄ„ NORS DARYTI" },

  { n: 9,  emoji:"ğŸ˜­", color:"#ef4444", text:"NEPAKELIAMAS SKAUSMAS, NIEKO NEÄ®MANOMA DARYTI" },
  { n: 10, emoji:"ğŸ˜­", color:"#b91c1c", text:"DIDÅ½IAUSIAS SKAUSMAS, NIEKAS DAUGIAU NERÅªPI" }
];

/* =========================================================
   3) DVPRS MODAL
========================================================= */
function openDvprs(){
  $('dvprsModal')?.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}
function closeDvprs(){
  $('dvprsModal')?.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
}
function setPainFromDvprs(n){
  $('skausmas').value='taip';
  $('skausmoLygis').value=String(n);
  $('skausmoLygis').toggleAttribute('required', true);
  closeDvprs();
  $('skausmas_section')?.scrollIntoView({behavior:'smooth', block:'start'});
}

function renderDvprs(){
  const grid = $('dvprsGrid');
  if(!grid) return;

  grid.innerHTML = dvprs.map(item => `
    <button
      type="button"
      class="dvprsCard"
      style="--dvprsColor:${item.color}"
      onclick="setPainFromDvprs(${item.n})"
      aria-label="Skausmo lygis ${item.n} iÅ¡ 10"
    >
      <div class="dvprsBar" style="background-color:${item.color}"></div>

      <div class="dvprsTop">
        <div class="dvprsLeft">
          <div class="dvprsEmoji" aria-hidden="true">${item.emoji}</div>
          <div class="dvprsNum">${item.n}</div>
        </div>
        <div class="dvprsTag">${item.n}/10</div>
      </div>

      <div class="dvprsText">${escapeHtml(item.text)}</div>
    </button>
  `).join("");
}


/* =========================================================
   4) INIT / EVENTAI
========================================================= */
onReady(() => {
  $('zaizdos')?.addEventListener('change', e => { $('zaizdos_aprasymas').style.display = e.target.value === 'yra' ? 'block' : 'none'; });
  $('skausmas')?.addEventListener('change', e => { $('skausmoLygis')?.toggleAttribute('required', e.target.value === 'taip'); });
  $('resetBtn')?.addEventListener('click', resetForm);
  $('dieta_kodas')?.addEventListener('change', () => { $('dieta_kita_wrap').style.display = ($('dieta_kodas').value === 'KITA') ? 'block' : 'none'; });
  // --- Discharge UI (pacientas vyksta namo) ---
  function fillDischargeTemplates(){
    const sel = $('rekomTemplate');
    if(!sel) return;

    // paliekam tik pirmÄ… "â€” pasirinkti â€”"
    [...sel.querySelectorAll('option')].slice(1).forEach(o => o.remove());

    if(!Array.isArray(DISCHARGE_TEMPLATES)) return;
    DISCHARGE_TEMPLATES.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    });
  }

  function toggleDischargeUI(){
    const going = $('vykstaNamo')?.checked === true;
    const box = $('namoBox');
    if(box) box.style.display = going ? 'block' : 'none';
  }

  fillDischargeTemplates();
  toggleDischargeUI();
  $('vykstaNamo')?.addEventListener('change', toggleDischargeUI);


  renderDvprs();
  $('openDvprsBtn')?.addEventListener('click', openDvprs);
  $('dvprsCloseBtn')?.addEventListener('click', closeDvprs);
  $('dvprsCancelBtn')?.addEventListener('click', closeDvprs);
  $('dvprsCloseBackdrop')?.addEventListener('click', closeDvprs);

  document.addEventListener('keydown', (e) => { if(e.key==='Escape' && $('dvprsModal')?.getAttribute('aria-hidden')==='false') closeDvprs(); });
});

/* =========================================================
   5) ATPAÅ½INIMAS (EDIT HERE #3)
========================================================= */
function detectProblems(f){
  const esamos=[], galimos=[], pills=[];
  const spo2=toNum(f['saturacija'].value);
  const temp=toNum(f['temperatura'].value);
  const sys=toNum(f['sistolinis'].value);
  const dia=toNum(f['diastolinis'].value);
  const hr =toNum(f['pulsas'].value);
  const map=calcMAP(sys,dia);
  const highSys30=(sys!=null && sys>THRESHOLDS.sysVeryHigh_30min);

  // SpO2
  if(spo2!=null){
    if(spo2<THRESHOLDS.spo2Critical){ esamos.push("Neefektyvi dujÅ³ apykaita"); pills.push(classifyPill(`SpOâ‚‚ ${spo2}% (kritiÅ¡kai Å¾ema)`,"bad")); }
    else if(spo2<THRESHOLDS.spo2Warn){ esamos.push("Neefektyvi dujÅ³ apykaita"); pills.push(classifyPill(`SpOâ‚‚ ${spo2}% (Å¾ema)`,"warn")); }
    else pills.push(classifyPill(`SpOâ‚‚ ${spo2}%`,"ok"));
  }

  // TemperatÅ«ra
  if(temp!=null){
    if(temp>=THRESHOLDS.tempFever){ esamos.push("PadidÄ—jusi temperatÅ«ra"); pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (karÅ¡Äiavimas)`,"warn")); }
    else if(temp>=THRESHOLDS.tempSubfebrile){ esamos.push("PadidÄ—jusi temperatÅ«ra"); pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (subfebrilus)`,"warn")); }
    else if(temp<THRESHOLDS.tempHypothermia){ esamos.push("Hipotermija"); pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (Å¾ema)`,"warn")); }
    else pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C`,"ok"));
  }

  // Pulsas
  if(hr!=null){
    if(hr>THRESHOLDS.hrTachy){ esamos.push("Tachikardija"); pills.push(classifyPill(`Pulsas ${hr}/min (tachikardija)`,"warn")); }
    else if(hr<THRESHOLDS.hrBrady){ esamos.push("Bradikardija"); pills.push(classifyPill(`Pulsas ${hr}/min (bradikardija)`,"warn")); }
    else pills.push(classifyPill(`Pulsas ${hr}/min`,"ok"));
  }

  // Tracheostoma / sekretas / siurbimas
  if(f['trach'].value==='taip' || f['sekretas_trach'].value==='taip' || f['siurbimas'].value==='taip') esamos.push("KvÄ—pavimo takai su tracheostominiu vamzdÅ¾iu");

  // Nosis / dusulys
  if(f['nosis'].value==='tamponuota'){ esamos.push("Tamponuota nosis"); galimos.push("SutrikÄ™s miegas"); }
  else if(f['nosis'].value==='istraukti'){ esamos.push("Nedidelis kraujavimas iÅ¡ nosies"); }
  if(f['dusulys'].value==='taip') esamos.push("Sutrikusi kvÄ—pavimo funkcija (dusulys)");

  // AKS
  if(sys!=null&&dia!=null){
    if(sys<THRESHOLDS.sysLow || (map!=null && map<THRESHOLDS.mapLow)) esamos.push("PaÅ¾emÄ—jÄ™s kraujo spaudimas");
    if(sys>=THRESHOLDS.sysHigh || dia>=THRESHOLDS.diaHigh) esamos.push("PadidÄ—jÄ™s kraujo spaudimas");
  }
  if(map!=null) pills.push(classifyPill(`MAP ${map} mmHg`, (map<THRESHOLDS.mapLow)?"bad":(map<(THRESHOLDS.mapLow+10))?"warn":"ok"));
  if(sys!=null&&dia!=null) pills.push(classifyPill(`AKS ${sys}/${dia} mmHg`, (sys>=THRESHOLDS.sysHigh||dia>=THRESHOLDS.diaHigh)?"warn":(sys<THRESHOLDS.sysLow)?"warn":"ok"));
  if(highSys30) pills.push(classifyPill(`SYS ${sys} mmHg (>165) â€“ kas 30 min.`,"warn"));

  // Mityba
  const m=f['mityba'].value;
  const rij=f['rijimas'].value;      // "taip"/"ne"
  const suvalgo=f['suvalgo'].value;  // "taip"/"ne"

  if(m==='burna'){
    if(rij==='taip'){
      esamos.push("Rijimo sutrikimas / aspiracijos rizika");
    } else if(suvalgo!=='taip'){
      esamos.push("SumaÅ¾Ä—jÄ™s suvartojamo maisto kiekis");
    }
  } else if(m==='zondas'){
    esamos.push("Mityba per zondÄ… (NG)");
  } else if(m==='peg'){
    esamos.push("Mityba per PEG");
  }

  // Å alinimas
  if(f['kateteris'].value==='yra') esamos.push("Å lapimo kateteris");
  if(f['viduriai'].value==='taip') esamos.push("ViduriÅ³ uÅ¾kietÄ—jimas");
  if(f['viduriavimas'].value==='taip') esamos.push("Viduriavimas");

  // Miegas
  if(f['miegas'] && f['miegas'].value==='sutrikusi') esamos.push("SutrikÄ™s miegas");

  // JudÄ—jimas / pragulos / griuvimai
  const bedRest=(f['mobilumas'].value==='lova');
  const needHelp=(f['mobilumas'].value==='pagalba');
  const hasPressureUlcer=(f['pragulos'].value==='yra');

  if(needHelp){
    esamos.push("JudÄ—jimas su pagalba");
    galimos.push("Rizika griuvimui dÄ—l pagalbos poreikio");
  } else if(bedRest){
    galimos.push("Rizika praguloms dÄ—l lovos reÅ¾imo");
  }
  if(hasPressureUlcer) esamos.push("Pragulos");

  // Oda (Å¾aizda)
  if(f['zaizdos'].value==='yra'){ const apr=(f['zaizdos_text'].value||'').trim(); esamos.push("Odos vientisumo paÅ¾eidimas (Å¾aizda)"+(apr?(" â€“ "+apr):"")); }

  // NAUJA: galvos svaigimas
  const headSpin = (f['galvos_svaigimas']?.value === 'taip');
  let addExtrasForHelpDueToDizziness = false;
  if(headSpin){
    galimos.push("Rizika griuvimui dÄ—l galvos svaigimo");
    if(needHelp){
      // jei â€su pagalbaâ€œ + svaigimas â†’ papildome â€JudÄ—jimas su pagalbaâ€œ planÄ…
      addExtrasForHelpDueToDizziness = true;
    }
  }

  // Skausmas â€“ esamose problemose tik â€Skausmas N/10â€œ
  let painBlock=null;
  if(f['skausmas'].value==='taip'){
    const val=toNum(f['skausmoLygis'].value);
    if(val==null || val<0 || val>10){ alert("Ä®veskite skausmo intensyvumÄ… (0â€“10)."); $('skausmoLygis').focus(); return {error:true}; }
    esamos.push(`Skausmas ${val}/10`);
    let key=null;
    if(val>=1 && val<=3) key="Nedidelis skausmas (1â€“3/10)";
    else if(val>=4 && val<=6) key="Vidutinis skausmas (4â€“6/10)";
    else if(val>=7 && val<=10) key="Didelis skausmas (7â€“10/10)";
    const sev = val>=7 ? "bad" : val>=4 ? "warn" : "ok";
    pills.push(classifyPill(`Skausmas ${val}/10`, sev));
    if(key){ painBlock={ score:val, items:(slaugosPlanas[key]||[]) }; }
  }

  // Kraujavimo rizika
  if(f['kraujavimo_rizika'].value==='yra') galimos.push("Kraujavimo rizika");

  return { error:false, esamos, galimos, pills, vitals:{spo2,temp,sys,dia,hr,map}, highSys30, painBlock, addExtrasForHelpDueToDizziness };
}

/* =========================================================
   6) OUTPUT / HTML / Ä®RAÅ AS  (EDIT HERE #4)
========================================================= */
let lastPayload=null;

function renderOutput(f, ctx){
  const { esamos, galimos, pills, vitals, highSys30, painBlock, addExtrasForHelpDueToDizziness } = ctx;
  const { spo2, temp, sys, dia, hr, map } = vitals;

  const esamosU=uniq(esamos).sort();
  const galimosU=uniq(galimos).sort();

  const combineBedRestAndUlcers=(f['mobilumas']?.value==='lova' && f['pragulos']?.value==='yra');

  const pb_ramus=$('ramus')?.checked;
  const pb_orient=$('orientuotas')?.checked;
  const psichoTekstas = `${pb_ramus?'ramus':'neramus'}, ${pb_orient?'orientuotas':'neorientuotas'}`;
  // ===== IÅ RAÅ YMAS Ä® NAMUS =====
  const goingHome = $('vykstaNamo')?.checked === true;
  if(goingHome){
    const tId = $('rekomTemplate')?.value || '';
    if(!tId){
      alert("Pasirinkite rekomendacijÅ³ Å¡ablonÄ… (RekomendacijÅ³ Å¡ablonas).");
      $('rekomTemplate')?.focus?.();
      return;
    }
    const tpl = Array.isArray(DISCHARGE_TEMPLATES)
      ? DISCHARGE_TEMPLATES.find(x => x.id === tId)
      : null;

    if(!tpl){
      alert("Nerastas rekomendacijÅ³ Å¡ablonas. Pasirinkite iÅ¡ sÄ…raÅ¡o dar kartÄ….");
      return;
    }

    const aksStr = (sys!=null && dia!=null)
      ? `${sys} / ${dia} mmHg${map!=null?` (MAP ${map})`:''}`
      : '-';

    // HTML
    let html = "";
    html += `<h3>Ä®vesti gyvybiniai rodikliai</h3>
      <p><strong>SpOâ‚‚:</strong> ${valOrDash(spo2)} %<br>
      <strong>AKS:</strong> ${aksStr}<br>
      <strong>Å SD:</strong> ${valOrDash(hr)} / min<br>
      <strong>TemperatÅ«ra:</strong> ${temp!=null?temp.toFixed(1):"-"} Â°C</p>
      <p><strong>Pacientas:</strong> ${escapeHtml(psichoTekstas)}</p>`;

    html += `<p><strong>Pacientas vyksta namo, iÅ¡trauktas intraveninis kateteris.</strong></p>`;
    html += `<h3>Pacientui rekomenduota</h3><ul>${
      tpl.items.map(it=>`<li>${escapeHtml(it)}</li>`).join("")
    }</ul>`;

    // Ä®raÅ¡as Ä¯ Sheets
    const gyvybiniai = vitalsText(spo2,sys,dia,map,hr,temp);
    let irasas =
      `Gyvybiniai rodikliai:\n${gyvybiniai}\n\n`+
      `Pacientas: ${psichoTekstas}\n`+
      `Pacientas vyksta namo, iÅ¡trauktas intraveninis kateteris.\n\n`+
      `Pacientui rekomenduota:\n` +
      tpl.items.map(i=>"â€¢ "+i).join("\n");

    lastPayload={
      "Laikas": new Date().toLocaleString('lt-LT'),
      "palata": (f['palata'].value||"").trim(),
      "lova":   (f['lova'].value||"").trim(),
      "Ä¯raÅ¡as": irasas
    };

    $('results').innerHTML = html;
    $('results').insertAdjacentHTML('beforeend', `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`);
    return;
  }


  const isRestrained = $('suvarzymas')?.checked===true;
  const nowTime = new Date().toLocaleTimeString('lt-LT',{hour:'2-digit',minute:'2-digit'});
  const restraintSentence = isRestrained ? `DÄ—l galimos Å¾alos sau paÄiam ir aplinkiniams, neveikiant kitoms priemonÄ—ms pacientas fiksuotas (${nowTime}).` : "";

  // Pirminis vertinimas
  const pvPlanSets={
    cv:["AKS sekimas","SkysÄiÅ³ balanso stebÄ—jimas","EdemÅ³ stebÄ—jimas","Dusulio stebÄ—jimas","Mitybos/dietos pritaikymas"],
    resp:["SpOâ‚‚ stebÄ—jimas"],
    endo:["Glikemijos kontrolÄ—","Mitybos/dietos pritaikymas"],
    rh:["SkysÄiÅ³ balanso stebÄ—jimas","SkysÄiÅ³ kiekio sekimas","AKS sekimas"]
  };
  const pvSelected=[], pvExtraItems=[];
  if($('pv_cv')?.checked){ pvSelected.push("Å irdiesâ€“kraujotakos"); pvExtraItems.push(...pvPlanSets.cv); }
  if($('pv_resp')?.checked){ pvSelected.push("KvÄ—pavimo"); pvExtraItems.push(...pvPlanSets.resp); }
  if($('pv_endo_cd')?.checked){ pvSelected.push("EndokrininÄ—s (CD)"); pvExtraItems.push(...pvPlanSets.endo); }
  if($('pv_renal_hep')?.checked){ pvSelected.push("InkstÅ³/kepenÅ³"); pvExtraItems.push(...pvPlanSets.rh); }
  const pvInfection=($('pv_infection')?.value||'').trim();
  const pvAllergy=($('pv_allergy')?.value||'').trim();
  const pvSummaryParts=[];
  if(pvSelected.length) pvSummaryParts.push("Sritys: "+pvSelected.join(", "));
  if(pvInfection) pvSummaryParts.push("InfekcinÄ—s ligos: "+pvInfection);
  if(pvAllergy) pvSummaryParts.push("Alergijos: "+pvAllergy);
  const pvSummaryText=pvSummaryParts.join(" | ");

  // Dieta
  const dietCode=($('dieta_kodas')?.value||'').trim();
  const dietCustom=(dietCode==='KITA')?(($('dieta_kita')?.value||'').trim()):'';
  const hasDiet=(dietCode && dietCode!=='KITA') || (dietCode==='KITA' && dietCustom);

  // HTML
  let html="";
  if(pills.length) html+=`<div class="hint"><strong>Greita santrauka:</strong> ${pills.join(" ")}</div>`;

  html+=`<h3>Esamos problemos</h3><ul>${esamosU.length?esamosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>NepastebÄ—ta</li>"}</ul>`;
  html+=`<h3>Galimos problemos</h3><ul>${galimosU.length?galimosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>NepastebÄ—ta</li>"}</ul>`;

  html+=`<h3>Slaugos planas</h3>`;

  // 1) Kombinuotas planas (jei reikia)
  if(combineBedRestAndUlcers){
    const key="Gulimas reÅ¾imas ir pragulos";
    const items=slaugosPlanas[key]||[];
    if(items.length){
      html+=`<div class="planas"><h4>${escapeHtml(key)}</h4><ul>${items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
    }
  }

  // 2) Kiti planai (be dubliÅ³)
  [...esamosU, ...galimosU].forEach(p=>{
    if(combineBedRestAndUlcers){
      if(p==="Pragulos") return;
      if(p==="Rizika praguloms dÄ—l lovos reÅ¾imo") return;
    }
    // jei yra â€su pagalba + svaigimasâ€œ â€” NEgeneruojam atskiro â€Rizika griuvimui dÄ—l galvos svaigimoâ€œ plano,
    // nes papildysime â€JudÄ—jimas su pagalbaâ€œ planÄ…
    if(addExtrasForHelpDueToDizziness && p==="Rizika griuvimui dÄ—l galvos svaigimo") return;

    const key=Object.keys(slaugosPlanas).find(k=>p.startsWith(k));
    if(!key) return;
    const items=[...(slaugosPlanas[key]||[])];

    // Esant aukÅ¡tam SYS >165 â€” pridÄ—ti kas 30 min
    if(p.startsWith("PadidÄ—jÄ™s kraujo spaudimas") && highSys30){ items.push("AKS sekimas kas 30 min."); }

    // NAUJA: jei â€JudÄ—jimas su pagalbaâ€œ + svaigimas â€” pridedam du papildomus punktus
    if(addExtrasForHelpDueToDizziness && p==="JudÄ—jimas su pagalba"){
      items.push("AKS sekimas");
      items.push("GriuvimÅ³ profilaktika");
    }

    html+=`<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
  });

  // 3) Skausmo planas (tik iÅ¡ intervalÅ³, bet antraÅ¡tÄ— su N/10)
  if(painBlock && painBlock.items.length){
    html+=`<div class="planas"><h4>Skausmas (${painBlock.score}/10)</h4><ul>${painBlock.items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
  }

  // 4) Dietos planas
  const dietItems=(dietCode && dietCode!=='KITA')?(dietPlan[dietCode]||[]):[];
  if(dietItems.length){
    html+=`<div class="planas"><h4>Dieta: ${escapeHtml(dietCode)}</h4><ul>${dietItems.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
  }

  // 5) SuvarÅ¾ymas
  if(isRestrained){
    html+=`<div class="planas"><h4>Fizinis suvarÅ¾ymas</h4><ul>${restraintPlan.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
  }

  // 6) Pirminio vertinimo papildomos intervencijos
  if(pvExtraItems.length){
    const extra=uniq(pvExtraItems);
    html+=`<div class="planas"><h4>Pirminis vertinimas: papildomos intervencijos</h4><ul>${extra.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
  }

  const aksStr=(sys!=null&&dia!=null)?`${sys} / ${dia} mmHg${map!=null?` (MAP ${map})`:''}`:'-';
  html+=`<h3>Ä®vesti gyvybiniai rodikliai</h3>
  <p><strong>SpOâ‚‚:</strong> ${valOrDash(spo2)} %<br>
  <strong>AKS:</strong> ${aksStr}<br>
  <strong>Å SD:</strong> ${valOrDash(hr)} / min<br>
  <strong>TemperatÅ«ra:</strong> ${temp!=null?Number(temp).toFixed(1):"-"} Â°C</p>
  <p><strong>Pacientas:</strong> ${escapeHtml(psichoTekstas)}</p>`;
  const news = calcNEWS2({
  rr: toNum(f['rr']?.value),
  spo2,
  onO2: f['o2']?.value === 'taip',
  temp,
  sys,
  hr,
  avpu: f['avpu']?.value
});

html += `<p><strong>Ankstyvojo perspÄ—jimo skalÄ— (NEWS2):</strong> ${news.score} balai â€“ ${news2Text(news.score, news.hasCritical)}</p>`;

  if(restraintSentence) html+=`<p>${escapeHtml(restraintSentence)}</p>`;
  if(hasDiet){
    const dietaUi=(dietCode==='KITA')?dietCustom:dietCode;
    html+=`<p><strong>Pacientui skirta:</strong> ${escapeHtml(dietaUi)} dieta</p>`;
  }
  html+=`<p><strong>Pirminis vertinimas:</strong> ${escapeHtml(pvSummaryText || "â€”")}</p>`;
  $('results').innerHTML=html;

  /* â€”â€”â€” Ä®RAÅ AS LIS/Sheets (viena eilutÄ—, 4 stulpeliai) â€”â€”â€” */
  const seenPlan=new Set(); const planItems=[];

  if(combineBedRestAndUlcers){
    const key="Gulimas reÅ¾imas ir pragulos";
    (slaugosPlanas[key]||[]).forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }

  [...esamosU, ...galimosU].forEach(p=>{
    if(combineBedRestAndUlcers){
      if(p==="Pragulos") return;
      if(p==="Rizika praguloms dÄ—l lovos reÅ¾imo") return;
    }
    if(addExtrasForHelpDueToDizziness && p==="Rizika griuvimui dÄ—l galvos svaigimo") return;
    const key=Object.keys(slaugosPlanas).find(k=>p.startsWith(k));
    if(!key) return;
    (slaugosPlanas[key]||[]).forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
    if(p.startsWith("PadidÄ—jÄ™s kraujo spaudimas") && highSys30){
      const it="AKS sekimas kas 30 min."; if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    }
    if(addExtrasForHelpDueToDizziness && p==="JudÄ—jimas su pagalba"){
      ["AKS sekimas","GriuvimÅ³ profilaktika"].forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
    }
  });

  if(painBlock && painBlock.items.length){
    painBlock.items.forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }
  if(dietCode && dietCode!=='KITA'){
    (dietPlan[dietCode]||[]).forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }
  if(isRestrained){ restraintPlan.forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } }); }
  if(pvExtraItems.length){ uniq(pvExtraItems).forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } }); }

  const planasText = planItems.length ? planItems.map(i=>"â€¢ "+i).join("\n") : "-";
  const gyvybiniai=vitalsText(spo2,sys,dia,map,hr,temp);
  const slaugosProb=esamosU.length?esamosU.join('; '):'-';
  const galimosProb=galimosU.length?galimosU.join('; '):'-';

let irasas =
  `Gyvybiniai rodikliai:\n${gyvybiniai}\n\n`+
  `Pacientas: ${psichoTekstas}\n`;

if(restraintSentence) irasas += `${restraintSentence}\n`;

irasas += `\nAnkstyvojo perspÄ—jimo skalÄ— (NEWS2): ${news.score} balai â€“ ${news2Text(news.score, news.hasCritical)}\n\n`;

if(hasDiet){
  const dietaNote = (dietCode==='KITA') ? dietCustom : dietCode;
  irasas += `Pacientui skirta: ${dietaNote} dieta\n\n`;
}

irasas +=
  `Pirminis vertinimas:\n${pvSummaryText || "â€”"}\n\n`+
  `Slaugos problemos:\n${slaugosProb}\n\n`+
  `Galimos problemos:\n${galimosProb}\n\n`+
  `Slaugos planas:\n${planasText}`;

  lastPayload={
    "Laikas": new Date().toLocaleString('lt-LT'),
    "palata": (f['palata'].value||"").trim(),
    "lova":   (f['lova'].value||"").trim(),
    "Ä¯raÅ¡as": irasas
  };

  $('results').insertAdjacentHTML('beforeend', `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`);
}

/* =========================================================
   7) MAIN
========================================================= */
function generateResults(){
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';
  const f=document.forms['nursingForm'];
  const ctx=detectProblems(f);
  if(ctx.error) return;
  renderOutput(f, ctx);
}

/* =========================================================
   8) SIUNTIMAS / RESET
========================================================= */
function keltiISistema(){
  if(!lastPayload){ alert("Pirmiausia paspauskite â€Generuotiâ€œ."); return; }
  const url=(GOOGLE_SCRIPT_URL||'').trim();
  if(!url || !url.endsWith('/exec')){ alert("Patikrinkite WebApp URL â€“ turi baigtis /exec."); return; }
  fetch(url,{ method:"POST", headers:{"Content-Type":"text/plain"}, body:JSON.stringify(lastPayload), mode:"no-cors" })
    .then(()=>{ $('statusErr').style.display='none'; $('statusOk').style.display='block'; })
    .catch(()=>{ $('statusOk').style.display='none'; $('statusErr').style.display='block'; });
}

function resetForm(){
  $('nursingForm')?.reset();
  if($('results')) $('results').innerHTML = "";
  if($('statusOk')) $('statusOk').style.display='none';
  if($('statusErr')) $('statusErr').style.display='none';
  if($('zaizdos_aprasymas')) $('zaizdos_aprasymas').style.display='none';
  if($('dieta_kita_wrap')) $('dieta_kita_wrap').style.display='none';
  if(typeof closeDvprs === "function") closeDvprs();

  // discharge UI reset (saugiai)
  const vn = $('vykstaNamo');
  if(vn) vn.checked = false;

  const box = $('namoBox');
  if(box) box.style.display = 'none';

  const sel = $('rekomTemplate');
  if(sel) sel.value = "";

  lastPayload = null;
}

</script>

</body>
</html>
