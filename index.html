<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paciento vertinimas ir slaugos planas</title>
<style>
  :root{--bg:#f7f8fa;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:auto;padding:20px;background:var(--bg);color:#111}
  h1{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
  .section{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px}
  .section h2{font-size:18px;margin:0 0 10px;padding-bottom:8px;border-bottom:1px dashed var(--line)}
  label{display:block;margin-top:8px;font-weight:600}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hint{font-weight:400;color:var(--muted);font-size:12px}
  select,input,textarea{padding:10px;border:1px solid var(--line);border-radius:8px;width:100%;margin-top:6px;background:#fff}
  textarea{min-height:84px;resize:vertical}
  .checks{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
  .checks label{display:flex;align-items:center;font-weight:500;margin:0}
  .checks input{margin-right:8px;width:auto}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  button{padding:10px 14px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  button.secondary{background:#fff;color:#111;border:1px solid var(--line)}
  button.good{background:var(--ok)}
  .results{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-top:18px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin:3px 6px 0 0;background:#fff}
  .pill.ok{border-color:#16a34a33;background:#16a34a18}
  .pill.warn{border-color:#f59e0b33;background:#f59e0b18}
  .pill.bad{border-color:#dc262633;background:#dc262618}
  .planas{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px;background:#fff}
  .planas h4{margin:0 0 8px}
  .status{padding:10px;border-radius:10px;margin-top:10px;display:none}
  .status.ok{display:block;background:#ecfdf5;border:1px solid #86efac;color:#065f46}
  .status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:12px;margin-top:12px;overflow:auto}
  details.pv summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-weight:700;padding:4px 0}
  details.pv summary::-webkit-details-marker{display:none}
  details.pv summary::after{content:"▸";transition:transform .2s ease;font-weight:400}
  details.pv[open] summary::after{transform:rotate(90deg)}
  details.pv .pv-content{margin-top:10px}
</style>
</head>
<body>
<h1>Paciento vertinimas ir slaugos planas</h1>

<form id="nursingForm" novalidate>
  <div class="grid">
    <!-- IDENTIFIKACIJA -->
    <div class="section">
      <h2>Identifikacija</h2>
      <label for="palata">Palata
        <input id="palata" name="palata" autocomplete="off" />
      </label>
      <label for="lova">Lova
        <input id="lova" name="lova" autocomplete="off" />
      </label>
    </div>

    <!-- PACIENTO BŪKLĖ -->
    <div class="section">
      <h2>Paciento būklė</h2>
      <div class="checks">
        <label><input type="checkbox" id="ramus" /> Ramus</label>
        <label><input type="checkbox" id="orientuotas" /> Orientuotas</label>
        <label><input type="checkbox" id="suvarzymas" /> Suvaržymas</label>
      </div>
      <div class="hint">Jei nepažymėta – įrašas bus: „Pacientas: neramus, neorientuotas“.</div>
    </div>

    <!-- KVĖPAVIMO SISTEMA -->
    <div class="section">
      <h2>Kvėpavimo sistema</h2>
      <label for="trach">Tracheostominis vamzdis
        <select id="trach" name="trach">
          <option value="ne">Nėra</option><option value="taip">Yra</option>
        </select>
      </label>

      <div class="row">
        <label for="sekretas_trach">Sekretas / atkosėjimas iš vamzdžio
          <select id="sekretas_trach" name="sekretas_trach">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="siurbimas">Atliekamas siurbimas
          <select id="siurbimas" name="siurbimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="nosis">Nosis
          <select id="nosis" name="nosis">
            <option value="nedaryta">Niekas nedaryta</option>
            <option value="tamponuota">Tamponuota nosis</option>
            <option value="istraukti">Ištraukti tamponai</option>
          </select>
        </label>
        <label for="dusulys">Ar jaučiate dusulį?
          <select id="dusulys" name="dusulys">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="saturacija">Saturacija SpO₂ (%) <span class="hint">(50–100)</span>
          <input type="number" id="saturacija" name="saturacija" min="50" max="100" inputmode="decimal" />
        </label>
        <label for="kosulys">Kosulys
          <select id="kosulys" name="kosulys">
            <option value="nera">Nėra</option><option value="sausas">Sausas</option><option value="dregnas">Drėgnas</option>
          </select>
        </label>
      </div>
    </div>

    <!-- ŠIRDIES IR KRAUJOTAKA -->
    <div class="section">
      <h2>Širdies ir kraujotaka</h2>
      <div class="row">
        <label for="sistolinis">AKS (sistolinis) mmHg <span class="hint">(50–250)</span>
          <input type="number" id="sistolinis" name="sistolinis" min="50" max="250" />
        </label>
        <label for="diastolinis">AKS (diastolinis) mmHg <span class="hint">(20–150)</span>
          <input type="number" id="diastolinis" name="diastolinis" min="20" max="150" />
        </label>
      </div>
      <div class="row">
        <label for="pulsas">Pulsas (bpm) <span class="hint">(30–200)</span>
          <input type="number" id="pulsas" name="pulsas" min="30" max="200" />
        </label>
        <label for="temperatura">Kūno temperatūra (°C) <span class="hint">(30.0–42.0)</span>
          <input type="number" id="temperatura" name="temperatura" step="0.1" min="30" max="42" />
        </label>
      </div>
      <label for="svaigimas">Galvos svaigimas?
        <select id="svaigimas" name="svaigimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- MITYBA -->
    <div class="section">
      <h2>Mityba</h2>
      <div class="row">
        <label for="mityba">Mitybos būdas
          <select id="mityba" name="mityba">
            <option value="burna">Per burną</option>
            <option value="peg">Per PEG</option>
            <option value="zondas">Per zondą</option>
          </select>
        </label>
        <label for="rijimas">Rijimo sutrikimai?
          <select id="rijimas" name="rijimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>
      <label for="suvalgo">Ar suvalgo visą maistą?
        <select id="suvalgo" name="suvalgo">
          <option value="taip">Taip</option>
          <option value="dalis">Dalis</option>
          <option value="ne">Ne</option>
        </select>
      </label>
    </div>

    <!-- DIETA -->
    <div class="section">
      <h2>Dieta</h2>
      <label for="dieta_kodas">Pasirinkite dietą</label>
      <select id="dieta_kodas" name="dieta_kodas">
        <option value="">— Pasirinkite —</option>
        <option value="P1">P1 (Įprasta)</option>
        <option value="PTM">PTM (Minkštinta)</option>
        <option value="TM">TM (Tarkuota/trinta)</option>
        <option value="SM">SM (Skysto/enterinis)</option>
        <option value="CD">CD (Diabeto)</option>
        <option value="PTM-CD">PTM - CD (Minkštinta + CD)</option>
        <option value="NPB">NPB (Nieko per burną)</option>
        <option value="P4">P4 (Vegetarinė)</option>
        <option value="Na">Na (Mažiau natrio)</option>
        <option value="B">B (Baltyminė)</option>
        <option value="Lac">Lac (Be laktozės)</option>
        <option value="Sk(padid.)">Sk(padid.) (Daugiau skaidulų)</option>
        <option value="Sk(maž.)">Sk(maž.) (Mažiau skaidulų)</option>
        <option value="KITA">Kita…</option>
      </select>

      <div id="dieta_kita_wrap" style="display:none; margin-top:10px">
        <label for="dieta_kita">Įrašykite dietą ranka</label>
        <input id="dieta_kita" placeholder="pvz., be glitimo, be kiaušinių..." />
        <div class="hint">„Kita“ – plane nieko nepridėsime, tik konstatuosime dietą įraše.</div>
      </div>
    </div>

    <!-- ŠALINIMAS -->
    <div class="section">
      <h2>Šalinimas</h2>
      <div class="row">
        <label for="kateteris">Šlapimo kateteris
          <select id="kateteris" name="kateteris">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="viduriai">Vidurių užkietėjimas?
          <select id="viduriai" name="viduriai">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>
      <label for="viduriavimas">Viduriavimas?
        <select id="viduriavimas" name="viduriavimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- JUDĖJIMAS -->
    <div class="section">
      <h2>Judėjimas</h2>
      <label for="mobilumas">Mobilumas
        <select id="mobilumas" name="mobilumas">
          <option value="sav">Savarankiškas</option>
          <option value="pagalba">Su pagalba</option>
          <option value="lova">Lovos režimas</option>
        </select>
      </label>
    </div>

    <!-- MIEGAS -->
    <div class="section">
      <h2>Miegas</h2>
      <label for="miegas">Miego kokybė
        <select id="miegas" name="miegas">
          <option value="gera">Gera</option>
          <option value="sutrikusi">Sutrikusi</option>
        </select>
      </label>
    </div>

    <!-- ODA -->
    <div class="section">
      <h2>Oda</h2>
      <div class="row">
        <label for="pragulos">Pragulos
          <select id="pragulos" name="pragulos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="zaizdos">Žaizdos
          <select id="zaizdos" name="zaizdos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
      </div>
      <div id="zaizdos_aprasymas" style="display:none;">
        <label for="zaizdos_text">Žaizdos aprašymas
          <textarea id="zaizdos_text" name="zaizdos_text" placeholder="Lokalizacija, dydis, sekrecija, paraudimas, skausmingumas..."></textarea>
        </label>
      </div>
    </div>

    <!-- SKAUSMAS -->
    <div class="section">
      <h2>Skausmas</h2>
      <div class="row">
        <label for="skausmas">Ar yra skausmas?
          <select id="skausmas" name="skausmas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="skausmoLygis">Intensyvumas (0–10)
          <input type="number" id="skausmoLygis" name="skausmoLygis" min="0" max="10" />
        </label>
      </div>
      <div class="hint">Jei „Yra skausmas“, įveskite skaičių 0–10 (NRS).</div>
    </div>

    <!-- KRAUJAVIMO RIZIKA -->
    <div class="section">
      <h2>Kraujavimo rizika</h2>
      <label for="kraujavimo_rizika">Kraujavimo rizika?
        <select id="kraujavimo_rizika" name="kraujavimo_rizika">
          <option value="nera">Nėra</option>
          <option value="yra">Yra</option>
        </select>
      </label>
      <div class="hint">Jei „Yra“ – „Galimose problemose“ atsiras „Kraujavimo rizika“, plane: „Stebėjimas dėl galimo kraujavimo“, „AKS sekimas“.</div>
    </div>

    <!-- PIRMINIS VERTINIMAS -->
    <div class="section" style="grid-column:1 / -1">
      <details class="pv" id="pv_section">
        <summary>Pirminis vertinimas <span class="hint">(spustelėkite)</span></summary>
        <div class="pv-content">
          <div class="checks" style="margin-top:6px">
            <label><input type="checkbox" id="pv_cv"> Širdies–kraujotakos</label>
            <label><input type="checkbox" id="pv_resp"> Kvėpavimo</label>
            <label><input type="checkbox" id="pv_endo_cd"> Endokrininės (CD)</label>
            <label><input type="checkbox" id="pv_renal_hep"> Inkstų/kepenų</label>
          </div>
          <label style="margin-top:10px">Infekcinės ligos (įrašykite)
            <input id="pv_infection" placeholder="pvz., MRSA, C. difficile, TB, COVID..." />
          </label>
          <label style="margin-top:10px">Alergijos
            <textarea id="pv_allergy" rows="2" placeholder="pvz., penicilinai, lateksas, maistas..."></textarea>
          </label>
          <div class="hint" style="margin-top:6px">
            Pažymėtos sritys automatiškai pridės atitinkamas intervencijas prie bendro slaugos plano.
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="actions">
    <button type="button" id="genBtn" onclick="generateResults()">Generuoti</button>
    <button type="button" id="resetBtn" class="secondary">Naujas pacientas</button>
    <button type="button" class="good" onclick="keltiISistema()">Kelti į sistemą</button>
  </div>
</form>

<div id="results" class="results" aria-live="polite"></div>
<div id="statusOk" class="status ok">✅ Duomenys įkelti sėkmingai.</div>
<div id="statusErr" class="status err">❌ Klaida siunčiant į Google Sheets. Patikrinkite WebApp adresą ir leidimus.</div>

<script>
/* ——— BENDRI ——— */
const $ = (id) => document.getElementById(id);
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
onReady(() => {
  $('zaizdos')?.addEventListener('change', e => { $('zaizdos_aprasymas').style.display = e.target.value === 'yra' ? 'block' : 'none'; });
  $('skausmas')?.addEventListener('change', e => { $('skausmoLygis')?.toggleAttribute('required', e.target.value === 'taip'); });
  $('resetBtn')?.addEventListener('click', resetForm);
  $('dieta_kodas')?.addEventListener('change', () => {
    $('dieta_kita_wrap').style.display = ($('dieta_kodas').value === 'KITA') ? 'block' : 'none';
  });
});

/* ——— ĮKLIJUOK SAVO WebApp /exec URL ——— */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxODAbmdrmccCYCUkswsFgnz-nrC8clEQQf-5kId3y-3TCqUwsU4pyCze2Jojv43VV_1A/exec";

/* ——— PLANŲ ŽEMĖLAPIS ——— */
const slaugosPlanas = {
  "Kvėpavimo takai su tracheostominiu vamzdžiu": [
    "Savalaikis atsiurbimas iš tracheostominio vamzdelio",
    "Vamzdelio drėkinimas",
    "Palatos oro drėkinimas",
    "Sekreto (kiekio/spalvos/klampumo) vertinimas ir fiksavimas",
    "Stomos priežiūra – tvarsčio keitimas bent 2 kartus per parą",
    "Fiksacijos patikra"
  ],
  "Nedidelis kraujavimas iš nosies": [
    "AKS stebėjimas kraujavimui nestojant",
    "Pacientas apmokintas kaip prižiūrėti nosį kraujavimui sustojus"
  ],
  "Sutrikusi kvėpavimo funkcija (dusulys)": [
    "SpO₂ stebėjimas",
    "Prireikus O₂ skyrimas pagal SpO₂"
  ],
  "Neefektyvi dujų apykaita": [
    "SpO₂ stebėjimas",
    "O₂ skyrimas ir reguliavimas pagal SpO₂ duomenis"
  ],
  "Pažemėjęs kraujo spaudimas": [
    "Patarta neskubėti keltis, pasėdėti nuleidus kojas prieš einant",
    "Stebėjimas dėl galimų griuvimų",
    "AKS matavimas po 1 val."
  ],
  "Padidėjęs kraujo spaudimas": [
    "AKS sekimas kas 4 val."
  ],

  "Sutrikusi mityba per burną": [
    "Stebėjimas dėl aspiracijos",
    "Pagalba valgant",
    "Reikalui esant maisto tirštinimas"
  ],
  "Mityba per zondą (NG)": [
    "Zondo padėties patikra pagal įstaigos protokolą",
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po",
    "Zondo praplovimas prieš ir po maitinimo bei vaistų",
    "Nosies ir odos prie zondo priežiūra, fiksacijos patikra",
    "Stebėti dėl aspiracijos, pykinimo, pilvo pūtimo"
  ],
  "Mityba per PEG": [
    "PEG vietos apžiūra ir tvarsčio keitimas",
    "Praplovimas prieš ir po maitinimo bei vaistų",
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po"
  ],

  "Rizika griuvimui dėl pagalbos poreikio": [
    "Stebėti dėl griuvimų rizikos, kviesti pagalbą judant"
  ],
  "Rizika praguloms dėl lovos režimo": [
    "Padėties keitimas kas 3 val.",
    "Pakišamų indų/sauskelnių naudojimas",
    "Pagalbinių priemonių naudojimas",
    "Odos vientisumo stebėjimas"
  ],
  "Pragulos": [
    "Kūno padėties keitimas kas 3 val.",
    "Pagalbinės priemonės",
    "Pragulos perrišimas pagal žaizdų priežiūros planą"
  ],
  "Odos vientisumo pažeidimas (žaizda)": [
    "Žaizdos perrišimas",
    "Stebėti infekcijos požymius"
  ],

  /* ——— SKAUSMAS (išskirstyta) ——— */
  "Nedidelis skausmas (1–3/10)": [
    "Nefarmakologinis skausmo malšinimas",
    "Pacientui norint – farmakologinis nuskausminimas"
  ],
  "Vidutinis skausmas (4–6/10)": [
    "Savalaikis nuskausminimas pagal gydytojo paskyrimą",
    "Pakartotinis skausmo matavimas po 30 min. po vaistų suleidimo/sudavimo"
  ],
  "Didelis skausmas (7–10/10)": [
    "Skubus nuskausminimas pagal gydytojo paskyrimą",
    "Pakartotinis skausmo matavimas po 15 min."
  ],

  /* ——— ŠALINIMAS (kad kristų į problemas/planą) ——— */
  "Šlapimo kateteris": [
    "Kateterio priežiūra pagal įstaigos protokolą",
    "Stebėti diurezę ir šlapimo pobūdį",
    "Stebėti infekcijos požymius"
  ],
  "Vidurių užkietėjimas": [
    "Stebėti tuštinimąsi",
    "Skysčių/aktyvumo skatinimas pagal būklę",
    "Priemonių taikymas pagal paskyrimą"
  ],
  "Viduriavimas": [
    "Stebėti tuštinimąsi",
    "Odos priežiūra tarpvietėje",
    "Skysčių balanso stebėjimas"
  ],

  "Padidėjusi temperatūra": [
    "Temperatūros stebėjimas"
  ],
  "Hipotermija": [
    "Šilumos palaikymas",
    "Temperatūros stebėjimas"
  ],
  "Kraujavimo rizika": [
    "Stebėjimas dėl galimo kraujavimo",
    "AKS sekimas"
  ]
};

/* ——— DIETŲ PLANO SAKINIAI ——— */
const dietPlan = {
  "P1": [],
  "P4": [],
  "PTM":   ["Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos."],
  "TM":    ["Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos."],
  "SM":    ["Pacientas maitinamas mažais boliusais, lėtai; stebima dėl aspiracijos rizikos."],
  "CD":    ["Sekama glikemija."],
  "PTM-CD":["Stebima, kaip pacientui pavyksta nuryti maistą, bei dėl aspiracijos rizikos; sekama glikemija."],
  "Na":    ["Stebima dėl edemų, pastebėjus – AKS ir skysčių sekimas."],
  "Sk(padid.)": ["Stebima dėl pilvo pūtimo ir tuštinimosi."],
  "Sk(maž.)":   ["Stebima dėl pilvo pūtimo ir tuštinimosi."],
  "B": [],
  "Lac": [],
  "NPB":   ["Pacientas nieko nevalgo ir negeria, kol kitaip nenurodė gydytojas."]
};

/* ——— SUVARCHARŽYMO PUNKTŲ RINKINYS ——— */
const restraintPlan = [
  "Taikoma fizinio suvaržymo priemonės, imobilizuota galūnė atlaisvinama kas 1,5 val. (eHL pildomas paciento, kuriam taikomas fizinio suvaržymo priemonės, stebėjimo lapas)",
  "Stebimos gyvybinės funkcijos",
  "Pragulų profilaktika",
  "Pagalba valgant ir geriant, atliekant asmens higieną, šlapinantis ar tuštinantis"
];

let lastPayload = null;

/* ——— PAGALBINĖS ——— */
function toNum(v){ const n=parseFloat(v); return isFinite(n)?n:null; }
function calcMAP(sys,dia){ if(sys==null||dia==null) return null; return Math.round(((2*dia)+sys)/3); }
function valOrDash(v){ return (v==null||v==="")?"-":v; }
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
function classifyPill(text,severity="ok"){ const cls=severity==="bad"?"pill bad":severity==="warn"?"pill warn":"pill ok"; return `<span class="${cls}">${text}</span>`; }
function vitalsText(spo2,sys,dia,map,hr,temp){
  const aks=(sys!=null&&dia!=null)?`${sys}/${dia} mmHg${map!=null?` (MAP ${map})`:''}`:'-';
  const T=(temp!=null)?`${Number(temp).toFixed(1)} °C`:'-';
  return [`SpO₂: ${spo2!=null?spo2+' %':'-'}`,`AKS: ${aks}`,`ŠSD: ${hr!=null?hr+'/min':'-'}`,`Temperatūra: ${T}`].join('\n');
}

/* ——— PAGRINDINĖ ——— */
function generateResults(){
  $('statusOk').style.display='none'; $('statusErr').style.display='none';
  const f=document.forms['nursingForm'];
  const esamos=[], galimos=[], pills=[];

  const spo2=toNum(f['saturacija'].value);
  const temp=toNum(f['temperatura'].value);
  const sys=toNum(f['sistolinis'].value);
  const dia=toNum(f['diastolinis'].value);
  const hr=toNum(f['pulsas'].value);
  const map=calcMAP(sys,dia);

  const highSys30 = (sys!=null && sys>165); // papildomas plano punktas

  // SpO2: žemiau 95 jau meta "Neefektyvi dujų apykaita"
  if(spo2!=null){
    if(spo2<90){ esamos.push("Neefektyvi dujų apykaita"); pills.push(classifyPill(`SpO₂ ${spo2}% (kritiškai žema)`,"bad")); }
    else if(spo2<95){ esamos.push("Neefektyvi dujų apykaita"); pills.push(classifyPill(`SpO₂ ${spo2}% (žema)`,"warn")); }
    else pills.push(classifyPill(`SpO₂ ${spo2}%`,"ok"));
  }

  // Temperatūra: hipotermija žemiau 35,6
  if(temp!=null){
    if(temp>=38.0){ esamos.push("Padidėjusi temperatūra"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (karščiavimas)`,"warn")); }
    else if(temp>=37.1){ esamos.push("Padidėjusi temperatūra"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (subfebrilus)`,"warn")); }
    else if(temp<35.6){ esamos.push("Hipotermija"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (žema)`,"warn")); }
    else pills.push(classifyPill(`T ${temp.toFixed(1)}°C`,"ok"));
  }

  // Trach: problema turi kristi ir jei sekretas/siurbimas pasirinkta
  if(f['trach'].value==='taip' || f['sekretas_trach'].value==='taip' || f['siurbimas'].value==='taip'){
    esamos.push("Kvėpavimo takai su tracheostominiu vamzdžiu");
  }

  if(f['nosis'].value==='istraukti') esamos.push("Nedidelis kraujavimas iš nosies");
  if(f['dusulys'].value==='taip') esamos.push("Sutrikusi kvėpavimo funkcija (dusulys)");

  if(sys!=null&&dia!=null){
    if(sys<100 || (map!=null && map<65)) esamos.push("Pažemėjęs kraujo spaudimas");
    if(sys>=140 || dia>=90) esamos.push("Padidėjęs kraujo spaudimas");
  }

  if(map!=null) pills.push(classifyPill(`MAP ${map} mmHg`,(map<65)?"bad":(map<75)?"warn":"ok"));
  if(sys!=null&&dia!=null) pills.push(classifyPill(`AKS ${sys}/${dia} mmHg`,(sys>=140||dia>=90)?"warn":(sys<100)?"warn":"ok"));
  if(highSys30) pills.push(classifyPill(`SYS ${sys} mmHg (>\u00a0165) – kas 30 min.`,"warn"));

  if(hr!=null){
    if(hr>100) pills.push(classifyPill(`Pulsas ${hr}/min (tachikardija)`,"warn"));
    else if(hr<50) pills.push(classifyPill(`Pulsas ${hr}/min (bradikardija)`,"warn"));
    else pills.push(classifyPill(`Pulsas ${hr}/min`,"ok"));
  }

  // Mityba
  const m=f['mityba'].value;
  if(m==='peg') esamos.push("Mityba per PEG");
  else if(m==='zondas') esamos.push("Mityba per zondą (NG)");
  else if(m==='burna'){
    if(f['rijimas'].value==='taip' || f['suvalgo'].value!=='taip') esamos.push("Sutrikusi mityba per burną");
  }

  // Šalinimas: dabar krenta į problemas
  if(f['kateteris'].value==='yra') esamos.push("Šlapimo kateteris");
  if(f['viduriai'].value==='taip') esamos.push("Vidurių užkietėjimas");
  if(f['viduriavimas'].value==='taip') esamos.push("Viduriavimas");

  // Judėjimas / oda
  if(f['mobilumas'].value==='lova') galimos.push("Rizika praguloms dėl lovos režimo");
  if(f['mobilumas'].value==='pagalba') galimos.push("Rizika griuvimui dėl pagalbos poreikio");
  if(f['pragulos'].value==='yra') esamos.push("Pragulos");
  if(f['zaizdos'].value==='yra'){
    const apr=(f['zaizdos_text'].value||'').trim();
    esamos.push("Odos vientisumo pažeidimas (žaizda)"+(apr?(" – "+apr):""));
  }

  // Skausmas: 1–3 / 4–6 / 7–10
  if(f['skausmas'].value==='taip'){
    const val=toNum(f['skausmoLygis'].value);
    if(val==null || val<0 || val>10){ alert("Įveskite skausmo intensyvumą (0–10)."); $('skausmoLygis').focus(); return; }

    let painLabel="";
    if(val>=1 && val<=3) painLabel="Nedidelis skausmas (1–3/10)";
    else if(val>=4 && val<=6) painLabel="Vidutinis skausmas (4–6/10)";
    else if(val>=7 && val<=10) painLabel="Didelis skausmas (7–10/10)";
    else painLabel="Skausmas (0/10)";

    if(val>0) esamos.push(painLabel);

    const sev=val>=7 ? "bad" : val>=4 ? "warn" : "ok";
    pills.push(classifyPill(`Skausmas ${val}/10`,sev));
  }

  if(f['kraujavimo_rizika'].value==='yra') galimos.push("Kraujavimo rizika");

  const uniq=a=>[...new Set(a)].filter(Boolean);
  const esamosU=uniq(esamos).sort();
  const galimosU=uniq(galimos).sort();

  // Psichologinė būklė ir suvaržymas
  const pb_ramus  = $('ramus').checked;
  const pb_orient = $('orientuotas').checked;
  const psichoTekstas = `${pb_ramus ? 'ramus' : 'neramus'}, ${pb_orient ? 'orientuotas' : 'neorientuotas'}`;

  const isRestrained = $('suvarzymas')?.checked === true;
  const nowTime = new Date().toLocaleTimeString('lt-LT', {hour:'2-digit', minute:'2-digit'});
  const restraintSentence = isRestrained
    ? `Dėl galimos žalos sau pačiam ir aplinkiniams, neveikiant kitoms priemonėms pacientas fiksuotas (${nowTime}).`
    : "";

  // Pirminis vertinimas (checklist)
  const pvPlanSets={
    cv:["AKS sekimas","Skysčių balanso stebėjimas","Edemų stebėjimas","Dusulio stebėjimas","Mitybos/dietos pritaikymas"],
    resp:["SpO₂ stebėjimas"],
    endo:["Glikemijos kontrolė","Mitybos/dietos pritaikymas"],
    rh:["Skysčių balanso stebėjimas","Skysčių kiekio sekimas","AKS sekimas"]
  };
  const pvSelected=[], pvExtraItems=[];
  if($('pv_cv')?.checked){ pvSelected.push("Širdies–kraujotakos"); pvExtraItems.push(...pvPlanSets.cv); }
  if($('pv_resp')?.checked){ pvSelected.push("Kvėpavimo"); pvExtraItems.push(...pvPlanSets.resp); }
  if($('pv_endo_cd')?.checked){ pvSelected.push("Endokrininės (CD)"); pvExtraItems.push(...pvPlanSets.endo); }
  if($('pv_renal_hep')?.checked){ pvSelected.push("Inkstų/kepenų"); pvExtraItems.push(...pvPlanSets.rh); }
  const pvInfection=($('pv_infection')?.value||'').trim();
  const pvAllergy=($('pv_allergy')?.value||'').trim();
  const pvSummaryParts=[];
  if(pvSelected.length) pvSummaryParts.push("Sritys: "+pvSelected.join(", "));
  if(pvInfection) pvSummaryParts.push("Infekcinės ligos: "+pvInfection);
  if(pvAllergy) pvSummaryParts.push("Alergijos: "+pvAllergy);
  const pvSummaryText=pvSummaryParts.join(" | ");

  // Dieta
  const dietCode=($('dieta_kodas')?.value||'').trim();
  const dietCustom=(dietCode==='KITA')?(($('dieta_kita')?.value||'').trim()):'';
  const hasDiet=(dietCode && dietCode!=='KITA') || (dietCode==='KITA' && dietCustom);

  // ——— UI ———
  let html="";
  if(pills.length) html+=`<div class="hint"><strong>Greita santrauka:</strong> ${pills.join(" ")}</div>`;
  html+=`<h3>Esamos problemos</h3><ul>${esamosU.length?esamosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;
  html+=`<h3>Galimos problemos</h3><ul>${galimosU.length?galimosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;

  html+=`<h3>Slaugos planas</h3>`;
  [...esamosU,...galimosU].forEach(p=>{
    const key=Object.keys(slaugosPlanas).find(k=>p.startsWith(k));
    if(key){
      const items=[...slaugosPlanas[key]];

      // Papildomas punktas prie padidėjusio AKS, jei SYS > 165
      if(p.startsWith("Padidėjęs kraujo spaudimas") && highSys30){
        items.push("AKS sekimas kas 30 min.");
      }

      html+=`<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${
        items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
      }</ul></div>`;
    }
  });

  // Dieta – rodyti plane atskirai, jei yra sakinių
  const dietItems=(dietCode && dietCode!=='KITA') ? (dietPlan[dietCode]||[]) : [];
  if(dietItems.length){
    html+=`<div class="planas"><h4>Dieta: ${escapeHtml(dietCode)}</h4><ul>${
      dietItems.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  }
  // Suvaržymas – kortelė plane
  if(isRestrained){
    html+=`<div class="planas"><h4>Fizinis suvaržymas</h4><ul>${
      restraintPlan.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  }

  const aksStr=(sys!=null&&dia!=null)?`${sys} / ${dia} mmHg${map!=null?` (MAP ${map})`:''}`:'-';
  html+=`<h3>Įvesti gyvybiniai rodikliai</h3>
  <p><strong>SpO₂:</strong> ${valOrDash(spo2)} %<br>
  <strong>AKS:</strong> ${aksStr}<br>
  <strong>ŠSD:</strong> ${valOrDash(hr)} / min<br>
  <strong>Temperatūra:</strong> ${temp!=null?temp.toFixed(1):"-"} °C</p>
  <p><strong>Pacientas:</strong> ${escapeHtml(psichoTekstas)}</p>`;
  if (restraintSentence) { html += `<p>${escapeHtml(restraintSentence)}</p>`; }
  if(hasDiet){
    const dietaUi=(dietCode==='KITA')?dietCustom:dietCode;
    html+=`<p><strong>Pacientui skirta:</strong> ${escapeHtml(dietaUi)} dieta</p>`;
  }
  html+=`<p><strong>Pirminis vertinimas:</strong> ${escapeHtml(pvSummaryText || "—")}</p>`;
  $('results').innerHTML=html;

  // ——— ĮRAŠO TEKSTAS (Sheets) ———
  const seenPlan=new Set(); const planItems=[];
  [...esamosU,...galimosU].forEach(p=>{
    const key=Object.keys(slaugosPlanas).find(k=>p.startsWith(k));
    if(!key) return;
    slaugosPlanas[key].forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });

    // Papildomas punktas prie padidėjusio AKS, jei SYS > 165
    if(p.startsWith("Padidėjęs kraujo spaudimas") && highSys30){
      const it="AKS sekimas kas 30 min.";
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    }
  });

  if(dietCode && dietCode!=='KITA'){
    (dietPlan[dietCode]||[]).forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }
  if(isRestrained){
    restraintPlan.forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }

  // Pirminio vertinimo papildomi (jei nori – įtraukiam į planą)
  if(pvExtraItems.length){
    pvExtraItems.forEach(it=>{ if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); } });
  }

  const planasText=planItems.length?planItems.map(i=>"• "+i).join("\n"):"-";

  const gyvybiniai=vitalsText(spo2,sys,dia,map,hr,temp);
  const slaugosProb=esamosU.length?esamosU.join('; '):'-';
  const galimosProb=galimosU.length?galimosU.join('; '):'-';

  let irasas=
    `Gyvybiniai rodikliai:\n${gyvybiniai}\n\n`+
    `Pacientas: ${psichoTekstas}\n`;
  if (restraintSentence) { irasas += `${restraintSentence}\n`; }
  irasas += `\n`;
  if(hasDiet){
    const dietaNote=(dietCode==='KITA')?dietCustom:dietCode;
    irasas+=`Pacientui skirta: ${dietaNote} dieta\n\n`;
  }
  irasas+=
    `Pirminis vertinimas:\n${pvSummaryText || "—"}\n\n`+
    `Slaugos problemos:\n${slaugosProb}\n\n`+
    `Galimos problemos:\n${galimosProb}\n\n`+
    `Slaugos planas:\n${planasText}`;

  lastPayload={
    "Laikas": new Date().toLocaleString('lt-LT'),
    "palata": f['palata'].value.trim(),
    "lova":   f['lova'].value.trim(),
    "įrašas": irasas
  };

  $('results').insertAdjacentHTML('beforeend', `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`);
}

/* ——— SIUNTIMAS Į SHEETS ——— */
function keltiISistema(){
  if(!lastPayload){ alert("Pirmiausia paspauskite „Generuoti“."); return; }
  const url=(GOOGLE_SCRIPT_URL||'').trim();
  if(!url || !url.endsWith('/exec')){ alert("Patikrinkite WebApp URL – turi baigtis /exec."); return; }

  fetch(url,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(lastPayload),mode:"no-cors"})
  .then(()=>{ $('statusErr').style.display='none'; $('statusOk').style.display='block'; })
  .catch(()=>{ $('statusOk').style.display='none'; $('statusErr').style.display='block'; });
}

/* ——— RESET ——— */
function resetForm(){
  $('nursingForm').reset();
  $('results').innerHTML="";
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';
  $('zaizdos_aprasymas').style.display='none';
  $('dieta_kita_wrap').style.display='none';
  lastPayload=null;
}
</script>
</body>
</html>
