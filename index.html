<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paciento vertinimas ir slaugos planas</title>
<style>
  :root{--bg:#f7f8fa;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:auto;padding:20px;background:var(--bg);color:#111}
  h1{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
  .section{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px}
  .section h2{font-size:18px;margin:0 0 10px;padding-bottom:8px;border-bottom:1px dashed var(--line)}
  label{display:block;margin-top:8px;font-weight:600}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hint{font-weight:400;color:var(--muted);font-size:12px}
  select,input,textarea{padding:10px;border:1px solid var(--line);border-radius:8px;width:100%;margin-top:6px;background:#fff}
  textarea{min-height:84px;resize:vertical}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  button{padding:10px 14px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  button.secondary{background:#fff;color:#111;border:1px solid var(--line)}
  button.good{background:var(--ok)}
  .results{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-top:18px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin:3px 6px 0 0;background:#fff}
  .pill.ok{border-color:#16a34a33;background:#16a34a18}
  .pill.warn{border-color:#f59e0b33;background:#f59e0b18}
  .pill.bad{border-color:#dc262633;background:#dc262618}
  .planas{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px;background:#fff}
  .planas h4{margin:0 0 8px}
  .status{padding:10px;border-radius:10px;margin-top:10px;display:none}
  .status.ok{display:block;background:#ecfdf5;border:1px solid #86efac;color:#065f46}
  .status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:12px;margin-top:12px;overflow:auto}
  .checks{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
  .checks label{display:flex;align-items:center;font-weight:500;margin:0}
  .checks input{margin-right:8px;width:auto}
</style>
</head>
<body>
<h1>Paciento vertinimas ir slaugos planas</h1>

<form id="nursingForm" novalidate>
  <div class="grid">
    <!-- IDENTIFIKACIJA -->
    <div class="section">
      <h2>Identifikacija</h2>
      <label for="palata">Palata
        <input id="palata" name="palata" autocomplete="off" />
      </label>
      <label for="lova">Lova
        <input id="lova" name="lova" autocomplete="off" />
      </label>
    </div>

    <!-- PACIENTO BŪKLĖ (NAUJA) -->
    <div class="section">
      <h2>Paciento būklė</h2>
      <div class="checks">
        <label><input type="checkbox" id="ramus" /> Ramus</label>
        <label><input type="checkbox" id="orientuotas" /> Orientuotas</label>
      </div>
      <div class="hint">Nežymint šių langelių į įrašą bus įtraukta: <em>„neramus, neorientuotas“</em>.</div>
    </div>

    <!-- KVĖPAVIMO SISTEMA -->
    <div class="section">
      <h2>Kvėpavimo sistema</h2>
      <label for="trach">Tracheostominis vamzdis
        <select id="trach" name="trach">
          <option value="ne">Nėra</option><option value="taip">Yra</option>
        </select>
      </label>

      <div class="row">
        <label for="sekretas_trach">Sekretas / atkosėjimas iš vamzdžio
          <select id="sekretas_trach" name="sekretas_trach">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="siurbimas">Atliekamas siurbimas
          <select id="siurbimas" name="siurbimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="nosis">Nosis
          <select id="nosis" name="nosis">
            <option value="nedaryta">Niekas nedaryta</option>
            <option value="tamponuota">Tamponuota nosis</option>
            <option value="istraukti">Ištraukti tamponai</option>
          </select>
        </label>
        <label for="dusulys">Ar jaučiate dusulį?
          <select id="dusulys" name="dusulys">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label for="saturacija">Saturacija SpO₂ (%) <span class="hint">(50–100)</span>
          <input type="number" id="saturacija" name="saturacija" min="50" max="100" inputmode="decimal" />
        </label>
        <label for="kosulys">Kosulys
          <select id="kosulys" name="kosulys">
            <option value="nera">Nėra</option><option value="sausas">Sausas</option><option value="dregnas">Drėgnas</option>
          </select>
        </label>
      </div>
    </div>

    <!-- ŠIRDIES IR KRAUJOTAKA -->
    <div class="section">
      <h2>Širdies ir kraujotaka</h2>
      <div class="row">
        <label for="sistolinis">AKS (sistolinis) mmHg <span class="hint">(50–250)</span>
          <input type="number" id="sistolinis" name="sistolinis" min="50" max="250" />
        </label>
        <label for="diastolinis">AKS (diastolinis) mmHg <span class="hint">(20–150)</span>
          <input type="number" id="diastolinis" name="diastolinis" min="20" max="150" />
        </label>
      </div>
      <div class="row">
        <label for="pulsas">Pulsas (bpm) <span class="hint">(30–200)</span>
          <input type="number" id="pulsas" name="pulsas" min="30" max="200" />
        </label>
        <label for="temperatura">Kūno temperatūra (°C) <span class="hint">(30.0–42.0)</span>
          <input type="number" id="temperatura" name="temperatura" step="0.1" min="30" max="42" />
        </label>
      </div>
      <label for="svaigimas">Galvos svaigimas?
        <select id="svaigimas" name="svaigimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- MITYBA -->
    <div class="section">
      <h2>Mityba</h2>
      <div class="row">
        <label for="mityba">Mitybos būdas
          <select id="mityba" name="mityba">
            <option value="burna">Per burną</option>
            <option value="peg">Per PEG</option>
            <option value="zondas">Per zondą</option>
          </select>
        </label>
        <label for="rijimas">Rijimo sutrikimai?
          <select id="rijimas" name="rijimas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>
      <label for="suvalgo">Ar suvalgo visą maistą?
        <select id="suvalgo" name="suvalgo">
          <option value="taip">Taip</option>
          <option value="dalis">Dalis</option>
          <option value="ne">Ne</option>
        </select>
      </label>
    </div>

    <!-- ŠALINIMAS -->
    <div class="section">
      <h2>Šalinimas</h2>
      <div class="row">
        <label for="kateteris">Šlapimo kateteris
          <select id="kateteris" name="kateteris">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="viduriai">Vidurių užkietėjimas?
          <select id="viduriai" name="viduriai">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
      </div>
      <label for="viduriavimas">Viduriavimas?
        <select id="viduriavimas" name="viduriavimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <!-- JUDĖJIMAS -->
    <div class="section">
      <h2>Judėjimas</h2>
      <label for="mobilumas">Mobilumas
        <select id="mobilumas" name="mobilumas">
          <option value="sav">Savarankiškas</option>
          <option value="pagalba">Su pagalba</option>
          <option value="lova">Lovos režimas</option>
        </select>
      </label>
    </div>

    <!-- MIEGAS -->
    <div class="section">
      <h2>Miegas</h2>
      <label for="miegas">Miego kokybė
        <select id="miegas" name="miegas">
          <option value="gera">Gera</option>
          <option value="sutrikusi">Sutrikusi</option>
        </select>
      </label>
    </div>

    <!-- ODA -->
    <div class="section">
      <h2>Oda</h2>
      <div class="row">
        <label for="pragulos">Pragulos
          <select id="pragulos" name="pragulos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
        <label for="zaizdos">Žaizdos
          <select id="zaizdos" name="zaizdos">
            <option value="nera">Nėra</option><option value="yra">Yra</option>
          </select>
        </label>
      </div>
      <div id="zaizdos_aprasymas" style="display:none;">
        <label for="zaizdos_text">Žaizdos aprašymas
          <textarea id="zaizdos_text" name="zaizdos_text" placeholder="Lokalizacija, dydis, sekrecija, paraudimas, skausmingumas..."></textarea>
        </label>
      </div>
    </div>

    <!-- SKAUSMAS -->
    <div class="section">
      <h2>Skausmas</h2>
      <div class="row">
        <label for="skausmas">Ar yra skausmas?
          <select id="skausmas" name="skausmas">
            <option value="ne">Ne</option><option value="taip">Taip</option>
          </select>
        </label>
        <label for="skausmoLygis">Intensyvumas (0–10)
          <input type="number" id="skausmoLygis" name="skausmoLygis" min="0" max="10" />
        </label>
      </div>
      <div class="hint">Jei „Yra skausmas“, įveskite skaičių 0–10 (NRS).</div>
    </div>

    <!-- KRAUJAVIMO RIZIKA -->
    <div class="section">
      <h2>Kraujavimo rizika</h2>
      <label for="kraujavimo_rizika">Kraujavimo rizika?
        <select id="kraujavimo_rizika" name="kraujavimo_rizika">
          <option value="nera">Nėra</option>
          <option value="yra">Yra</option>
        </select>
      </label>
      <div class="hint">Jei „Yra“ – prie galimų problemų bus pridėta „Kraujavimo rizika“ ir plane: „Stebėjimas dėl galimo kraujavimo“, „AKS sekimas“.</div>
    </div>
  </div>

  <div class="actions">
    <button type="button" id="genBtn" onclick="generateResults()">Generuoti</button>
    <button type="button" id="resetBtn" class="secondary">Naujas pacientas</button>
    <button type="button" class="good" onclick="keltiISistema()">Kelti į sistemą</button>
  </div>
</form>

<div id="results" class="results" aria-live="polite"></div>

<div id="statusOk" class="status ok">✅ Duomenys įkelti sėkmingai.</div>
<div id="statusErr" class="status err">❌ Klaida siunčiant į Google Sheets. Patikrinkite WebApp adresą ir leidimus.</div>

<script>
/* ───────── KLAIDŲ GAUDYMAS IR „SAFETY“ PRISIRIŠIMAI ───────── */
window.addEventListener('error', e => alert('JS klaida: ' + e.message));
const $ = (id) => document.getElementById(id);
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
onReady(() => {
  $('zaizdos')?.addEventListener('change', e => { $('zaizdos_aprasymas').style.display = e.target.value === 'yra' ? 'block' : 'none'; });
  $('skausmas')?.addEventListener('change', e => { $('skausmoLygis')?.toggleAttribute('required', e.target.value === 'taip'); });
  $('resetBtn')?.addEventListener('click', resetForm);
});

/* ───────── KONFIGŪRA ───────── */
// ĮKLIJUOK SAVO /exec URL ŽEMIAU:
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxODAbmdrmccCYCUkswsFgnz-nrC8clEQQf-5kId3y-3TCqUwsU4pyCze2Jojv43VV_1A/exec";

/* ───────── SLAUGOS PLANŲ ŽEMĖLAPIS ───────── */
const slaugosPlanas = {
  "Kvėpavimo takai su tracheostominiu vamzdžiu": [
    "Savalaikis atsiurbimas iš tracheostominio vamzdelio",
    "Vamzdelio drėkinimas"
  ],
  "Nedidelis kraujavimas iš nosies": [
    "AKS stebėjimas kraujavimui nestojant",
    "Pacientas apmokintas kaip prižiūrėti nosį kraujavimui sustojus"
  ],
  "Sutrikusi kvėpavimo funkcija (dusulys)": [
    "SpO₂ stebėjimas",
    "Prireikus O₂ skyrimas pagal SpO₂"
  ],
  "Neefektyvi dujų apykaita": [
    "SpO₂ stebėjimas",
    "O₂ skyrimas ir reguliavimas pagal SpO₂ duomenis"
  ],
  "Pažemėjęs kraujo spaudimas": [
    "Patarta neskubėti keltis, pasėdėti nuleidus kojas prieš einant",
    "Stebėjimas dėl galimų griuvimų"
  ],
  "Padidėjęs kraujo spaudimas": [
    "AKS sekimas kas 4 val."
  ],
  /* MITYBA – nauji raktai */
  "Sutrikusi mityba per burną": [
    "Stebėjimas dėl aspiracijos",
    "Pagalba valgant",
    "Reikalui esant maisto tirštinimas"
  ],
  "Mityba per zondą (NG)": [
    "Zondo padėties patikra pagal įstaigos protokolą",
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po",
    "Zondo praplovimas prieš ir po maitinimo bei vaistų",
    "Nosies ir odos prie zondo priežiūra, fiksacijos patikra",
    "Stebėti dėl aspiracijos, pykinimo, pilvo pūtimo"
  ],
  "Mityba per PEG": [
    "PEG vietos apžiūra ir tvarsčio keitimas",
    "Praplovimas prieš ir po maitinimo bei vaistų",
    "Galvūgalis ≥30–45° maitinimo metu ir 30–60 min po"
  ],
  "Rizika griuvimui dėl pagalbos poreikio": [
    "Stebėti dėl griuvimų rizikos, kviesti pagalbą judant"
  ],
  "Rizika praguloms dėl lovos režimo": [
    "Padėties keitimas kas 3 val.",
    "Pakišamų indų/sauskelnių naudojimas",
    "Pagalbinių priemonių naudojimas",
    "Odos vientisumo stebėjimas"
  ],
  "Pragulos": [
    "Kūno padėties keitimas kas 3 val.",
    "Pagalbinės priemonės",
    "Pragulos perrišimas pagal žaizdų priežiūros planą"
  ],
  "Odos vientisumo pažeidimas (žaizda)": [
    "Žaizdos perrišimas",
    "Stebėti infekcijos požymius"
  ],
  "Ūmus/chroniškas skausmas": [
    "Savalaikis nuskausminimas pagal gydytojo paskyrimą"
  ],
  "Padidėjusi temperatūra": [
    "Temperatūros stebėjimas"
  ],
  "Hipotermija": [
    "Šilumos palaikymas",
    "Temperatūros stebėjimas"
  ],
  "Kraujavimo rizika": [
    "Stebėjimas dėl galimo kraujavimo",
    "AKS sekimas"
  ]
};

/* ───────── PAGALBINĖS ───────── */
let lastPayload = null;

function toNum(v){ const n = parseFloat(v); return isFinite(n) ? n : null; }
function calcMAP(sys, dia){ if(sys==null||dia==null) return null; return Math.round(((2*dia)+sys)/3); }
function valOrDash(v){ return (v==null || v==="") ? "-" : v; }
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

function classifyPill(text, severity="ok"){
  const cls = severity==="bad"?"pill bad":severity==="warn"?"pill warn":"pill ok";
  return `<span class="${cls}">${text}</span>`;
}

function vitalsText(spo2, sys, dia, map, hr, temp){
  const aks = (sys!=null && dia!=null) ? `${sys}/${dia} mmHg${map!=null?` (MAP ${map})`:''}` : '-';
  const T = (temp!=null) ? `${Number(temp).toFixed(1)} °C` : '-';
  return [`SpO₂: ${spo2!=null? spo2+' %' : '-'}`,
          `AKS: ${aks}`,
          `ŠSD: ${hr!=null? hr+'/min' : '-'}`,
          `Temperatūra: ${T}`].join('\n');
}

// Slaugos planas be pasikartojimų
function buildPlanTextAggregated(allProblems, planMap){
  const seen = new Set(), out = [];
  allProblems.forEach(p => {
    const key = Object.keys(planMap).find(k => p.startsWith(k));
    if (!key) return;
    planMap[key].forEach(item => { if (!seen.has(item)) { seen.add(item); out.push(`• ${item}`); } });
  });
  return out.length ? out.join('\n') : '-';
}

/* ───────── PAGRINDINĖ LOGIKA ───────── */
function generateResults(){
  console.log('generateResults() start');

  // paslėpti status
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';

  const f = document.forms['nursingForm'];
  const esamos = [];
  const galimos = [];
  const pills = [];

  const spo2 = toNum(f['saturacija'].value);
  const temp = toNum(f['temperatura'].value);
  const sys  = toNum(f['sistolinis'].value);
  const dia  = toNum(f['diastolinis'].value);
  const hr   = toNum(f['pulsas'].value);
  const map  = calcMAP(sys, dia);

  // SpO2
  if(spo2!=null){
    if(spo2 < 90){ esamos.push("Neefektyvi dujų apykaita"); pills.push(classifyPill(`SpO₂ ${spo2}% (kritiškai žema)`, "bad")); }
    else if(spo2 < 94){ esamos.push("Neefektyvi dujų apykaita"); pills.push(classifyPill(`SpO₂ ${spo2}% (žema)`, "warn")); }
    else pills.push(classifyPill(`SpO₂ ${spo2}%`, "ok"));
  }
  // Temperatūra
  if(temp!=null){
    if(temp >= 38.0){ esamos.push("Padidėjusi temperatūra"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (karščiavimas)`, "warn")); }
    else if(temp >= 37.1){ esamos.push("Padidėjusi temperatūra"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (subfebrilus)`, "warn")); }
    else if(temp < 36.0){ esamos.push("Hipotermija"); pills.push(classifyPill(`T ${temp.toFixed(1)}°C (žema)`, "warn")); }
    else pills.push(classifyPill(`T ${temp.toFixed(1)}°C`, "ok"));
  }
  // Kvėpavimas / nosis / dusulys
  if(f['trach'].value==='taip') esamos.push("Kvėpavimo takai su tracheostominiu vamzdžiu");
  if(f['nosis'].value==='istraukti') esamos.push("Nedidelis kraujavimas iš nosies");
  if(f['dusulys'].value==='taip') esamos.push("Sutrikusi kvėpavimo funkcija (dusulys)");
  // AKS / MAP / pulsas
  if(sys!=null && dia!=null){
    if(sys < 100 || (map!=null && map < 65)) esamos.push("Pažemėjęs kraujo spaudimas");
    if(sys >= 140 || dia >= 90) esamos.push("Padidėjęs kraujo spaudimas");
  }
  if(map!=null) pills.push(classifyPill(`MAP ${map} mmHg`, (map<65)?"bad":(map<75)?"warn":"ok"));
  if(sys!=null && dia!=null) pills.push(classifyPill(`AKS ${sys}/${dia} mmHg`, (sys>=140||dia>=90)?"warn":(sys<100)?"warn":"ok"));
  if(hr!=null){
    if(hr>100) pills.push(classifyPill(`Pulsas ${hr}/min (tachikardija)`, "warn"));
    else if(hr<50) pills.push(classifyPill(`Pulsas ${hr}/min (bradikardija)`, "warn"));
    else pills.push(classifyPill(`Pulsas ${hr}/min`, "ok"));
  }

  // Mityba (atskyrimas)
  const m = f['mityba'].value;
  if (m === 'peg') {
    esamos.push("Mityba per PEG");
  } else if (m === 'zondas') {
    esamos.push("Mityba per zondą (NG)");
  } else if (m === 'burna') {
    if (f['rijimas'].value === 'taip' || f['suvalgo'].value !== 'taip') {
      esamos.push("Sutrikusi mityba per burną");
    }
  }

  // Judėjimas / oda
  if(f['mobilumas'].value==='lova') galimos.push("Rizika praguloms dėl lovos režimo");
  if(f['mobilumas'].value==='pagalba') galimos.push("Rizika griuvimui dėl pagalbos poreikio");
  if(f['pragulos'].value==='yra') esamos.push("Pragulos");
  if(f['zaizdos'].value==='yra'){
    const apr = (f['zaizdos_text'].value||'').trim();
    esamos.push("Odos vientisumo pažeidimas (žaizda)"+(apr?(" – "+apr):""));
  }

  // Skausmas
  if(f['skausmas'].value==='taip'){
    const val = toNum(f['skausmoLygis'].value);
    if(val==null || val<0 || val>10){ alert("Įveskite skausmo intensyvumą (0–10)."); $('skausmoLygis').focus(); return; }
    esamos.push(`Ūmus/chroniškas skausmas (${val}/10)`);
    const sev = val>=7 ? "bad" : val>=4 ? "warn" : "ok";
    pills.push(classifyPill(`Skausmas ${val}/10`, sev));
  }

  // Kraujavimo rizika
  if(f['kraujavimo_rizika'].value==='yra'){
    galimos.push("Kraujavimo rizika");
  }

  // DEDUP + rikiavimas
  const uniq = a => [...new Set(a)].filter(Boolean);
  const esamosU  = uniq(esamos).sort();
  const galimosU = uniq(galimos).sort();

  // Psichologinė būklė (pagal varnelės)
  const pb_ramus = $('ramus').checked;
  const pb_orient = $('orientuotas').checked;
  const psichoTekstas = `${pb_ramus ? 'ramus' : 'neramus'}, ${pb_orient ? 'orientuotas' : 'neorientuotas'}`;

  // UI renderis
  let html = "";
  if(pills.length) html += `<div class="hint"><strong>Greita santrauka:</strong> ${pills.join(" ")}</div>`;
  html += `<h3>Esamos problemos</h3><ul>${esamosU.length?esamosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;
  html += `<h3>Galimos problemos</h3><ul>${galimosU.length?galimosU.map(p=>`<li>${escapeHtml(p)}</li>`).join(""):"<li>Nepastebėta</li>"}</ul>`;

  html += `<h3>Slaugos planas</h3>`;
  [...esamosU, ...galimosU].forEach(p=>{
    const key = Object.keys(slaugosPlanas).find(k=>p.startsWith(k));
    if(key){
      html += `<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${slaugosPlanas[key].map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul></div>`;
    }
  });

  const aksStr = (sys!=null && dia!=null) ? `${sys} / ${dia} mmHg${map!=null?` (MAP ${map})`:''}` : '-';
  html += `<h3>Įvesti gyvybiniai rodikliai</h3>
  <p><strong>SpO₂:</strong> ${valOrDash(spo2)} %<br>
  <strong>AKS:</strong> ${aksStr}<br>
  <strong>ŠSD:</strong> ${valOrDash(hr)} / min<br>
  <strong>Temperatūra:</strong> ${temp!=null?temp.toFixed(1):"-"} °C</p>
  <p><strong>Paciento psichologinė būklė:</strong> ${escapeHtml(psichoTekstas)}</p>`;

  $('results').innerHTML = html;

  // Vienos ląstelės „įrašas“ Google Sheets
  const gyvybiniai = vitalsText(spo2, sys, dia, map, hr, temp);
  const slaugosProb = esamosU.length ? esamosU.join('; ') : '-';
  const galimosProb = galimosU.length ? galimosU.join('; ') : '-';
  const planasText  = buildPlanTextAggregated([...esamosU, ...galimosU], slaugosPlanas);

  const irasas =
    `Gyvybiniai rodikliai:\n${gyvybiniai}\n\n` +
    `Paciento psichologinė būklė:\n${psichoTekstas}\n\n` +
    `Slaugos problemos:\n${slaugosProb}\n\n` +
    `Galimos problemos:\n${galimosProb}\n\n` +
    `Slaugos planas:\n${planasText}`;

  lastPayload = {
    "Laikas": new Date().toLocaleString('lt-LT'),
    "palata": f['palata'].value.trim(),
    "lova":   f['lova'].value.trim(),
    "įrašas": irasas
  };

  // Debug box
  $('results').insertAdjacentHTML('beforeend', `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`);
}

function keltiISistema(){
  if(!lastPayload){ alert("Pirmiausia paspauskite „Generuoti“."); return; }
  const url = (GOOGLE_SCRIPT_URL||'').trim();
  if(!url || !url.endsWith('/exec')){ alert("Patikrinkite WebApp URL – turi baigtis /exec."); return; }

  fetch(url, {
    method: "POST",
    headers: {"Content-Type": "text/plain"}, // paprasta užklausa
    body: JSON.stringify(lastPayload),
    mode: "no-cors"
  })
  .then(()=>{ $('statusErr').style.display='none'; $('statusOk').style.display='block'; })
  .catch(()=>{ $('statusOk').style.display='none'; $('statusErr').style.display='block'; });
}

function resetForm(){
  $('nursingForm').reset();
  $('results').innerHTML = "";
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';
  $('zaizdos_aprasymas').style.display='none';
  lastPayload = null;
}
</script>
</body>
</html>

