
  return { error:false, esamos, galimos, pills, vitals:{spo2,temp,sys,dia,hr,map}, highSys30, painBlock, addExtrasForHelpDueToDizziness };
}

/* =========================================================
   6) OUTPUT / HTML / ĮRAŠAS  (EDIT HERE #4)
========================================================= */
let lastPayload=null;

function renderOutput(f, ctx){
  const { esamos, galimos, pills, vitals, highSys30, painBlock, addExtrasForHelpDueToDizziness } = ctx;
  const { spo2, temp, sys, dia, hr, map } = vitals;

  const esamosU=uniq(esamos).sort();
  const galimosU=uniq(galimos).sort();

  const combineBedRestAndUlcers=(f['mobilumas']?.value==='lova' && f['pragulos']?.value==='yra');

  const pb_ramus=$('ramus')?.checked;
  const pb_orient=$('orientuotas')?.checked;
  const psichoTekstas = `${pb_ramus?'ramus':'neramus'}, ${pb_orient?'orientuotas':'neorientuotas'}`;
  // ===== IŠRAŠYMAS Į NAMUS =====
  const goingHome = $('vykstaNamo')?.checked === true;
  if(goingHome){
    const tId = $('rekomTemplate')?.value || '';
    if(!tId){
      alert("Pasirinkite rekomendacijų šabloną (Rekomendacijų šablonas).");
      $('rekomTemplate')?.focus?.();
      return;
    }
    const tpl = Array.isArray(DISCHARGE_TEMPLATES)
      ? DISCHARGE_TEMPLATES.find(x => x.id === tId)
      : null;

    if(!tpl){
      alert("Nerastas rekomendacijų šablonas. Pasirinkite iš sąrašo dar kartą.");
      return;
    }

    const aksStr = (sys!=null && dia!=null)
      ? `${sys} / ${dia} mmHg${map!=null?` (MAP ${map})`:''}`
      : '-';

    // HTML
    let html = "";
    html += `<h3>Įvesti gyvybiniai rodikliai</h3>
      <p><strong>SpO₂:</strong> ${valOrDash(spo2)} %<br>
      <strong>AKS:</strong> ${aksStr}<br>
      <strong>ŠSD:</strong> ${valOrDash(hr)} / min<br>
      <strong>Temperatūra:</strong> ${temp!=null?temp.toFixed(1):"-"} °C</p>
      <p><strong>Pacientas:</strong> ${escapeHtml(psichoTekstas)}</p>`;

    html += `<p><strong>Pacientas vyksta namo, ištrauktas intraveninis kateteris.</strong></p>`;
    html += `<h3>Pacientui rekomenduota</h3><ul>${
      tpl.items.map(it=>`<li>${escapeHtml(it)}</li>`).join("")
    }</ul>`;

    // Įrašas į Sheets
    const gyvybiniai = vitalsText(spo2,sys,dia,map,hr,temp);
    let irasas =
      `Gyvybiniai rodikliai:\n${gyvybiniai}\n\n`+
      `Pacientas: ${psichoTekstas}\n`+
      `Pacientas vyksta namo, ištrauktas intraveninis kateteris.\n\n`+
      `Pacientui rekomenduota:\n` +
      tpl.items.map(i=>"• "+i).join("\n");

    lastPayload={
      "Laikas": new Date().toLocaleString('lt-LT'),
      "palata": (f['palata'].value||"").trim(),
      "lova":   (f['lova'].value||"").trim(),
      "įrašas": irasas
    };

    $('results').innerHTML = html;
    $('results').insertAdjacentHTML('beforeend', `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`);
    return;
  }
