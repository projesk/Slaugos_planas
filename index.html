<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Paciento vertinimas ir slaugos planas</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
    --accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  h1{margin:18px auto 0;max-width:1100px;padding:0 16px;font-size:22px}

  .grid{display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr));max-width:1100px;margin:14px auto;padding:0 16px;align-items:start}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:680px){.grid{grid-template-columns:1fr}}

  .section{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03);min-width:0}
  h2{font-size:14px;margin:0 0 10px 0;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 0;min-width:0}

  input,select,textarea,button{
    width:100%;margin-top:6px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
    font-size:14px;background:#fff;color:var(--text);outline:none;
  }
  input,select,button{height:44px}
  textarea{min-height:84px;height:auto;resize:vertical}

  .row{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr));align-items:start}
  .row > label{display:flex;flex-direction:column;min-width:0}
  @media(max-width:680px){.row{grid-template-columns:1fr}}

  /* iOS select vizualinis suvienodinimas */
  select{
    -webkit-appearance:none;
    appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #6b7280 50%),
      linear-gradient(135deg, #6b7280 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 18px) calc(1em + 2px),
      calc(100% - 13px) calc(1em + 2px),
      100% 0;
    background-size:5px 5px, 5px 5px, 2.5em 2.5em;
    background-repeat:no-repeat;
    padding-right:40px;
  }

  .checks{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px}
  .checks label{display:flex;align-items:center;gap:8px;margin:0;color:var(--text);font-size:14px}
  .checks input{width:auto;margin:0}

  /* didesni ir aiÅ¡kesni checkbox'ai (matosi, kas paÅ¾ymÄ—ta) */
  .checks{gap:10px}
  .checks label{
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    cursor:pointer;
    user-select:none;
  }
  .checks input[type="checkbox"]{
    -webkit-appearance:none;
    appearance:none;
    width:18px;height:18px;
    border:1px solid var(--line);
    border-radius:5px;
    display:inline-grid;
    place-content:center;
    background:#fff;
  }
  .checks input[type="checkbox"]::before{
    content:"";
    width:10px;height:10px;
    transform:scale(0);
    transition:transform .12s ease-in-out;
    background:var(--accent);
    border-radius:3px;
  }
  .checks input[type="checkbox"]:checked{border-color:var(--accent)}
  .checks input[type="checkbox"]:checked::before{transform:scale(1)}
  .checks label:has(input[type="checkbox"]:checked){
    border-color:rgba(37,99,235,.5);
    background:rgba(37,99,235,.06);
    color:var(--text);
  }

  .hint{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.3}

  .actions{display:flex;gap:10px;margin-top:10px}
  .actions button{cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  button.secondary{background:#fff}

  #output{grid-column:1 / -1}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin-right:6px;margin-top:6px}
  .pill.ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
  .pill.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .pill.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}

  .planas{border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-top:10px;background:#fafafa}
  .planas h4{margin:0 0 6px;font-size:13px;color:#111}
  .planas ul{margin:0;padding-left:18px}
  .planas li{margin:3px 0}

  /* GyvybiniÅ³ rodikliÅ³ lygiavimas: vienodas label aukÅ¡tis, kad laukai "neplaukiotÅ³" */
  .vitals .row > label{min-height:86px}
  .vitals .hint{margin-top:10px}

  /* DVPRS modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.5);padding:16px;z-index:50}
  .modal.open{display:flex}
  .modal__card{width:min(760px,100%);background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 18px 50px rgba(0,0,0,.18);overflow:hidden}
  .modal__head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .modal__title{font-weight:700}
  .modal__body{padding:14px 16px}
  .modal__footer{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--line)}
  .xbtn{width:auto;padding:8px 10px;border-radius:10px}

  .dvprsLegend{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 6px}
  @media(max-width:680px){.dvprsLegend{grid-template-columns:1fr}}
  .dvprsCard{border:1px solid var(--line);border-radius:14px;padding:10px}
  .dvprsCard h5{margin:0 0 6px}
  .dvprsGrid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;margin-top:10px}
  @media(max-width:820px){.dvprsGrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media(max-width:420px){.dvprsGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .dvprsBtn{cursor:pointer;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center}
  .dvprsBtn .face{font-size:30px;line-height:1}
  .dvprsBtn .num{font-weight:800}
  .dvprsBtn .txt{font-size:12px;color:var(--muted);text-align:center}
  .dvprsBtn:hover{border-color:rgba(37,99,235,.4);box-shadow:0 2px 0 rgba(0,0,0,.03)}
</style>
</head>
<body>

<h1>Paciento vertinimas ir slaugos planas</h1>

<div class="grid">

  <!-- IDENTIFIKACIJA -->
  <div class="section">
    <h2>Identifikacija</h2>
    <label for="palata">Palata
      <input id="palata" placeholder="pvz. 312" />
    </label>
    <label for="lova">Lova
      <input id="lova" placeholder="pvz. 4" />
    </label>
  </div>

  <!-- PACIENTO BÅªKLÄ– -->
  <div class="section">
    <h2>Paciento bÅ«klÄ—</h2>
    <div class="checks">
      <label><input type="checkbox" id="ramus" /> Ramus</label>
      <label><input type="checkbox" id="orientuotas" /> Orientuotas</label>
      <label><input type="checkbox" id="suvarzymas" /> SuvarÅ¾ymas</label>
    </div>
    <div class="hint">Jei nepaÅ¾ymÄ—ta â€“ Ä¯raÅ¡as bus: â€Pacientas: neramus, neorientuotasâ€œ.</div>
  </div>

  <!-- KVÄ–PAVIMO SISTEMA -->
  <div class="section">
    <h2>KvÄ—pavimo sistema</h2>

    <label for="trach">Tracheostominis vamzdis
      <select id="trach" name="trach">
        <option value="nera">NÄ—ra</option>
        <option value="yra">Yra</option>
      </select>
    </label>

    <div class="row">
      <label for="sekretas">Sekretas / atkosÄ—jimas iÅ¡ vamzdelio
        <select id="sekretas" name="sekretas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>

      <label for="siurbimas">Atliekamas siurbimas?
        <select id="siurbimas" name="siurbimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <label for="dusulys">Dusulys?
      <select id="dusulys" name="dusulys">
        <option value="ne">Ne</option><option value="taip">Taip</option>
      </select>
    </label>
  </div>

  <!-- GYVYBINIAI RODIKLIAI (su NEWS laukais vienoje kortelÄ—je) -->
  <div class="section vitals">
    <h2>Gyvybiniai rodikliai</h2>

    <!-- 1 eilÄ— -->
    <div class="row">
      <label for="saturacija">SpOâ‚‚ (%)
        <input id="saturacija" name="saturacija" inputmode="numeric" placeholder="pvz. 96" />
      </label>

      <label for="kvepavimo_daznis">KvÄ—pavimo daÅ¾nis (RR) / min
        <input id="kvepavimo_daznis" name="kvepavimo_daznis" inputmode="numeric" placeholder="pvz. 16" />
      </label>
    </div>

    <!-- 2 eilÄ— -->
    <div class="row">
      <label for="sistolinis">AKS sistolinis
        <input id="sistolinis" name="sistolinis" inputmode="numeric" placeholder="pvz. 120" />
      </label>

      <label for="diastolinis">AKS diastolinis
        <input id="diastolinis" name="diastolinis" inputmode="numeric" placeholder="pvz. 75" />
      </label>
    </div>

    <!-- 3 eilÄ— -->
    <div class="row">
      <label for="pulsas">Pulsas / min
        <input id="pulsas" name="pulsas" inputmode="numeric" placeholder="pvz. 82" />
      </label>

      <label for="temperatura">TemperatÅ«ra (Â°C)
        <input id="temperatura" name="temperatura" inputmode="decimal" placeholder="pvz. 36.6" />
      </label>
    </div>

    <!-- 4 eilÄ—: NEWS papildomi -->
    <div class="row">
      <label for="papildomas_o2">Papildomas Oâ‚‚?
        <select id="papildomas_o2" name="papildomas_o2">
          <option value="ne">Ne</option>
          <option value="taip">Taip</option>
        </select>
      </label>

      <label for="avpu">AVPU
        <select id="avpu" name="avpu">
          <option value="A">A â€“ budrus</option>
          <option value="V">V â€“ reaguoja Ä¯ balsÄ…</option>
          <option value="P">P â€“ reaguoja Ä¯ skausmÄ…</option>
          <option value="U">U â€“ reakcijos nÄ—ra</option>
        </select>
      </label>
    </div>

    <div class="hint">
      Suvedus visus rodiklius (RR, SpOâ‚‚, AKS, Å SD, T, AVPU ir ar taikomas papildomas Oâ‚‚) sistema paskaiÄiuos ankstyvojo perspÄ—jimo skalÄ—s (NEWS) balÄ….
    </div>
  </div>

  <!-- NOSIS -->
  <div class="section">
    <h2>Nosis</h2>
    <label for="nosis">Nosis
      <select id="nosis" name="nosis">
        <option value="nedaryta">Niekas nedaryta</option>
        <option value="tamponuota">Tamponuota nosis</option>
        <option value="istraukti">IÅ¡traukti tamponai</option>
      </select>
    </label>
  </div>

  <!-- MITYBA -->
  <div class="section">
    <h2>Mityba</h2>
    <label for="mityba">Mityba
      <select id="mityba" name="mityba">
        <option value="burna">Per burnÄ…</option>
        <option value="peg">Per PEG</option>
        <option value="zondas">Per zondÄ… (NG)</option>
      </select>
    </label>

    <div class="row">
      <label for="rijimas">Rijimas apsunkintas?
        <select id="rijimas" name="rijimas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>

      <label for="suvalgo">Suvartoja visÄ… maistÄ…?
        <select id="suvalgo" name="suvalgo">
          <option value="taip">Taip</option><option value="ne">Ne</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Å ALINIMAS -->
  <div class="section">
    <h2>Å alinimas</h2>

    <label for="kateteris">Å lapimo kateteris
      <select id="kateteris" name="kateteris">
        <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
      </select>
    </label>

    <div class="row">
      <label for="viduriai">ViduriÅ³ uÅ¾kietÄ—jimas?
        <select id="viduriai" name="viduriai">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>
    </div>

    <label for="viduriavimas">Viduriavimas?
      <select id="viduriavimas" name="viduriavimas">
        <option value="ne">Ne</option><option value="taip">Taip</option>
      </select>
    </label>
  </div>

  <!-- JUDÄ–JIMAS -->
  <div class="section">
    <h2>JudÄ—jimas</h2>
    <label for="mobilumas">Mobilumas
      <select id="mobilumas" name="mobilumas">
        <option value="sav">SavarankiÅ¡kas</option>
        <option value="pagalba">Su pagalba</option>
        <option value="lova">Lovos reÅ¾imas</option>
      </select>
    </label>
  </div>

  <!-- MIEGAS -->
  <div class="section">
    <h2>Miegas</h2>
    <label for="miegas">Miego kokybÄ—
      <select id="miegas" name="miegas">
        <option value="gera">Gera</option>
        <option value="sutrikusi">Sutrikusi</option>
      </select>
    </label>
  </div>

  <!-- ODA -->
  <div class="section">
    <h2>Oda</h2>

    <div class="row">
      <label for="pragulos">Pragulos
        <select id="pragulos" name="pragulos">
          <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
        </select>
      </label>

      <label for="zaizdos">Å½aizdos
        <select id="zaizdos" name="zaizdos">
          <option value="nera">NÄ—ra</option><option value="yra">Yra</option>
        </select>
      </label>
    </div>

    <div id="zaizdos_aprasymas" style="display:none;">
      <label for="zaizdos_text">Å½aizdos apraÅ¡ymas
        <textarea id="zaizdos_text" name="zaizdos_text" placeholder="Lokalizacija, dydis, sekrecija, paraudimas, skausmingumas."></textarea>
      </label>
    </div>
  </div>

  <!-- SKAUSMAS -->
  <div class="section" id="skausmas_section">
    <h2>Skausmas</h2>

    <div class="row">
      <label for="skausmas">Ar pacientas jauÄia skausmÄ…?
        <select id="skausmas" name="skausmas">
          <option value="ne">Ne</option><option value="taip">Taip</option>
        </select>
      </label>

      <label for="skausmoLygis">NRS (0â€“10)
        <input id="skausmoLygis" name="skausmoLygis" inputmode="numeric" placeholder="pvz. 5" />
      </label>
    </div>

    <button type="button" class="secondary" id="openDvprsBtn" style="margin-top:10px">
      Atidaryti DVPRS skausmo skalÄ™ (pacientui)
    </button>

    <div class="hint">DVPRS pasirinkimas automatiÅ¡kai Ä¯raÅ¡o NRS skaiÄiÅ³ Ä¯ laukÄ….</div>
  </div>

  <!-- DIETA -->
  <div class="section">
    <h2>Dieta</h2>
    <label for="dieta_kodas">Dieta (kodas)
      <select id="dieta_kodas" name="dieta_kodas">
        <option value="">â€”</option>
        <option value="P1">P1</option>
        <option value="P4">P4</option>
        <option value="PTM">PTM</option>
        <option value="TM">TM</option>
        <option value="SM">SM</option>
        <option value="CD">CD</option>
        <option value="PTM-CD">PTM-CD</option>
        <option value="Na">Na</option>
        <option value="Sk(padid.)">Sk(padid.)</option>
        <option value="Sk(maÅ¾.)">Sk(maÅ¾.)</option>
        <option value="B">B</option>
        <option value="Lac">Lac</option>
        <option value="NPB">NPB</option>
        <option value="KITA">Kitaâ€¦</option>
      </select>
    </label>

    <div id="dieta_kita_wrap" style="display:none; margin-top:10px">
      <label for="dieta_kita">Ä®raÅ¡ykite dietÄ… ranka
        <input id="dieta_kita" placeholder="pvz. be glitimo, be kiauÅ¡iniÅ³." />
      </label>
      <div class="hint">â€Kitaâ€œ â€“ plane nieko nepridÄ—sime, tik konstatuosime dietÄ… Ä¯raÅ¡e.</div>
    </div>
  </div>

  <!-- KRAUJAVIMO RIZIKA -->
  <div class="section">
    <h2>Kraujavimas</h2>
    <label for="kraujavimo_rizika">Kraujavimo rizika
      <select id="kraujavimo_rizika" name="kraujavimo_rizika">
        <option value="nera">NÄ—ra</option>
        <option value="yra">Yra</option>
      </select>
    </label>
    <div class="hint">Jei â€Yraâ€œ â€“ plane: â€StebÄ—jimas dÄ—l galimo kraujavimoâ€œ, â€AKS sekimasâ€œ.</div>
  </div>

  <!-- PIRMINIS VERTINIMAS -->
  <div class="section" style="grid-column:1 / -1">
    <details class="pv" id="pv_section">
      <summary>Pirminis vertinimas <span class="hint">(spustelÄ—kite)</span></summary>
      <div class="pv-content">
        <div class="checks" style="margin-top:6px">
          <label><input type="checkbox" id="pv_cv"> Å irdiesâ€“kraujotakos</label>
          <label><input type="checkbox" id="pv_resp"> KvÄ—pavimo</label>
          <label><input type="checkbox" id="pv_endo_cd"> EndokrininÄ—s (CD)</label>
          <label><input type="checkbox" id="pv_renal_hep"> InkstÅ³/kepenÅ³</label>
        </div>

        <label style="margin-top:10px">InfekcinÄ—s ligos (Ä¯raÅ¡ykite)
          <input id="pv_infection" placeholder="pvz. MRSA, C. difficile, TB, COVID." />
        </label>

        <label style="margin-top:10px">Alergijos
          <textarea id="pv_allergy" rows="2" placeholder="pvz. penicilinai, lateksas, maistas."></textarea>
        </label>

        <div class="hint" style="margin-top:6px">
          PaÅ¾ymÄ—tos sritys automatiÅ¡kai pridÄ—s atitinkamas intervencijas prie bendro slaugos plano.
        </div>
      </div>
    </details>
  </div>

  <!-- OUTPUT -->
  <div class="section" id="output">
    <h2>Rezultatas</h2>
    <div class="actions">
      <button class="primary" id="btnGenerate" type="button">Generuoti</button>
      <button class="secondary" id="btnReset" type="button">Naujas pacientas</button>
      <button class="primary" style="background:var(--ok)" id="btnCopy" type="button">Kelti Ä¯ sistemÄ…</button>
    </div>
    <div id="result" style="margin-top:10px"></div>
  </div>

</div>

<!-- DVPRS modal -->
<div class="modal" id="dvprsModal" aria-hidden="true">
  <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="dvprsTitle">
    <div class="modal__head">
      <div class="modal__title" id="dvprsTitle">DVPRS skausmo skalÄ—</div>
      <button type="button" class="secondary xbtn" id="dvprsCloseX" aria-label="UÅ¾daryti">âœ•</button>
    </div>

    <div class="modal__body">
      <div class="dvprsLegend">
        <div class="dvprsCard">
          <h5>Kaip naudoti</h5>
          <div class="hint">Pacientas pasirenka veidukÄ…/taÅ¡kÄ… (0â€“10). VertinimÄ… patvirtina paciento pasirinktas skaiÄius (0â€“10).</div>
        </div>
        <div class="dvprsCard">
          <h5>Pastaba</h5>
          <div class="hint">Pasirinktas DVPRS balas automatiÅ¡kai Ä¯raÅ¡omas Ä¯ NRS laukÄ… â€Skausmasâ€œ kortelÄ—je.</div>
        </div>
      </div>

      <div id="dvprsGrid" class="dvprsGrid"></div>
    </div>

    <div class="modal__footer">
      <button type="button" class="secondary" id="dvprsCancelBtn">UÅ¾daryti</button>
    </div>
  </div>
</div>

<script>

/* =========================================================
   SLAUGOS PLANAS â€” TVARKINGAI SUSKALDYTAS KODAS
   Kaip taisyti ateityje:
   - EDIT HERE #1: THRESHOLDS / ribos
   - EDIT HERE #2: slaugosPlanas / dietPlan / restraintPlan (tekstas)
   - EDIT HERE #3: detectProblems() (kada kuri problema atsiranda)
   - EDIT HERE #4: renderOutput() (kaip rodomas planas/Ä¯raÅ¡as)
========================================================= */

/* =========================================================
   0) BENDRI / HELPERS  (paprastai neliesk)
========================================================= */
const $ = (id) => document.getElementById(id);

function onReady(fn){
  if(document.readyState!=='loading') fn();
  else document.addEventListener('DOMContentLoaded', fn);
}

function toNum(v){
  const n = parseFloat(String(v ?? "").replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}

function calcMAP(sys, dia){
  if(sys==null || dia==null) return null;
  return Math.round(((2*dia)+sys)/3);
}

function valOrDash(v){ return (v==null || v==="") ? "-" : v; }

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function classifyPill(text, severity="ok"){
  const cls = severity==="bad" ? "pill bad" : severity==="warn" ? "pill warn" : "pill ok";
  return `<span class="${cls}">${escapeHtml(text)}</span>`;
}

function uniq(arr){ return [...new Set(arr)].filter(Boolean); }

function vitalsText(spo2, sys, dia, map, hr, temp, rr, onO2, avpu){
  const aks = (sys!=null && dia!=null) ? `${sys}/${dia} mmHg${map!=null ? ` (MAP ${map})` : ""}` : "-";
  const t   = (temp!=null) ? `${temp.toFixed(1)} Â°C` : "-";
  const s   = (spo2!=null) ? `${spo2} %` : "-";
  const h   = (hr!=null) ? `${hr}/min` : "-";
  const r   = (rr!=null) ? `${rr}/min` : "-";
  const o2  = (onO2===true) ? "taip" : (onO2===false) ? "ne" : "-";
  const a   = avpu ? avpu : "-";
  return `SpOâ‚‚: ${s}, RR: ${r}, Oâ‚‚: ${o2}, AKS: ${aks}, Å SD: ${h}, T: ${t}, AVPU: ${a}`;
}

/* =========================================================
   NEWS (ankstyvojo perspÄ—jimo) skaiÄiavimas
   Naudojam NEWS2 logikÄ… be "C" ir su SpOâ‚‚ Scale 1
========================================================= */

// GrÄ…Å¾ina: { score, maxSingle, complete, missing[] }
function calcNewsScore({ rr, spo2, onO2, temp, sys, hr, avpu }){
  const missing = [];
  if(rr == null)   missing.push("RR");
  if(spo2 == null) missing.push("SpOâ‚‚");
  if(temp == null) missing.push("T");
  if(sys == null)  missing.push("AKS (sistolinis)");
  if(hr == null)   missing.push("Å SD");
  if(!avpu)        missing.push("AVPU");

  const complete = missing.length === 0;

  let score = 0;
  let maxSingle = 0;
  const add = (s) => { score += s; maxSingle = Math.max(maxSingle, s); };

  // RR
  if(rr != null){
    let s=0;
    if(rr <= 8) s = 3;
    else if(rr <= 11) s = 1;
    else if(rr <= 20) s = 0;
    else if(rr <= 24) s = 2;
    else s = 3;
    add(s);
  }

  // SpO2 (Scale 1)
  if(spo2 != null){
    let s=0;
    if(spo2 <= 91) s = 3;
    else if(spo2 <= 93) s = 2;
    else if(spo2 <= 95) s = 1;
    else s = 0;
    add(s);
  }

  // Supplemental O2
  add(onO2 ? 2 : 0);

  // Temperature
  if(temp != null){
    let s=0;
    if(temp <= 35.0) s = 3;
    else if(temp <= 36.0) s = 1;
    else if(temp <= 38.0) s = 0;
    else if(temp <= 39.0) s = 1;
    else s = 2;
    add(s);
  }

  // Systolic BP
  if(sys != null){
    let s=0;
    if(sys <= 90) s = 3;
    else if(sys <= 100) s = 2;
    else if(sys <= 110) s = 1;
    else if(sys <= 219) s = 0;
    else s = 3;
    add(s);
  }

  // HR
  if(hr != null){
    let s=0;
    if(hr <= 40) s = 3;
    else if(hr <= 50) s = 1;
    else if(hr <= 90) s = 0;
    else if(hr <= 110) s = 1;
    else if(hr <= 130) s = 2;
    else s = 3;
    add(s);
  }

  // AVPU (be C)
  if(avpu){
    let s=0;
    if(avpu === 'A') s = 0;
    else if(avpu === 'V' || avpu === 'P' || avpu === 'U') s = 3;
    add(s);
  }

  return { score, maxSingle, complete, missing };
}

function newsRecommendations(score, maxSingle, complete, missing){
  if(!complete){
    return `NEWS neskaiÄiuojamas pilnai â€“ trÅ«ksta: ${missing.join(", ")}. UÅ¾pildykite visus laukus (RR, SpOâ‚‚, AKS sistolinis, Å SD, T, AVPU, papildomas Oâ‚‚).`;
  }

  if(score === 0){
    return "0 balÅ³: rutina. Kartoti gyvybinius pagal Ä¯prastÄ… skyriaus tvarkÄ….";
  }
  if(score >= 1 && score <= 4 && maxSingle < 3){
    return "1â€“4 balai: padidinta stebÄ—sena. Kartoti gyvybinius daÅ¾niau (pvz. kas 4â€“6 val.) ir Ä¯vertinti bendrÄ… bÅ«klÄ™.";
  }
  if(score >= 1 && score <= 4 && maxSingle >= 3){
    return "1â€“4 balai, bet bent vienas parametras = 3: skubus slaugytojos bÅ«klÄ—s Ä¯vertinimas ir informuoti gydytojÄ… pagal skyriaus tvarkÄ…; kartoti gyvybinius daÅ¾niau (pvz. kas 1 val.).";
  }
  if(score >= 5 && score <= 6){
    return "5â€“6 balai: vidutinÄ— rizika. Skubiai informuoti gydytojÄ…; daÅ¾na stebÄ—sena (pvz. kas 30â€“60 min.) ir svarstyti papildomÄ… monitoravimÄ… pagal bÅ«klÄ™.";
  }
  return "â‰¥7 balai: aukÅ¡ta rizika. Nedelsiant eskaluoti (skubus gydytojo Ä¯vertinimas / reanimacijos komanda pagal Ä¯staigos tvarkÄ…); nuolatinÄ— ar labai daÅ¾na stebÄ—sena.";
}
/* =========================================================
   1) CONFIG  (EDIT HERE #1)
========================================================= */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxODAbmdrmccCYCUkswsFgnz-nrC8clEQQf-5kId3y-3TCqUwsU4pyCze2Jojv43VV_1A/exec";

const THRESHOLDS = {
  spo2Warn: 95,
  spo2Critical: 90,
  tempSubfebrile: 37.1,
  tempFever: 38.0,
  tempHypothermia: 35.6,

  sysLow: 100,
  mapLow: 65,
  sysHigh: 140,
  diaHigh: 90,
  sysVeryHigh_30min: 165,

  hrTachy: 100,
  hrBrady: 50
};

/* =========================================================
   2) DATA / Å½EMÄ–LAPIAI  (EDIT HERE #2)
========================================================= */
const slaugosPlanas = {
  "KvÄ—pavimo takai su tracheostominiu vamzdÅ¾iu": [
    "Savalaikis atsiurbimas iÅ¡ tracheostominio vamzdelio",
    "Vamzdelio drÄ—kinimas",
    "Palatos oro drÄ—kinimas",
    "Sekreto (kiekio/spalvos/klampumo) vertinimas ir dokumentavimas",
    "Stomos prieÅ¾iÅ«ra â€“ tvarsÄio keitimas bent 2 kartus per parÄ…",
    "Tracheostominio vamzdelio fiksacijos patikra"
  ],
  "Nedidelis kraujavimas iÅ¡ nosies": [
    "AKS stebÄ—jimas kraujavimui nestojant",
    "Pacientas apmokintas kaip priÅ¾iÅ«rÄ—ti nosÄ¯ kraujavimui sustojus"
  ],

 "Tamponuota nosis": [
  "Nosies tvarÅ¡Äio keitimas"
],

  "Sutrikusi kvÄ—pavimo funkcija (dusulys)": [
    "SpOâ‚‚ stebÄ—jimas",
    "Prireikus Oâ‚‚ skyrimas pagal SpOâ‚‚"
  ],
  "Neefektyvi dujÅ³ apykaita": [
    "SpOâ‚‚ stebÄ—jimas",
    "Oâ‚‚ skyrimas ir reguliavimas pagal SpOâ‚‚ duomenis"
  ],
  "PaÅ¾emÄ—jÄ™s kraujo spaudimas": [
    "Patarta neskubÄ—ti keltis, pasÄ—dÄ—ti nuleidus kojas prieÅ¡ einant",
    "StebÄ—jimas dÄ—l galimÅ³ griuvimÅ³",
    "AKS matavimas po 1 val."
  ],
  "PadidÄ—jÄ™s kraujo spaudimas": [
    "AKS sekimas kas 4 val."
  ],
  "Sutrikusi mityba per burnÄ…": [
    "StebÄ—jimas dÄ—l aspiracijos",
    "Pagalba valgant",
    "Reikalui esant maisto tirÅ¡tinimas"
  ],
  "Mityba per zondÄ… (NG)": [
    "Zondo padÄ—ties patikra pagal Ä¯staigos protokolÄ…",
    "GalvÅ«galis â‰¥30â€“45Â° maitinimo metu ir 30â€“60 min po",
    "Zondo praplovimas prieÅ¡ ir po maitinimo bei vaistÅ³",
    "Nosies ir odos prie zondo prieÅ¾iÅ«ra, fiksacijos patikra",
    "StebÄ—ti dÄ—l aspiracijos, pykinimo, pilvo pÅ«timo"
  ],
  "Mityba per PEG": [
    "PEG prieÅ¾iÅ«ra pagal Ä¯staigos protokolÄ…",
    "GalvÅ«galis â‰¥30â€“45Â° maitinimo metu ir 30â€“60 min po",
    "PEG praplovimas prieÅ¡ ir po maitinimo bei vaistÅ³",
    "StebÄ—ti dÄ—l aspiracijos, pykinimo, pilvo pÅ«timo"
  ],
  "Rizika praguloms dÄ—l lovos reÅ¾imo": [
    "Odos bÅ«klÄ—s stebÄ—jimas",
    "Pozicionavimas pagal bÅ«klÄ™",
    "PragulÅ³ profilaktika"
  ],
  "Rizika griuvimui dÄ—l pagalbos poreikio": [
    "StebÄ—jimas dÄ—l galimÅ³ griuvimÅ³",
    "Pagalba judant"
  ],
  "Pragulos": [
    "Odos bÅ«klÄ—s stebÄ—jimas",
    "Pozicionavimas pagal bÅ«klÄ™ kas 2 - 3 valandas",
    "PagalbinÄ—s priemonÄ—s pozicionavimui",
    "Pragulos perriÅ¡imas pagal Å¾aizdÅ³ prieÅ¾iÅ«ros planÄ…"
  ],
  "Odos vientisumo paÅ¾eidimas (Å¾aizda)": [
    "Å½aizdos perriÅ¡imas",
    "StebÄ—ti infekcijos poÅ¾ymius"
  ],
  "Nedidelis skausmas (1â€“3/10)": [
    "Nefarmakologinis skausmo malÅ¡inimas",
    "Pacientui norint â€“ farmakologinis nuskausminimas"
  ],
  "Vidutinis skausmas (4â€“6/10)": [
    "Savalaikis nuskausminimas pagal gydytojo paskyrimÄ…",
    "Pakartotinis skausmo matavimas po 30 min. po vaistÅ³ suleidimo/sudavimo"
  ],
  "Didelis skausmas (7â€“10/10)": [
    "Skubus nuskausminimas pagal gydytojo paskyrimÄ…",
    "Pakartotinis skausmo matavimas po 15 min."
  ],
  "Å lapimo kateteris": [
    "Kateterio prieÅ¾iÅ«ra pagal Ä¯staigos protokolÄ…",
    "StebÄ—ti diurezÄ™ ir Å¡lapimo pobÅ«dÄ¯",
    "StebÄ—ti infekcijos poÅ¾ymius"
  ],
  "ViduriÅ³ uÅ¾kietÄ—jimas": [
    "StebÄ—ti tuÅ¡tinimÄ…si",
    "SkysÄiÅ³/aktyvumo skatinimas pagal bÅ«klÄ™",
    "PriemoniÅ³ taikymas pagal paskyrimÄ…"
  ],
  "Viduriavimas": [
    "StebÄ—ti tuÅ¡tinimÄ…si",
    "Odos prieÅ¾iÅ«ra tarpvietÄ—je",
    "SkysÄiÅ³ balanso stebÄ—jimas"
  ],
"Gulimas reÅ¾imas ir pragulos": [
  "Odos bÅ«klÄ—s stebÄ—jimas",
  "Pozicionavimas pagal bÅ«klÄ™ kas 2â€“3 valandas",
  "PagalbinÄ—s priemonÄ—s paciento pozicionavimui",
  "Pragulos perriÅ¡imas pagal Å¾aizdÅ³ prieÅ¾iÅ«ros planÄ…",
  "NaujÅ³ pragulÅ³ atsiradimo profilaktika"
],
 
  "SutrikÄ™s miegas": [
    "Miego ir poilsio reÅ¾imo vertinimas",
    "Aplinkos veiksniÅ³ korekcija (triukÅ¡mas, Å¡viesa, temperatÅ«ra)",
    "Skausmo vertinimas prieÅ¡ miegÄ…",
    "NefarmakologiniÅ³ miego gerinimo priemoniÅ³ taikymas",
    "Paciento savijautos stebÄ—jimas ryte"
  ],
  "PadidÄ—jusi temperatÅ«ra": ["TemperatÅ«ros stebÄ—jimas"],
  "Hipotermija": ["Å ilumos palaikymas","TemperatÅ«ros stebÄ—jimas"],
  "Kraujavimo rizika": ["StebÄ—jimas dÄ—l galimo kraujavimo","AKS sekimas"]
};

const dietPlan = {
  "P1": [],
  "P4": [],
  "PTM":   ["Stebima, kaip pacientui pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos."],
  "TM":    ["Stebima, kaip pacientui pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos."],
  "SM":    ["Pacientas maitinamas maÅ¾ais boliusais, lÄ—tai; stebima dÄ—l aspiracijos rizikos."],
  "CD":    ["Sekama glikemija."],
  "PTM-CD":["Stebima, kaip pacientui pavyksta nuryti maistÄ…, bei dÄ—l aspiracijos rizikos; sekama glikemija."],
  "Na":    ["Stebima dÄ—l edemÅ³, pastebÄ—jus â€“ AKS ir skysÄiÅ³ sekimas."],
  "Sk(padid.)": ["Stebima dÄ—l pilvo pÅ«timo ir tuÅ¡tinimosi."],
  "Sk(maÅ¾.)":   ["Stebima dÄ—l pilvo pÅ«timo ir tuÅ¡tinimosi."],
  "B": [],
  "Lac": [],
  "NPB": ["Pacientas nieko nevalgo ir negeria, kol kitaip nenurodÄ— gydytojas."]
};

const restraintPlan = [
  "Taikoma fizinio suvarÅ¾ymo priemonÄ—s, imobilizuota galÅ«nÄ— atlaisvinama kas 1,5 val.",
  "Stebima oda po fiksavimo priemone, Ä¯vertinami spaudimo/paraudimo poÅ¾ymiai",
  "Stebima periferinÄ— kraujotaka (spalva, temperatÅ«ra, jutimai)",
  "Stebima paciento emocinÄ— bÅ«klÄ— ir stengiamasi sumaÅ¾inti nerimÄ…",
  "SuvarÅ¾ymo taikymas dokumentuojamas"
];

const dvprs = [
  {n:0, emoji:"ğŸ˜€", color:"#16a34a", text:"NERA SKAUSMO"},
  {n:1, emoji:"ğŸ™‚", color:"#22c55e", text:"NEPASTEUS, GALIU IGNORUOTI"},
  {n:2, emoji:"ğŸ™‚", color:"#4ade80", text:"LABAI NEDIDELIS"},
  {n:3, emoji:"ğŸ™‚", color:"#86efac", text:"NEDIDELIS, TRIKDO, BET GALIU"},
  {n:4, emoji:"ğŸ˜", color:"#facc15", text:"VIDUTINIS, SUNKIAU SUSIKONCENTRUOTI"},
  {n:5, emoji:"ğŸ˜", color:"#fbbf24", text:"VIDUTINIS, TRIKDO KASDIENÄ˜ VEIKLÄ„"},
  {n:6, emoji:"ğŸ˜", color:"#f59e0b", text:"STIPRUS, SUNKU FUNKCIONUOTI"},
  {n:7, emoji:"ğŸ˜£", color:"#fb7185", text:"LABAI STIPRUS, NEGALIU MIEGOTI"},
  {n:8, emoji:"ğŸ˜£", color:"#f43f5e", text:"NEPAKELIAMAS, SUNKIAI IÅ TVERIU"},
  {n:9, emoji:"ğŸ˜­", color:"#ef4444", text:"BEVEIK NEIÅ KENÄŒIAMAS"},
  {n:10, emoji:"ğŸ˜­", color:"#b91c1c", text:"NIEKAS DAUGIAU NERÅªPI"}
];

/* =========================================================
   3) DVPRS MODAL (paprastai neliesk)
========================================================= */
function openDvprs(){
  $('dvprsModal')?.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}
function closeDvprs(){
  $('dvprsModal')?.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
}
function setPainFromDvprs(n){
  $('skausmas').value='taip';
  $('skausmoLygis').value=String(n);
  $('skausmoLygis').toggleAttribute('required', true);
  closeDvprs();
  $('skausmas_section')?.scrollIntoView({behavior:'smooth', block:'start'});
}
function renderDvprs(){
  const grid=$('dvprsGrid');
  if(!grid) return;
  grid.innerHTML = dvprs.map(item => `
    <button type="button" class="dvprsCard" style="--dvprsColor:${item.color}" onclick="setPainFromDvprs(${item.n})">
      <div class="dvprsBar"></div>
      <div class="dvprsTop">
        <div class="dvprsLeft">
          <div class="dvprsEmoji" aria-hidden="true">${item.emoji}</div>
          <div class="dvprsNum">${item.n}</div>
        </div>
        <div class="dvprsTag">${item.n}/10</div>
      </div>
      <div class="dvprsText">${escapeHtml(item.text)}</div>
    </button>
  `).join("");
}

/* =========================================================
   4) INIT / EVENTAI (paprastai neliesk)
========================================================= */
onReady(() => {
  $('zaizdos')?.addEventListener('change', e => {
    $('zaizdos_aprasymas').style.display = e.target.value === 'yra' ? 'block' : 'none';
  });
  $('skausmas')?.addEventListener('change', e => {
    $('skausmoLygis')?.toggleAttribute('required', e.target.value === 'taip');
  });
  $('resetBtn')?.addEventListener('click', resetForm);
  $('dieta_kodas')?.addEventListener('change', () => {
    $('dieta_kita_wrap').style.display = ($('dieta_kodas').value === 'KITA') ? 'block' : 'none';
  });

  renderDvprs();
  $('openDvprsBtn')?.addEventListener('click', openDvprs);
  $('dvprsCloseBtn')?.addEventListener('click', closeDvprs);
  $('dvprsCancelBtn')?.addEventListener('click', closeDvprs);
  $('dvprsCloseBackdrop')?.addEventListener('click', closeDvprs);

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && $('dvprsModal')?.getAttribute('aria-hidden') === 'false') closeDvprs();
  });
});

/* =========================================================
   5) TAISYKLÄ–S / PROBLEMÅ² ATPAÅ½INIMAS  (EDIT HERE #3)
   - integruota NEWS: RR, papildomas Oâ‚‚, AVPU
   - papildomas Oâ‚‚ â†’ automatiÅ¡kai "Neefektyvi dujÅ³ apykaita"
========================================================= */
function detectProblems(f){
  const esamos = [];
  const galimos = [];
  const pills  = [];

  // --- Gyvybiniai + NEWS laukÅ³ nuskaitymas (saugiai)
  const spo2 = toNum(f['saturacija']?.value);
  const rr   = toNum(f['kvepavimo_daznis']?.value);
  const temp = toNum(f['temperatura']?.value);
  const sys  = toNum(f['sistolinis']?.value);
  const dia  = toNum(f['diastolinis']?.value);
  const hr   = toNum(f['pulsas']?.value);
  const map  = calcMAP(sys, dia);

  const onO2 = (f['papildomas_o2']?.value === 'taip');
  const avpu = (f['avpu']?.value || 'A');

  // >165 â€“ 30 min. AKS sekimas
  const highSys30 = (sys!=null && sys > THRESHOLDS.sysVeryHigh_30min);

  // --- RR pill (nebÅ«tina, bet naudinga)
  if(rr!=null){
    pills.push(classifyPill(`RR ${rr}/min`, (rr>=25 || rr<=8) ? "warn" : "ok"));
  }

  // --- Papildomas O2
  pills.push(classifyPill(`Papildomas Oâ‚‚: ${onO2 ? "taip" : "ne"}`, onO2 ? "warn" : "ok"));

  // --- AVPU
  pills.push(classifyPill(`AVPU: ${avpu}`, (avpu==='A') ? "ok" : "warn"));

  // --- SpO2
  if(spo2!=null){
    if(spo2 < THRESHOLDS.spo2Critical) {
      esamos.push("Neefektyvi dujÅ³ apykaita");
      pills.push(classifyPill(`SpOâ‚‚ ${spo2}% (kritiÅ¡kai Å¾ema)`, "bad"));
    } else if(spo2 < THRESHOLDS.spo2Warn) {
      esamos.push("Neefektyvi dujÅ³ apykaita");
      pills.push(classifyPill(`SpOâ‚‚ ${spo2}% (Å¾ema)`, "warn"));
    } else {
      pills.push(classifyPill(`SpOâ‚‚ ${spo2}%`, "ok"));
    }
  }

  // âœ… Jei taikomas papildomas O2 â€“ traukiam planÄ… kaip prie dujÅ³ apykaitos (net jei SpO2 normali)
  if(onO2){
    esamos.push("Neefektyvi dujÅ³ apykaita");
  }

  // --- TemperatÅ«ra
  if(temp!=null){
    if(temp >= THRESHOLDS.tempFever){
      esamos.push("PadidÄ—jusi temperatÅ«ra");
      pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (karÅ¡Äiavimas)`, "warn"));
    } else if(temp >= THRESHOLDS.tempSubfebrile){
      esamos.push("PadidÄ—jusi temperatÅ«ra");
      pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (subfebrilus)`, "warn"));
    } else if(temp < THRESHOLDS.tempHypothermia){
      esamos.push("Hipotermija");
      pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C (Å¾ema)`, "warn"));
    } else {
      pills.push(classifyPill(`T ${temp.toFixed(1)}Â°C`, "ok"));
    }
  }

  // --- Tracheostoma / sekretas / siurbimas
  if(
    f['trach']?.value==='taip' ||
    f['sekretas_trach']?.value==='taip' ||
    f['siurbimas']?.value==='taip'
  ){
    esamos.push("KvÄ—pavimo takai su tracheostominiu vamzdÅ¾iu");
  }

  // --- Nosis / dusulys
  if (f['nosis']?.value === 'tamponuota') {
    esamos.push("Tamponuota nosis");
    galimos.push("Miego sutrikimai");
  } else if (f['nosis']?.value === 'istraukti') {
    esamos.push("Nedidelis kraujavimas iÅ¡ nosies");
  }
  if(f['dusulys']?.value==='taip') esamos.push("Sutrikusi kvÄ—pavimo funkcija (dusulys)");

  // --- AKS
  if(sys!=null && dia!=null){
    if(sys < THRESHOLDS.sysLow || (map!=null && map < THRESHOLDS.mapLow)) esamos.push("PaÅ¾emÄ—jÄ™s kraujo spaudimas");
    if(sys >= THRESHOLDS.sysHigh || dia >= THRESHOLDS.diaHigh) esamos.push("PadidÄ—jÄ™s kraujo spaudimas");
  }

  // --- pills santrauka apie AKS/MAP
  if(map!=null) pills.push(classifyPill(`MAP ${map} mmHg`, (map < THRESHOLDS.mapLow) ? "bad" : (map < (THRESHOLDS.mapLow+10)) ? "warn" : "ok"));
  if(sys!=null && dia!=null) pills.push(classifyPill(`AKS ${sys}/${dia} mmHg`, (sys>=THRESHOLDS.sysHigh || dia>=THRESHOLDS.diaHigh) ? "warn" : (sys<THRESHOLDS.sysLow) ? "warn" : "ok"));
  if(highSys30) pills.push(classifyPill(`SYS ${sys} mmHg (>165) â€“ kas 30 min.`, "warn"));

  // --- Pulsas
  if(hr!=null){
    if(hr > THRESHOLDS.hrTachy) pills.push(classifyPill(`Pulsas ${hr}/min (tachikardija)`, "warn"));
    else if(hr < THRESHOLDS.hrBrady) pills.push(classifyPill(`Pulsas ${hr}/min (bradikardija)`, "warn"));
    else pills.push(classifyPill(`Pulsas ${hr}/min`, "ok"));
  }

  // --- Mityba
  const m = f['mityba']?.value;
  if(m==='peg') esamos.push("Mityba per PEG");
  else if(m==='zondas') esamos.push("Mityba per zondÄ… (NG)");
  else if(m==='burna'){
    if(f['rijimas']?.value==='taip' || f['suvalgo']?.value!=='taip') esamos.push("Sutrikusi mityba per burnÄ…");
  }

  // --- Å alinimas
  if(f['kateteris']?.value==='yra') esamos.push("Å lapimo kateteris");
  if(f['viduriai']?.value==='taip') esamos.push("ViduriÅ³ uÅ¾kietÄ—jimas");
  if(f['viduriavimas']?.value==='taip') esamos.push("Viduriavimas");

  // --- Miegas (tavo taisyklÄ—)
  if (f['miegas'] && f['miegas'].value === 'sutrikusi') {
    esamos.push("SutrikÄ™s miegas");
  }

  // --- JudÄ—jimas + pragulos (esamos problemos atskirai)
  const bedRest = (f['mobilumas']?.value === 'lova');
  const hasPressureUlcer = (f['pragulos']?.value === 'yra');

  if (bedRest) {
    esamos.push("Gulimas reÅ¾imas");
    if (!hasPressureUlcer) {
      galimos.push("Rizika praguloms dÄ—l lovos reÅ¾imo");
    }
  }
  if (hasPressureUlcer) {
    esamos.push("Pragulos");
  }

  // --- Oda / Å¾aizdos
  if(f['zaizdos']?.value==='yra'){
    const apr=(f['zaizdos_text']?.value||'').trim();
    esamos.push("Odos vientisumo paÅ¾eidimas (Å¾aizda)"+(apr?(" â€“ "+apr):""));
  }

  // --- Skausmas (klinikinis formatas + techninis raktas planui)
  if(f['skausmas']?.value==='taip'){
    const val = toNum(f['skausmoLygis']?.value);

    if(val==null || val<0 || val>10){
      alert("Ä®veskite skausmo intensyvumÄ… (0â€“10).");
      $('skausmoLygis')?.focus();
      return { error:true };
    }

    let painRangeKey = "";
    let painText = "";

    if(val>=1 && val<=3){ painRangeKey="Nedidelis skausmas (1â€“3/10)"; painText="nedidelis skausmas"; }
    else if(val>=4 && val<=6){ painRangeKey="Vidutinis skausmas (4â€“6/10)"; painText="vidutinis skausmas"; }
    else if(val>=7 && val<=10){ painRangeKey="Didelis skausmas (7â€“10/10)"; painText="didelis skausmas"; }
    else { painRangeKey="Skausmas (0/10)"; painText="skausmo nÄ—ra"; }

    // 1) kÄ… mato slaugytoja
    esamos.push(`${val}/10 (${painText})`);
    // 2) kad planas prisikabintÅ³
    if(val>0) esamos.push(painRangeKey);

    const sev = val>=7 ? "bad" : val>=4 ? "warn" : "ok";
    pills.push(classifyPill(`Skausmas ${val}/10`, sev));
  }

  // --- Kraujavimo rizika
  if(f['kraujavimo_rizika']?.value==='yra') galimos.push("Kraujavimo rizika");

  // --- NEWS skaiÄiavimas + tekstas rekomendacijoms
  const news = calcNewsScore({ rr, spo2, onO2, temp, sys, hr, avpu });
  const newsText = newsRecommendations(news.score, news.maxSingle, news.complete, news.missing);

  // (nebÅ«tina, bet graÅ¾u santraukoje)
  if(news.complete){
    const sev = news.score >= 7 ? "bad" : news.score >= 5 ? "warn" : (news.score >= 1 ? "warn" : "ok");
    pills.push(classifyPill(`NEWS ${news.score}`, sev));
  } else {
    pills.push(classifyPill(`NEWS â€” (trÅ«ksta duomenÅ³)`, "warn"));
  }

  return {
    error:false,
    esamos,
    galimos,
    pills,
    vitals:{spo2,temp,sys,dia,hr,map,rr,onO2,avpu},
    highSys30,
    news,
    newsText
  };
}

/* =========================================================
   6) OUTPUT / Ä®RAÅ AS / HTML  (EDIT HERE #4)
   - NEWS rodomas viename "GyvybiniÅ³ rodikliÅ³" lange
   - Kombinuotas planas "Gulimas reÅ¾imas ir pragulos" (be dubliavimo)
========================================================= */
let lastPayload = null;

function renderOutput(f, ctx){
  const { esamos, galimos, pills, vitals, highSys30, news, newsText } = ctx;

  const {
    rr, spo2, temp, sys, dia, hr, map, onO2, avpu
  } = vitals;

  const esamosU = uniq(esamos).sort();
  const galimosU = uniq(galimos).sort();

  // âœ… Flag: kai lovos reÅ¾imas + pragulos â†’ plane rodome tik kombinuotÄ… planÄ…
  const combineBedRestAndUlcers =
    (f['mobilumas']?.value === 'lova' && f['pragulos']?.value === 'yra');

  const pb_ramus  = $('ramus')?.checked;
  const pb_orient = $('orientuotas')?.checked;
  const psichoTekstas = `${pb_ramus ? 'ramus' : 'neramus'}, ${pb_orient ? 'orientuotas' : 'neorientuotas'}`;

  const isRestrained = $('suvarzymas')?.checked === true;
  const nowTime = new Date().toLocaleTimeString('lt-LT', {hour:'2-digit', minute:'2-digit'});
  const restraintSentence = isRestrained
    ? `DÄ—l galimos Å¾alos sau paÄiam ir aplinkiniams, neveikiant kitoms priemonÄ—ms pacientas fiksuotas (${nowTime}).`
    : "";

  // Pirminis vertinimas -> papildomos intervencijos
  const pvPlanSets={
    cv:["AKS sekimas","SkysÄiÅ³ balanso stebÄ—jimas","EdemÅ³ stebÄ—jimas","Dusulio stebÄ—jimas","Mitybos/dietos pritaikymas"],
    resp:["SpOâ‚‚ stebÄ—jimas"],
    endo:["Glikemijos kontrolÄ—","Mitybos/dietos pritaikymas"],
    rh:["SkysÄiÅ³ balanso stebÄ—jimas","SkysÄiÅ³ kiekio sekimas","AKS sekimas"]
  };
  const pvSelected=[], pvExtraItems=[];
  if($('pv_cv')?.checked){ pvSelected.push("Å irdiesâ€“kraujotakos"); pvExtraItems.push(...pvPlanSets.cv); }
  if($('pv_resp')?.checked){ pvSelected.push("KvÄ—pavimo"); pvExtraItems.push(...pvPlanSets.resp); }
  if($('pv_endo_cd')?.checked){ pvSelected.push("EndokrininÄ—s (CD)"); pvExtraItems.push(...pvPlanSets.endo); }
  if($('pv_renal_hep')?.checked){ pvSelected.push("InkstÅ³/kepenÅ³"); pvExtraItems.push(...pvPlanSets.rh); }
  const pvInfection=($('pv_infection')?.value||'').trim();
  const pvAllergy=($('pv_allergy')?.value||'').trim();
  const pvSummaryParts=[];
  if(pvSelected.length) pvSummaryParts.push("Sritys: "+pvSelected.join(", "));
  if(pvInfection) pvSummaryParts.push("InfekcinÄ—s ligos: "+pvInfection);
  if(pvAllergy) pvSummaryParts.push("Alergijos: "+pvAllergy);
  const pvSummaryText=pvSummaryParts.join(" | ");

  // Dieta
  const dietCode=($('dieta_kodas')?.value||'').trim();
  const dietCustom=(dietCode==='KITA')?(($('dieta_kita')?.value||'').trim()):'';
  const hasDiet=(dietCode && dietCode!=='KITA') || (dietCode==='KITA' && dietCustom);

  // HTML rezultatai
  let html="";

  if(pills.length){
    html += `<div class="hint"><strong>Greita santrauka:</strong> ${pills.join(" ")}</div>`;
  }

  html += `<h3>Esamos problemos</h3><ul>${
    esamosU.length ? esamosU.map(p=>`<li>${escapeHtml(p)}</li>`).join("") : "<li>NepastebÄ—ta</li>"
  }</ul>`;

  html += `<h3>Galimos problemos</h3><ul>${
    galimosU.length ? galimosU.map(p=>`<li>${escapeHtml(p)}</li>`).join("") : "<li>NepastebÄ—ta</li>"
  }</ul>`;

  html += `<h3>Slaugos planas</h3>`;

  // âœ… 1) Jei reikia â€“ kombinuotas planas pirmas
  if (combineBedRestAndUlcers) {
    const key = "Gulimas reÅ¾imas ir pragulos";
    const items = slaugosPlanas[key] || [];
    if(items.length){
      html += `<div class="planas"><h4>${escapeHtml(key)}</h4><ul>${
        items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
      }</ul></div>`;
    }
  }

  // âœ… 2) LikÄ™ planai, praleidÅ¾iant dubliuojanÄius
  [...esamosU, ...galimosU].forEach(p => {
    if (combineBedRestAndUlcers) {
      if (p === "Pragulos") return;
      if (p === "Rizika praguloms dÄ—l lovos reÅ¾imo") return;
      // "Gulimas reÅ¾imas" â€“ atskiro plano nerodom (nebent vÄ—liau Ä¯dÄ—si Ä¯ slaugosPlanas)
    }

    const key = Object.keys(slaugosPlanas).find(k => p.startsWith(k));
    if(!key) return;

    const items = [...(slaugosPlanas[key] || [])];

    // tavo taisyklÄ—: SYS >165 â†’ papildomas punktas
    if(p.startsWith("PadidÄ—jÄ™s kraujo spaudimas") && highSys30){
      items.push("AKS sekimas kas 30 min.");
    }

    html += `<div class="planas"><h4>${escapeHtml(p)}</h4><ul>${
      items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  });

  // Dietos planas
  const dietItems = (dietCode && dietCode!=='KITA') ? (dietPlan[dietCode]||[]) : [];
  if(dietItems.length){
    html += `<div class="planas"><h4>Dieta: ${escapeHtml(dietCode)}</h4><ul>${
      dietItems.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  }

  // SuvarÅ¾ymas
  if(isRestrained){
    html += `<div class="planas"><h4>Fizinis suvarÅ¾ymas</h4><ul>${
      restraintPlan.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  }

  // Pirminio vertinimo papildomos intervencijos
  if(pvExtraItems.length){
    const extra = uniq(pvExtraItems);
    html += `<div class="planas"><h4>Pirminis vertinimas: papildomos intervencijos</h4><ul>${
      extra.map(i=>`<li>${escapeHtml(i)}</li>`).join("")
    }</ul></div>`;
  }

  /* =========================
     GYVYBINIAI RODIKLIAI â€“ VIENAS LANGAS + NEWS
  ========================= */
  const aksStr = (sys!=null && dia!=null)
    ? `${sys} / ${dia} mmHg${map!=null ? ` (MAP ${map})` : ''}`
    : '-';

  const rrStr   = (rr!=null) ? `${rr} / min` : '-';
  const o2Str   = onO2 ? 'Taip' : 'Ne';
  const avpuStr = avpu === 'A' ? 'A â€“ budrus'
               : avpu === 'V' ? 'V â€“ reaguoja Ä¯ balsÄ…'
               : avpu === 'P' ? 'P â€“ reaguoja Ä¯ skausmÄ…'
               : avpu === 'U' ? 'U â€“ reakcijos nÄ—ra'
               : '-';

  const newsScoreStr = (news?.complete) ? String(news.score) : 'â€”';

  html += `<h3>Ä®vesti gyvybiniai rodikliai</h3>
  <p>
    <strong>SpOâ‚‚:</strong> ${valOrDash(spo2)} %<br>
    <strong>RR:</strong> ${rrStr}<br>
    <strong>Papildomas Oâ‚‚:</strong> ${o2Str}<br>
    <strong>AKS:</strong> ${aksStr}<br>
    <strong>Å SD:</strong> ${valOrDash(hr)} / min<br>
    <strong>TemperatÅ«ra:</strong> ${temp!=null ? temp.toFixed(1) : "-"} Â°C<br>
    <strong>AVPU:</strong> ${escapeHtml(avpuStr)}<br>
    <strong>Ankstyvojo perspÄ—jimo skalÄ—s (NEWS) balas:</strong> ${newsScoreStr}
  </p>
  <div class="hint">
    Suvedus visus rodiklius sistema paskaiÄiuoja ankstyvojo perspÄ—jimo skalÄ—s (NEWS) balÄ….
  </div>
  <div class="planas">
    <h4>Rekomendacijos slaugytojai</h4>
    <ul><li>${escapeHtml(newsText || "â€”")}</li></ul>
  </div>
  <p><strong>Pacientas:</strong> ${escapeHtml(psichoTekstas)}</p>`;

  if (restraintSentence) html += `<p>${escapeHtml(restraintSentence)}</p>`;
  if(hasDiet){
    const dietaUi=(dietCode==='KITA') ? dietCustom : dietCode;
    html += `<p><strong>Pacientui skirta:</strong> ${escapeHtml(dietaUi)} dieta</p>`;
  }
  html += `<p><strong>Pirminis vertinimas:</strong> ${escapeHtml(pvSummaryText || "â€”")}</p>`;

  $('results').innerHTML = html;

  /* =========================
     Bendras planas + Ä¯raÅ¡as (LIS) â€” be dubliavimo
  ========================= */
  const seenPlan=new Set();
  const planItems=[];

  // kombinuotas planas â€“ Ä¯ planItems Ä¯dedam tik jÄ¯ (jei reikia)
  if (combineBedRestAndUlcers) {
    const key = "Gulimas reÅ¾imas ir pragulos";
    (slaugosPlanas[key] || []).forEach(it => {
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    });
  }

  [...esamosU, ...galimosU].forEach(p => {
    if (combineBedRestAndUlcers) {
      if (p === "Pragulos") return;
      if (p === "Rizika praguloms dÄ—l lovos reÅ¾imo") return;
    }

    const key = Object.keys(slaugosPlanas).find(k => p.startsWith(k));
    if(!key) return;

    (slaugosPlanas[key]||[]).forEach(it => {
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    });

    if(p.startsWith("PadidÄ—jÄ™s kraujo spaudimas") && highSys30){
      const it="AKS sekimas kas 30 min.";
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    }
  });

  if(dietCode && dietCode!=='KITA'){
    (dietPlan[dietCode]||[]).forEach(it=>{
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    });
  }

  if(isRestrained){
    restraintPlan.forEach(it=>{
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    });
  }

  if(pvExtraItems.length){
    uniq(pvExtraItems).forEach(it=>{
      if(!seenPlan.has(it)){ seenPlan.add(it); planItems.push(it); }
    });
  }

  const planasText = planItems.length ? planItems.map(i=>"â€¢ "+i).join("\n") : "-";

  const gyvybiniai = vitalsText(spo2, sys, dia, map, hr, temp, rr, onO2, avpu);
  const slaugosProb = esamosU.length ? esamosU.join('; ') : '-';
  const galimosProb = galimosU.length ? galimosU.join('; ') : '-';

  let irasas =
    `Gyvybiniai rodikliai:\n${gyvybiniai}\n`+
    `NEWS: ${news?.complete ? news.score : "â€”"}\n`+
    `Rekomendacija: ${newsText || "â€”"}\n\n`+
    `Pacientas: ${psichoTekstas}\n`;

  if (restraintSentence) irasas += `${restraintSentence}\n`;
  irasas += `\n`;

  if(hasDiet){
    const dietaNote=(dietCode==='KITA') ? dietCustom : dietCode;
    irasas += `Pacientui skirta: ${dietaNote} dieta\n\n`;
  }

  irasas +=
    `Pirminis vertinimas:\n${pvSummaryText || "â€”"}\n\n`+
    `Slaugos problemos:\n${slaugosProb}\n\n`+
    `Galimos problemos:\n${galimosProb}\n\n`+
    `Slaugos planas:\n${planasText}`;

  lastPayload={
    "Laikas": new Date().toLocaleString('lt-LT'),
    "palata": (f['palata']?.value||"").trim(),
    "lova":   (f['lova']?.value||"").trim(),
    "Ä¯raÅ¡as": irasas
  };

  $('results').insertAdjacentHTML(
    'beforeend',
    `<div class="mono">${escapeHtml(JSON.stringify(lastPayload,null,2))}</div>`
  );
}


/* =========================================================
   7) MAIN: GENERUOTI
========================================================= */
function generateResults(){
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';

  const f=document.forms['nursingForm'];

  const ctx = detectProblems(f);
  if(ctx.error) return;

  renderOutput(f, ctx);
}

/* =========================================================
   8) SIUNTIMAS / RESET  (paprastai neliesk)
========================================================= */
function keltiISistema(){
  if(!lastPayload){ alert("Pirmiausia paspauskite â€Generuotiâ€œ."); return; }
  const url=(GOOGLE_SCRIPT_URL||'').trim();
  if(!url || !url.endsWith('/exec')){ alert("Patikrinkite WebApp URL â€“ turi baigtis /exec."); return; }

  fetch(url, {
    method:"POST",
    headers:{"Content-Type":"text/plain"},
    body:JSON.stringify(lastPayload),
    mode:"no-cors"
  })
  .then(() => {
    $('statusErr').style.display='none';
    $('statusOk').style.display='block';
  })
  .catch(() => {
    $('statusOk').style.display='none';
    $('statusErr').style.display='block';
  });
}

function resetForm(){
  $('nursingForm').reset();
  $('results').innerHTML="";
  $('statusOk').style.display='none';
  $('statusErr').style.display='none';
  $('zaizdos_aprasymas').style.display='none';
  $('dieta_kita_wrap').style.display='none';
  closeDvprs();
  lastPayload=null;
}
</script>

</body>
</html>










